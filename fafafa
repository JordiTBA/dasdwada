-- main.lua (versi fast-load)z
----------------------------------------------------------------
-- MINI LOADER (Battery Charging) - NodeHub (Black/Neon Yellow)
-- taruh di paling atas main.lua
----------------------------------------------------------------
local G = (getgenv and getgenv()) or _G
if G.__NODEHUB_MAIN_RUNNING then
    --warn("[NodeHub] main.lua BLOCKED (already running)")
    return
end
G.__NODEHUB_MAIN_RUNNING = true

local Players      = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService   = game:GetService("RunService")
local CoreGui      = game:GetService("CoreGui")

local LP = Players.LocalPlayer

local function _protect(gui)
    -- beberapa executor perlu protectgui
    pcall(function()
        if syn and syn.protect_gui then syn.protect_gui(gui) end
    end)
end

local function CreateMiniLoader(total)
    total = tonumber(total) or 1

    local gui = Instance.new("ScreenGui")
    gui.Name = "NodeHubMiniLoader"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    _protect(gui)
    pcall(function() gui.Parent = CoreGui end)
    if not gui.Parent then
        local pg = LP:FindFirstChildOfClass("PlayerGui") or LP:WaitForChild("PlayerGui")
        gui.Parent = pg
    end

    local root = Instance.new("Frame")
    root.Name = "Root"
    root.AnchorPoint = Vector2.new(0.5, 0.5)
    root.Position = UDim2.fromScale(0.5, 0.5)
    root.Size = UDim2.fromOffset(360, 120)
    root.BackgroundColor3 = Color3.fromRGB(0, 0, 0) -- ✅ hitam pekat
    root.BackgroundTransparency = 0
    root.BorderSizePixel = 0
    root.Parent = gui

    local rc = Instance.new("UICorner")
    rc.CornerRadius = UDim.new(0, 14)
    rc.Parent = root

    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 2
    stroke.Transparency = 0.10
    stroke.Color = Color3.fromRGB(255, 217, 0)
    stroke.Parent = root

-- ✅ Title diganti LOGO (rbxassetid)
local logo = Instance.new("ImageLabel")
logo.Name = "Logo"
logo.BackgroundTransparency = 1
logo.AnchorPoint = Vector2.new(0.5, 0)
logo.Position = UDim2.new(0.5, 0, 0, 10)
logo.Size = UDim2.fromOffset(52, 52)
logo.Image = "rbxassetid://103570401113729"
logo.ImageTransparency = 0.05
logo.Parent = root

-- optional glow tipis (lebih “NodeHub”)
local lg = Instance.new("UIStroke")
lg.Thickness = 1
lg.Transparency = 0.35
lg.Color = Color3.fromRGB(255, 217, 0)
lg.Parent = logo



    -- BAR (segmented kotak-kotak)
    local shell = Instance.new("Frame")
    shell.Name = "BarShell"
    shell.AnchorPoint = Vector2.new(0.5, 0.5)
    shell.Position = UDim2.new(0.5, 0, 0.74, 0)


    shell.Size = UDim2.fromOffset(280, 36)
    shell.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shell.BackgroundTransparency = 0
    shell.BorderSizePixel = 0
    shell.Parent = root

    local shellCorner = Instance.new("UICorner")
    shellCorner.CornerRadius = UDim.new(0, 10)
    shellCorner.Parent = shell

    local shellStroke = Instance.new("UIStroke")
    shellStroke.Thickness = 2
    shellStroke.Transparency = 0.08
    shellStroke.Color = Color3.fromRGB(255, 217, 0)
    shellStroke.Parent = shell

    local inner = Instance.new("Frame")
    inner.Name = "Inner"
    inner.Size = UDim2.new(1, -12, 1, -12)
    inner.Position = UDim2.fromOffset(6, 6)
    inner.BackgroundTransparency = 1
    inner.Parent = shell

    -- Segments container
    local segments = Instance.new("Frame")
    segments.Name = "Segments"
    segments.Size = UDim2.new(1, 0, 1, 0)
    segments.BackgroundTransparency = 1
    segments.Parent = inner

    local layout = Instance.new("UIListLayout")
    layout.FillDirection = Enum.FillDirection.Horizontal
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Left
    layout.VerticalAlignment = Enum.VerticalAlignment.Center
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 4)
    layout.Parent = segments

    local SEG_COUNT = 12
    local segmentFrames = {}

    for i = 1, SEG_COUNT do
        local seg = Instance.new("Frame")
        seg.Name = "Seg" .. i
        seg.Size = UDim2.new(1/SEG_COUNT, -4, 1, 0)
        seg.BackgroundColor3 = Color3.fromRGB(255, 217, 0)
        seg.BackgroundTransparency = 0.85 -- default “mati”
        seg.BorderSizePixel = 0
        seg.Parent = segments

        local c = Instance.new("UICorner")
        c.CornerRadius = UDim.new(0, 6)
        c.Parent = seg

        table.insert(segmentFrames, seg)
    end

    -- Text progress di tengah bar
    local midText = Instance.new("TextLabel")
    midText.Name = "MidText"
    midText.BackgroundTransparency = 1
    midText.AnchorPoint = Vector2.new(0.5, 0.5)
    midText.Position = UDim2.new(0.5, 0, 0.5, 0)
    midText.Size = UDim2.new(1, 0, 1, 0)
    midText.Font = Enum.Font.GothamBold
    midText.TextSize = 14
    midText.TextColor3 = Color3.fromRGB(230, 230, 230)
    midText.TextStrokeTransparency = 0.35
    midText.Text = ("0/%d"):format(total)
    midText.Parent = inner

    -- Anim: stroke pulse halus
    local strokeTw = TweenService:Create(
        stroke,
        TweenInfo.new(0.9, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true),
        { Transparency = 0.30 }
    )
    strokeTw:Play()

    local alive = true
    local currentLit = 0

    -- efek “charging shimmer” jalan bolak-balik di seg yang sudah nyala
    local shimmerIdx = 1
    local shimmerDir = 1
    local hbConn

    local function applySegments(litCount)
        litCount = math.clamp(litCount, 0, SEG_COUNT)

        for i = 1, SEG_COUNT do
            local seg = segmentFrames[i]
            if i <= litCount then
                seg.BackgroundTransparency = 0.15
            else
                seg.BackgroundTransparency = 0.85
            end
        end
    end

    hbConn = RunService.Heartbeat:Connect(function(dt)
        if not alive then return end
        if currentLit <= 0 then return end

        shimmerIdx += shimmerDir
        if shimmerIdx >= currentLit then
            shimmerIdx = currentLit
            shimmerDir = -1
        elseif shimmerIdx <= 1 then
            shimmerIdx = 1
            shimmerDir = 1
        end

        -- reset baseline untuk yang nyala
        for i = 1, currentLit do
            segmentFrames[i].BackgroundTransparency = 0.15
        end

        -- shimmer: bikin 1 seg agak terang
        local s = segmentFrames[shimmerIdx]
        if s then s.BackgroundTransparency = 0.02 end
    end)

    local function setProgress(p, textOrCounter)
        if not alive then return end

        -- dukung mode “teks angka langsung”
        if type(textOrCounter) == "string" and textOrCounter:find("/") then
            midText.Text = textOrCounter
        end

        p = math.clamp(tonumber(p) or 0, 0, 1)

        local lit = math.floor(p * SEG_COUNT + 0.00001)
        if lit ~= currentLit then
            currentLit = lit
            applySegments(currentLit)
        end
    end

    local function destroy()
        if not alive then return end
        alive = false
        pcall(function() strokeTw:Cancel() end)
        pcall(function() if hbConn then hbConn:Disconnect() end end)
        pcall(function() gui:Destroy() end)
    end

    -- init
    applySegments(0)
    setProgress(0, ("0/%d"):format(total))

    return {
        SetProgress = setProgress,
        Destroy = destroy,
    }
end

-- NodeHubNeonUI.lua
-- UI Style B: Kuning - Hitam, Neon Glow, Sidebar kiri, Floating
-- Dibungkus jadi module "MainUI" supaya tab main & sub tab bisa di-file terpisah.

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local LP = Players.LocalPlayer
local PlayerGui = LP:WaitForChild("PlayerGui")
local TextService  = game:GetService("TextService") 

-- =========================
-- COLOR & STYLE CONFIG
-- =========================
local COLOR_BG        = Color3.fromRGB(5, 5, 5)
local COLOR_PANEL     = Color3.fromRGB(10, 10, 10)
local COLOR_PANEL_ALT = Color3.fromRGB(15, 15, 15)
local COLOR_YELLOW    = Color3.fromRGB(255, 211, 0) -- #FFD300
local COLOR_WHITE     = Color3.fromRGB(255, 255, 255)
local COLOR_GRAY_TEXT = Color3.fromRGB(180, 180, 180)

local SIDEBAR_WIDTH   = 120 -- medium
local MAIN_W          = 620
local MAIN_H          = 400

-- =========================
-- HELPERS
-- =========================
local function createStroke(parent, color, thickness, transparency)
    local s = Instance.new("UIStroke")
    s.Color = color
    s.Thickness = thickness or 1
    s.Transparency = transparency or 0
    s.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
    s.Parent = parent
    return s
end

local function createCorner(parent, radius)
    local c = Instance.new("UICorner")
    c.CornerRadius = UDim.new(0, radius or 8)
    c.Parent = parent
    return c
end

local function tweenColor(obj, prop, to, time)
    time = time or 0.12
    TweenService:Create(obj, TweenInfo.new(time, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
        [prop] = to
    }):Play()
end



local function makeDraggable(frame, dragHandle)
    dragHandle = dragHandle or frame
    dragHandle.Active = true            -- penting

    local dragging = false
    local dragStart
    local startPos

    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging  = true
            dragStart = input.Position
            startPos  = frame.Position
        end
    end)

    dragHandle.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1
        or input.UserInputType == Enum.UserInputType.Touch then
            dragging  = false
            dragStart = nil
            startPos  = nil
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if not dragging then return end

        if input.UserInputType ~= Enum.UserInputType.MouseMovement
        and input.UserInputType ~= Enum.UserInputType.Touch then
            return
        end

        -- ðŸ” Guard biar gak error "attempt to index nil with 'X'"
        if not dragStart or not startPos then
            return
        end

        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end)
end



-- =========================
-- MAINUI ADAPTER (Jordi Hub)
-- =========================
local Library
pcall(function()
    Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/JordiTBA/dasdwada/refs/heads/main/dwa"))()
end)

if not Library then
    warn("Failed to load Jordi Hub Library. Check URL or Executor.")
    return
end

local MainUI = {}
MainUI.__index = MainUI

function MainUI.new(opts)
    local self = setmetatable({}, MainUI)
    self.Window = Library:CreateWindow({
        Title = "Jordi Hub",
        SubTitle = "Grow A Garden",
        TabWidth = 160
    })
    self.Tabs = {}
    return self
end

function MainUI:RegisterMainTab(key, label, order)
    return {}
end

function MainUI:RegisterSubTab(mainKey, subKey, label, builderFn, order)
    local tab = self.Window:CreateTab(label, 4483362458)
    self.CurrentTab = tab
    if builderFn then
        pcall(builderFn)
    end
    self.CurrentTab = nil
end

function MainUI:CreateSection(title, defaultExpanded)
    if not self.CurrentTab then return nil, function() end end
    local section = self.CurrentTab:CreateSection(title)
    return section, function() end
end

function MainUI:CreateRowLabel(parent, text, desc, order)
    if not parent then return end
    local para = parent:CreateParagraph({Title = text, Content = desc or ""})
    local proxy = newproxy(true)
    local meta = getmetatable(proxy)
    meta.__newindex = function(_, k, v)
        if k == "Text" then para:SetTitle(v) end
    end
    return nil, proxy
end

function MainUI:CreateRowInput(parent, labelText, defaultText, onChanged, order)
    if not parent then return end
    local input = parent:CreateInput({
        Name = labelText,
        Placeholder = defaultText,
        Callback = onChanged
    })
    local proxy = newproxy(true)
    local meta = getmetatable(proxy)
    meta.__newindex = function(_, k, v)
        if k == "Text" then input:SetValue(v) end
    end
    return nil, proxy
end

function MainUI:CreateRowToggle(parent, labelText, initial, onChanged, order)
    if not parent then return end
    local toggle = parent:CreateToggle({
        Name = labelText,
        CurrentValue = initial,
        Callback = onChanged
    })
    local proxy = newproxy(true)
    local meta = getmetatable(proxy)
    meta.__newindex = function(_, k, v)
        if k == "Checked" then toggle:SetValue(v) end
    end
    return nil, proxy
end

function MainUI:CreateRowDropdown(parent, opts)
    if not parent then return end
    local dropdown = parent:CreateDropdown({
        Name = opts.label,
        Items = opts.items or {},
        CurrentValue = opts.current,
        Multi = opts.multi,
        Callback = opts.onSelected
    })
    local proxy = {}
    function proxy:Refresh(items, current) dropdown:Refresh(items, current) end
    return nil, proxy
end

function MainUI:CreateRowList(parent, titleText, entries, onItemToggle, order)
    if not parent then return nil, function() end end
    
    local currentItems = entries or {}
    
    local dropdown = parent:CreateDropdown({
        Name = titleText,
        Items = currentItems,
        Multi = true,
        Callback = function(val)
            for _, item in ipairs(currentItems) do
                local isSelected = val[item] == true
                if onItemToggle then onItemToggle(item, isSelected) end
            end
        end
    })
    
    local function api(action, payload)
        if action == "setList" or action == "setItems" then
            currentItems = payload or {}
            dropdown:Refresh(currentItems, {})
        elseif action == "setSelected" and type(payload) == "table" then
            dropdown:SetValue(payload)
        end
    end
    
    return nil, api
end

function MainUI:ClearSubContent() end
function MainUI:SetActiveMainTab(key) end
function MainUI:SetFooterButtons(list) end
function MainUI:SetFooterButtonsFor(mainKey, list) end
function MainUI:OpenModePicker(items, currentId, onChosen) end
function MainUI:Minimize() end
function MainUI:Restore() end

if false then
-- =========================
-- MAINUI CLASS
-- =========================
local MainUI_Old = {}
MainUI_Old.__index = MainUI_Old

function MainUI_Old.new(opts)
    opts = opts or {}
    local self = setmetatable({}, MainUI)
    
    local iconId = opts.iconId or "rbxassetid://103570401113729"

    -- kalau sudah ada GUI lama, destroy
    local old = PlayerGui:FindFirstChild("NodeHubNeonUI")
    local overlay = PlayerGui:FindFirstChild("NodeHubDropdownOverlay")
    if old then
        old:Destroy()
        if overlay then
        overlay:Destroy()
        end
    end

    -- =========================
    -- ROOT SCREEN GUI
    -- =========================
    local sg = Instance.new("ScreenGui")
    sg.Name = "NodeHubNeonUI"
    sg.ResetOnSpawn = false
    sg.IgnoreGuiInset = true
    sg.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    sg.DisplayOrder = 9999
    sg.Parent = PlayerGui

    -- semi-transparent overlay (floating feel)
    local overlay = Instance.new("Frame")
    overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    overlay.BackgroundTransparency = 0.35
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.Parent = sg

-- Panel utama
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, MAIN_W, 0, MAIN_H)
mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
mainFrame.BackgroundColor3 = COLOR_PANEL
mainFrame.Parent = overlay

local GuiService = game:GetService("GuiService")

local uiScale = Instance.new("UIScale")
uiScale.Parent = mainFrame



local function clamp(x, a, b)
    if x < a then return a end
    if x > b then return b end
    return x
end

local function updateScale()
    local cam = workspace.CurrentCamera
    if not cam then return end

    local v = cam.ViewportSize
    if not v or v.X <= 0 or v.Y <= 0 then return end

    -- hitung â€œmuat layarâ€
    local sx = v.X / MAIN_W
    local sy = v.Y / MAIN_H
    local s  = math.min(sx, sy)

    -- âœ… PAKSA: mau layar gede pun, jangan pernah 1.0
    local MAX_SCALE = 1   -- <-- kamu bisa ubah (0.7 lebih kecil)
    local MIN_SCALE = 0.35

    if s > MAX_SCALE then s = MAX_SCALE end
    if s < MIN_SCALE then s = MIN_SCALE end
    
    -- snap biar lebih tajam (kurangi blur)
local step = 0.05 -- coba 0.1 kalau masih blur
s = math.floor((s / step) + 0.5) * step


    uiScale.Scale = s

    -- debug sekali buat buktiin berubah
    -- print("[NodeHub] UIScale =", uiScale.Scale, "Viewport=", v.X, v.Y)
end



local viewportConn
local function bindCamera(cam)
    if viewportConn then viewportConn:Disconnect() end
    if not cam then return end
    viewportConn = cam:GetPropertyChangedSignal("ViewportSize"):Connect(updateScale)
end

bindCamera(workspace.CurrentCamera)
updateScale()

workspace:GetPropertyChangedSignal("CurrentCamera"):Connect(function()
    bindCamera(workspace.CurrentCamera)
    updateScale()
end)

-- âœ… jaga-jaga: beberapa game update viewport belakangan
task.defer(updateScale)
task.delay(0.2, updateScale)

----------------------------------------------------------------

mainFrame.Active = true
createCorner(mainFrame, 10)
createStroke(mainFrame, COLOR_YELLOW, 1, 0.25)


    -- =========================
    -- HEADER
    -- =========================
    local header = Instance.new("Frame")
    header.BackgroundColor3 = COLOR_PANEL
    header.BackgroundTransparency = 1
    header.Position = UDim2.new(0, 0, 0, 3)
    header.Size = UDim2.new(1, 0, 0, 28)
    header.Parent = mainFrame
    header.Active = true
    createCorner(header, 10)

    -- ICON di kiri
    local iconImg = Instance.new("ImageLabel")
    iconImg.Name = "Logo"
    iconImg.BackgroundTransparency = 1
    iconImg.Size = UDim2.new(0, 20, 0, 20)
    iconImg.Position = UDim2.new(0, 8, 0.5, -10)
    iconImg.Image = iconId
    iconImg.Parent = header

    -- TITLE di samping icon
    local title = Instance.new("TextLabel")
    title.BackgroundTransparency = 1
    title.Size = UDim2.new(1, -40, 1, 0)
    title.Position = UDim2.new(0, 34, 0, 0) -- digeser dikit, biar gak nabrak icon
    title.Font = Enum.Font.GothamBlack
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextSize = 16
    title.TextColor3 = COLOR_YELLOW
    title.Text = opts.title or "âš¡ NODE HUB"
    title.Parent = header


    -- Close button kecil (opsional)
    -- Close button kecil (opsional)
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 24, 0, 24)
    closeBtn.Position = UDim2.new(1, -30, 0.5, -12)
    closeBtn.BackgroundColor3 = COLOR_PANEL
    closeBtn.Text = "-"  -- tombol minimize
    closeBtn.TextColor3 = COLOR_WHITE
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 14
    closeBtn.Parent = header
    createCorner(closeBtn, 8)
    createStroke(closeBtn, COLOR_YELLOW, 1, 0.5)



    -- =========================
    -- BODY (SIDEBAR + RIGHT)
    -- =========================
    local body = Instance.new("Frame")
    body.BackgroundTransparency = 1
    body.Size = UDim2.new(1, 0, 1, -32)
    body.Position = UDim2.new(0, 0, 0, 32)
    body.Parent = mainFrame

    -- SIDEBAR
    local sidebar = Instance.new("Frame")
    sidebar.BackgroundColor3 = COLOR_PANEL
    sidebar.Size = UDim2.new(0, SIDEBAR_WIDTH, 1, -8)
    sidebar.Position = UDim2.new(0, 4, 0, 4)
    sidebar.Parent = body
    createCorner(sidebar, 10)
    createStroke(sidebar, COLOR_YELLOW, 1, 0.6)

    local sideList = Instance.new("UIListLayout")
    sideList.FillDirection = Enum.FillDirection.Vertical
    sideList.SortOrder = Enum.SortOrder.LayoutOrder
    sideList.Padding = UDim.new(0, 4)
    sideList.Parent = sidebar

    local sidePad = Instance.new("UIPadding")
    sidePad.PaddingTop    = UDim.new(0, 8)
    sidePad.PaddingLeft   = UDim.new(0, 8)
    sidePad.PaddingRight  = UDim.new(0, 8)
    sidePad.PaddingBottom = UDim.new(0, 8)
    sidePad.Parent = sidebar

    -- RIGHT PANEL
    local right = Instance.new("Frame")
    right.BackgroundColor3 = COLOR_PANEL
    right.Size = UDim2.new(1, -SIDEBAR_WIDTH - 13, 1, -8)
    right.Position = UDim2.new(0, SIDEBAR_WIDTH + 10, 0, 4)
    right.Parent = body
    createCorner(right, 10)
    createStroke(right, COLOR_YELLOW, 1, 0.3)

    -- Subtab bar
    local subBar = Instance.new("Frame")
    subBar.BackgroundTransparency = 1
    subBar.Size = UDim2.new(1, -16, 0, 28)
    subBar.Position = UDim2.new(0, 8, 0, 6)
    subBar.Parent = right

    local subLayout = Instance.new("UIListLayout")
    subLayout.FillDirection = Enum.FillDirection.Horizontal
    subLayout.SortOrder = Enum.SortOrder.LayoutOrder
    subLayout.Padding = UDim.new(0, 6)
    subLayout.Parent = subBar

    -- Content
-- Content (SCROLLING)
local content = Instance.new("ScrollingFrame")
content.BackgroundColor3 = COLOR_PANEL
content.Size = UDim2.new(1, -16, 1, -76)
content.Position = UDim2.new(0, 8, 0, 40)
content.ScrollBarThickness = 4
content.ScrollBarImageTransparency = 0
content.BorderSizePixel = 0
content.ClipsDescendants = true
content.AutomaticCanvasSize = Enum.AutomaticSize.Y
content.CanvasSize = UDim2.new(0, 0, 0, 0) -- di-auto oleh AutomaticCanvasSize
content.Parent = right
createCorner(content, 10)
createStroke(content, COLOR_YELLOW, 1, 0.4)

local contentPad = Instance.new("UIPadding")
contentPad.PaddingTop = UDim.new(0, 8)
contentPad.PaddingLeft = UDim.new(0, 8)
contentPad.PaddingRight = UDim.new(0, 8)
contentPad.Parent = content

local contentLayout = Instance.new("UIListLayout")
contentLayout.FillDirection = Enum.FillDirection.Vertical
contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
contentLayout.Padding = UDim.new(0, 6)
contentLayout.Parent = content



    -- Footer
    local footer = Instance.new("Frame")
    footer.BackgroundTransparency = 1
    footer.Size = UDim2.new(1, -16, 0, 26)
    footer.Position = UDim2.new(0, 8, 1, -30)
    footer.Parent = right

    local footerLayout = Instance.new("UIListLayout")
    footerLayout.FillDirection = Enum.FillDirection.Horizontal
    footerLayout.SortOrder = Enum.SortOrder.LayoutOrder
    footerLayout.Padding = UDim.new(0, 6)
    footerLayout.HorizontalAlignment = Enum.HorizontalAlignment.Left
    footerLayout.Parent = footer

    -- simpan ke self
    -- simpan ke self
    self._sg           = sg
    self.overlay       = overlay
    self.mainFrame     = mainFrame
    self.header        = header
    self.titleLabel    = title
    self.sidebar       = sidebar
    self.right         = right
    self.subBar        = subBar
    self.content       = content
    --self.contentLabel  = contentLabel
    self.footer        = footer

    self.mainTabButtons = {}
    self.subTabButtons  = {}
    self.mainTabs       = {}  -- [key] = {label, order}
    self.subTabs        = {}  -- [mainKey][subKey] = {label, order, builder}
    self.footerButtons  = {}

    self.activeMainKey  = nil
    self.activeSubKey   = nil
    self.footerConfig = {
        default = nil,
    }
    
    -- setelah self.content dan self.footer dibuat & di-Parent
self._footerHeight = self.footer.Size.Y.Offset   -- misal 32 / 36 px (pakai yang ada sekarang)

-- simpan size content saat footer ON (default)
self._contentSizeWithFooter = self.content.Size

-- versi tanpa footer: tambahin tinggi footer ke offset Y
self._contentSizeNoFooter = UDim2.new(
    self.content.Size.X.Scale,
    self.content.Size.X.Offset,
    self.content.Size.Y.Scale,
    self.content.Size.Y.Offset + self._footerHeight
)


    -- state minimize
    -- state minimize
    self.isMinimized = false

    -- Icon kecil (minimized) di pojok kiri bawah
    -- Icon kecil (minimized) di pojok kiri bawah
    local miniBtn = Instance.new("ImageButton")
    miniBtn.Name = "NodeHubMiniIcon"
    miniBtn.Size = UDim2.new(0, 40, 0, 40)
    miniBtn.AnchorPoint = Vector2.new(0, 1)
    miniBtn.Position = UDim2.new(0, 16, 1, -16)
    miniBtn.BackgroundColor3 = COLOR_PANEL
    miniBtn.AutoButtonColor = false
    miniBtn.BorderSizePixel = 0
    miniBtn.Image = iconId
    miniBtn.ScaleType = Enum.ScaleType.Fit
    miniBtn.Visible = false
    miniBtn.ZIndex = 100
    miniBtn.Parent = sg
    createCorner(miniBtn, 12)
    createStroke(miniBtn, COLOR_YELLOW, 1, 0.4)



    self._miniBtn = miniBtn

    -- drag mainFrame pakai header
    makeDraggable(mainFrame, header)

    -- klik tombol "-" â†’ minimize
    closeBtn.MouseButton1Click:Connect(function()
       -- print("[NodeHub] Minimize clicked")       -- DEBUG
        self:_setMinimized(true)
    end)

    -- klik icon kecil â†’ restore
    miniBtn.MouseButton1Click:Connect(function()
     --   print("[NodeHub] Restore clicked")        -- DEBUG
        self:_setMinimized(false)
    end)

    return self


end

-- ======================
-- INTERNAL: UPDATE LABEL
-- ======================
function MainUI:_updateContentLabel()
    local mainKey = self.activeMainKey or "-"
    local subKey  = self.activeSubKey or "-"
    --self.contentLabel.Text = string.format("Content: MainTab = %s | SubTab = %s", mainKey, subKey)
end

-- ======================
-- API: REGISTER MAIN TAB
-- ======================
function MainUI:RegisterMainTab(key, label, order)
    if self.mainTabButtons[key] then
        return -- sudah ada
    end

    self.mainTabs[key] = {
        label = label or key,
        order = order or 1,
    }

    local btn = Instance.new("TextButton")
    btn.Name = "Tab_" .. key
    btn.Size = UDim2.new(1, 0, 0, 26)
    btn.BackgroundColor3 = COLOR_PANEL
    btn.AutoButtonColor = false
    btn.Font = Enum.Font.GothamBold
    btn.Text = string.upper(label or key)
    btn.BorderSizePixel = 0
    btn.TextSize = 12
    btn.TextXAlignment = Enum.TextXAlignment.Center
    btn.TextColor3 = COLOR_WHITE
    btn.LayoutOrder = order or 1
    btn.Parent = self.sidebar

    local pad = Instance.new("UIPadding")
    pad.PaddingLeft = UDim.new(0, 0)
    pad.Parent = btn

    local underline = Instance.new("Frame")
    underline.Name = "Underline"
    underline.BackgroundColor3 = COLOR_YELLOW
    underline.Size = UDim2.new(0, 0, 0, 2)
    underline.Position = UDim2.new(0, 8, 1, -2)
    underline.BorderSizePixel = 0
    underline.BackgroundTransparency = 0.35
    underline.Parent = btn

    self.mainTabButtons[key] = btn

    btn.MouseEnter:Connect(function()
        if self.activeMainKey ~= key then
            tweenColor(btn, "TextColor3", COLOR_YELLOW)
        end
    end)

    btn.MouseLeave:Connect(function()
        if self.activeMainKey ~= key then
            tweenColor(btn, "TextColor3", COLOR_WHITE)
        end
    end)

    btn.MouseButton1Click:Connect(function()
        self:SetActiveMainTab(key)
    end)
end

-- ======================
-- API: REGISTER SUB TAB
-- ======================
function MainUI:RegisterSubTab(mainKey, subKey, label, builderFn, order)
    self.subTabs[mainKey] = self.subTabs[mainKey] or {}
    self.subTabs[mainKey][subKey] = {
        label   = label or subKey,
        order   = order or 1,
        builder = builderFn,
    }

    -- kalau mainKey sedang aktif, rebuild bar subtab
    if self.activeMainKey == mainKey then
        self:_rebuildSubTabs(mainKey)
    end
end

-- INTERNAL: rebuild bar sub tab untuk 1 mainKey
-- INTERNAL: rebuild bar sub tab untuk 1 mainKey
function MainUI:_rebuildSubTabs(mainKey)
    -- hapus tombol lama
    for _, child in ipairs(self.subBar:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    self.subTabButtons = {}

    local list = self.subTabs[mainKey]
    if not list then return end

    -- sort by order
    local arr = {}
    for sk, info in pairs(list) do
        table.insert(arr, { key = sk, info = info })
    end
    table.sort(arr, function(a,b)
        return (a.info.order or 1) < (b.info.order or 1)
    end)

    ----------------------------------------------------------------
    -- AUTO WIDTH: makin banyak sub tab â†’ makin kecil
    ----------------------------------------------------------------
    local count = #arr
    local baseWidth = 80
    local minWidth  = 73
    local maxWidth  = 120
    local btnWidth  = baseWidth

    if count > 0 then
        if count <= 4 then
            btnWidth = baseWidth
        else
            local shrinkStep = 8
            btnWidth = baseWidth - (count - 4) * shrinkStep
        end
        btnWidth = math.clamp(btnWidth, minWidth, maxWidth)
    end

    ----------------------------------------------------------------
    -- BUILD BUTTONS: style D (glow border)
    ----------------------------------------------------------------
    for _, item in ipairs(arr) do
        local subKey = item.key
        local info   = item.info

        local btn = Instance.new("TextButton")
        btn.Name = "Sub_" .. subKey
        btn.AutoButtonColor = false
        btn.Size = UDim2.new(0, btnWidth, 1, 0)
        btn.BackgroundColor3 = COLOR_PANEL          -- gelap, menyatu dengan bar
        btn.BorderSizePixel = 0
        btn.Text = info.label
        btn.TextSize = 12
        btn.Font = Enum.Font.GothamBold
        btn.TextTruncate = Enum.TextTruncate.AtEnd
        btn.TextColor3 = COLOR_GRAY_TEXT            -- non-aktif default
        btn.LayoutOrder = info.order or 1
        btn.Parent = self.subBar
        createCorner(btn, 999)

        -- border neon / ghost
        local stroke = createStroke(btn, Color3.fromRGB(90,90,90), 1, 0.5)
        -- Transparency 0.5 â†’ ghost, non-aktif

        self.subTabButtons[subKey] = {
            button = btn,
            stroke = stroke,
        }

        -- hover effect: sedikit terang kalau belum aktif
        btn.MouseEnter:Connect(function()
            if self.activeSubKey ~= subKey then
                tweenColor(btn, "TextColor3", Color3.fromRGB(220,220,220))
                stroke.Transparency = 0.3
            end
        end)

        btn.MouseLeave:Connect(function()
            if self.activeSubKey ~= subKey then
                tweenColor(btn, "TextColor3", COLOR_GRAY_TEXT)
                stroke.Transparency = 0.5
            end
        end)

        btn.MouseButton1Click:Connect(function()
            self:_setActiveSubTab(mainKey, subKey)
        end)
    end
end


function MainUI:_applySubTabVisual(activeSubKey)
    local style = self.subTabStyle or "pill"

        ----------------------------------------------------------------
    -- STYLE D: glow neon capsule border
    ----------------------------------------------------------------
    for sKey, pack in pairs(self.subTabButtons) do
        local btn    = pack.button
        local stroke = pack.stroke

        if sKey == subKey then
            -- ðŸ”¥ AKTIF â†’ border neon kuning, teks kuning
            tweenColor(btn, "BackgroundColor3", Color3.fromRGB(16,16,16))
            tweenColor(btn, "TextColor3", COLOR_YELLOW)

            if stroke then
                stroke.Color        = COLOR_YELLOW
                stroke.Thickness    = 2
                stroke.Transparency = 0     -- full terlihat
            end
        else
            -- ðŸŒ‘ NON-AKTIF â†’ border abu ghost, teks abu
            tweenColor(btn, "BackgroundColor3", COLOR_PANEL)
            tweenColor(btn, "TextColor3", COLOR_GRAY_TEXT)

            if stroke then
                stroke.Color        = Color3.fromRGB(90,90,90)
                stroke.Thickness    = 1
                stroke.Transparency = 0.5   -- ghost
            end
        end
    end

end

-- ======================
-- API: SET ACTIVE MAIN TAB
-- ======================
function MainUI:SetActiveMainTab(key)
    self.activeMainKey = key

    for name, btn in pairs(self.mainTabButtons) do
        local underline = btn:FindFirstChild("Underline")
        if name == key then
            tweenColor(btn, "TextColor3", COLOR_YELLOW)
            if underline then
                underline.Size = UDim2.new(1, -16, 0, 2)
                underline.BackgroundTransparency = 0
            end
        else
            tweenColor(btn, "TextColor3", COLOR_WHITE)
            if underline then
                underline.Size = UDim2.new(0, 0, 0, 2)
                underline.BackgroundTransparency = 0.35
            end
        end
    end

    self:_rebuildSubTabs(key)

    -- pick pertama berdasarkan order
    local list = self.subTabs[key]
    if list then
        local firstKey
        local firstOrder = math.huge
        for sk, info in pairs(list) do
            local o = info.order or 1
            if o < firstOrder then
                firstOrder = o
                firstKey = sk
            end
        end
        if firstKey then
            self:_setActiveSubTab(key, firstKey)
        end
    end

    local footerList = self.footerConfig[key] or self.footerConfig.default
self:_renderFooter(footerList)
self:_updateContentLabel()
end

-- INTERNAL: set active sub tab + panggil builder
function MainUI:_setActiveSubTab(mainKey, subKey)
    self.activeSubKey = subKey

    ----------------------------------------------------------------
    -- STYLE D: glow neon capsule border
    ----------------------------------------------------------------
    for sKey, pack in pairs(self.subTabButtons) do
        local btn    = pack.button
        local stroke = pack.stroke

        if sKey == subKey then
            -- ðŸ”¥ AKTIF â†’ border neon kuning, teks kuning
            tweenColor(btn, "BackgroundColor3", Color3.fromRGB(16,16,16))
            tweenColor(btn, "TextColor3", COLOR_YELLOW)

            if stroke then
                stroke.Color        = COLOR_YELLOW
                stroke.Thickness    = 2
                stroke.Transparency = 0     -- full terlihat
            end
        else
            -- ðŸŒ‘ NON-AKTIF â†’ border abu ghost, teks abu
            tweenColor(btn, "BackgroundColor3", COLOR_PANEL)
            tweenColor(btn, "TextColor3", COLOR_GRAY_TEXT)

            if stroke then
                stroke.Color        = Color3.fromRGB(90,90,90)
                stroke.Thickness    = 1
                stroke.Transparency = 0.5   -- ghost
            end
        end
    end

    ----------------------------------------------------------------
    -- sisanya tetap sama
    ----------------------------------------------------------------
    self:ClearSubContent()

    local info = self.subTabs[mainKey] and self.subTabs[mainKey][subKey]
    if info and info.builder then
        info.builder()
    end

    self:_updateContentLabel()
end


-- ======================
-- API: CLEAR SUB CONTENT
-- ======================
function MainUI:ClearSubContent()
    for _, child in ipairs(self.content:GetChildren()) do
        if child ~= self.contentLabel and not child:IsA("UIListLayout") and not child:IsA("UIPadding") then
            child:Destroy()
        end
    end
end


function MainUI:CreateSection(title, defaultExpanded)
    title = title or "Section"

    -- kalau nggak diisi, sementara default = true
    if defaultExpanded == nil then
        defaultExpanded = true
    end

    -- Root section frame (auto height)
    local section = Instance.new("Frame")
    section.Name = "Section_" .. title
    section.BackgroundTransparency = 1
    section.Size = UDim2.new(1, 0, 0, 0)
    section.AutomaticSize = Enum.AutomaticSize.Y
    section.LayoutOrder = #self.content:GetChildren() + 1
    section.Parent = self.content

    -- Header (clickable, buat buka/tutup)
    local header = Instance.new("TextButton")
    header.Name = "Header"
    header.AutoButtonColor = false
    header.BackgroundColor3 = COLOR_PANEL_ALT
    header.Size = UDim2.new(1, 0, 0, 26)
    header.Text = ""
    header.BorderSizePixel = 0
    header.Parent = section
    createCorner(header, 8)
    createStroke(header, COLOR_YELLOW, 1, 0.3)

    -- Title label kiri
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.BackgroundTransparency = 1
    titleLabel.Size = UDim2.new(1, -40, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.TextSize = 13
    titleLabel.TextColor3 = COLOR_YELLOW
    titleLabel.Text = title
    titleLabel.Parent = header

    -- Icon panah kanan (â–¶ / â–¼)
    local arrow = Instance.new("TextLabel")
    arrow.Name = "Arrow"
    arrow.BackgroundTransparency = 1
    arrow.Size = UDim2.new(0, 20, 1, 0)
    arrow.Position = UDim2.new(1, -26, 0, 0)
    arrow.Font = Enum.Font.GothamBold
    arrow.TextSize = 14
    arrow.TextXAlignment = Enum.TextXAlignment.Center
    arrow.TextColor3 = COLOR_GRAY_TEXT
    arrow.Text = "â–¼"
    arrow.Parent = header

    -- Body tempat isi section nanti
    local body = Instance.new("Frame")
    body.Name = "Body"
    body.BackgroundTransparency = 1
    body.Size = UDim2.new(1, 0, 0, 0)
    body.Position = UDim2.new(0, 0, 0, 28)
    body.AutomaticSize = Enum.AutomaticSize.Y
    body.ClipsDescendants = true
    body.Parent = section

    local bodyPad = Instance.new("UIPadding")
    bodyPad.PaddingTop = UDim.new(0, 4)
    bodyPad.PaddingBottom = UDim.new(0, 4)
    bodyPad.PaddingLeft = UDim.new(0, 8)
    bodyPad.PaddingRight = UDim.new(0, 4)
    bodyPad.Parent = body

    local bodyLayout = Instance.new("UIListLayout")
    bodyLayout.FillDirection = Enum.FillDirection.Vertical
    bodyLayout.SortOrder = Enum.SortOrder.LayoutOrder
    bodyLayout.Padding = UDim.new(0, 4)
    bodyLayout.Parent = body

    -- state buka/tutup
    local expanded = defaultExpanded

    local function setExpanded(on)
        expanded = on
        body.Visible = on
        arrow.Text = on and "â–¼" or "â–¶"

        if on then
            tweenColor(header, "BackgroundColor3", COLOR_PANEL_ALT)
            tweenColor(titleLabel, "TextColor3", COLOR_YELLOW)
        else
            tweenColor(header, "BackgroundColor3", Color3.fromRGB(18,18,18))
            tweenColor(titleLabel, "TextColor3", COLOR_GRAY_TEXT)
        end
    end

    -- klik header â†’ toggle
    header.MouseButton1Click:Connect(function()
        setExpanded(not expanded)
    end)

    -- hover effect halus
    header.MouseEnter:Connect(function()
        if expanded then
            tweenColor(header, "BackgroundColor3", Color3.fromRGB(22,22,22))
        else
            tweenColor(header, "BackgroundColor3", Color3.fromRGB(24,24,24))
        end
    end)

    header.MouseLeave:Connect(function()
        if expanded then
            tweenColor(header, "BackgroundColor3", COLOR_PANEL_ALT)
        else
            tweenColor(header, "BackgroundColor3", Color3.fromRGB(18,18,18))
        end
    end)

    -- set awal
    setExpanded(defaultExpanded)

    -- â¬…ï¸ sekarang return 2 hal: body & fungsi setExpanded
    return body, setExpanded
end



----------------------------------------------------------
-- ROW: LABEL (optional description)
----------------------------------------------------------
function MainUI:CreateRowLabel(parent, text, desc, order)
    local row = Instance.new("Frame")
    row.Name = "RowLabel"
    row.BackgroundTransparency = 1
    row.Size = UDim2.new(1, 0, 0, desc and 34 or 22)
    row.AutomaticSize = Enum.AutomaticSize.None
    row.LayoutOrder = order or (#parent:GetChildren() + 1)
    row.Parent = parent

    local title = Instance.new("TextLabel")
    title.BackgroundTransparency = 1
    title.Position = UDim2.new(0, 0, 0, 0)
    title.Size = UDim2.new(1, 0, 0, 18)
    title.Font = Enum.Font.Gotham
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextSize = 12
    title.TextColor3 = COLOR_GRAY_TEXT
    title.Text = text or ""
    title.Parent = row

    if desc and desc ~= "" then
        local sub = Instance.new("TextLabel")
        sub.BackgroundTransparency = 1
        sub.Position = UDim2.new(0, 0, 0, 18)
        sub.Size = UDim2.new(1, 0, 0, 14)
        sub.Font = Enum.Font.Gotham
        sub.TextXAlignment = Enum.TextXAlignment.Left
        sub.TextSize = 11
        sub.TextColor3 = Color3.fromRGB(120,120,120)
        sub.Text = desc
        sub.Parent = row
    end

    -- â¬…ï¸ Tambah return kedua (title)
    return row, title
end


----------------------------------------------------------
-- ROW: TOGGLE (pill kanan)
----------------------------------------------------------
function MainUI:CreateRowToggle(parent, labelText, initial, onChanged, order)
    local row = Instance.new("Frame")
    row.Name = "RowToggle"
    row.BackgroundTransparency = 1
    row.Size = UDim2.new(1, 0, 0, 26)
    row.LayoutOrder = order or (#parent:GetChildren() + 1)
    row.Parent = parent

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0, 0, 0, 0)
    label.Size = UDim2.new(1, -70, 1, 0)
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextSize = 12
    label.TextColor3 = COLOR_GRAY_TEXT
    label.Text = labelText or "Toggle"
    label.Parent = row

    local toggleBtn = Instance.new("TextButton")
    toggleBtn.Name = "Toggle"
    toggleBtn.AutoButtonColor = false
    toggleBtn.BackgroundColor3 = Color3.fromRGB(30,30,30)
    toggleBtn.Size = UDim2.new(0, 48, 0, 20)
    toggleBtn.Position = UDim2.new(1, -52, 0.5, -10)
    toggleBtn.Text = ""
    toggleBtn.BorderSizePixel = 0
    toggleBtn.Parent = row
    createCorner(toggleBtn, 10)
    createStroke(toggleBtn, Color3.fromRGB(60,60,60), 1, 0.6)

    local knob = Instance.new("Frame")
    knob.Name = "Knob"
    knob.Size = UDim2.new(0, 18, 0, 18)
    knob.Position = UDim2.new(0, 1, 0, 1)
    knob.BackgroundColor3 = Color3.fromRGB(220,220,220)
    knob.BorderSizePixel = 0
    knob.Parent = toggleBtn
    createCorner(knob, 9)

    local state = initial and true or false

    local function applyState(animate)
        if state then
            if animate then
                tweenColor(toggleBtn, "BackgroundColor3", COLOR_YELLOW)
            else
                toggleBtn.BackgroundColor3 = COLOR_YELLOW
            end
            knob.Position = UDim2.new(1, -19, 0, 1)
        else
            if animate then
                tweenColor(toggleBtn, "BackgroundColor3", Color3.fromRGB(30,30,30))
            else
                toggleBtn.BackgroundColor3 = Color3.fromRGB(30,30,30)
            end
            knob.Position = UDim2.new(0, 1, 0, 1)
        end
    end

    applyState(false)

    toggleBtn.MouseButton1Click:Connect(function()
        state = not state
        applyState(true)
        if onChanged then
            onChanged(state)
        end
    end)

    -- getter/setter
    local function setGet(value)
        if value ~= nil then
            state = value and true or false
            applyState(false)
        end
        return state
    end

    return row, setGet
end

----------------------------------------------------------
-- ROW: INPUT (text box dengan label kiri)
----------------------------------------------------------
function MainUI:CreateRowInput(parent, labelText, defaultText, onChanged, order)
    local row = Instance.new("Frame")
    row.Name = "RowInput"
    row.BackgroundTransparency = 1
    row.Size = UDim2.new(1, 0, 0, 28)
    row.LayoutOrder = order or (#parent:GetChildren() + 1)
    row.Parent = parent

    -- Label kiri (lebih lebar, biar input gak kepanjangan)
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0, 0, 0, 0)
    label.Size = UDim2.new(0.6, 0, 1, 0)  -- 60% lebar
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextSize = 12
    label.TextColor3 = COLOR_GRAY_TEXT
    label.Text = labelText or "Input"
    label.Parent = row

    -- Nilai awal
    local currentValue = (defaultText ~= nil) and tostring(defaultText) or ""
    local beforeFocusValue = currentValue

    -- Input kanan (lebih pendek, nempel kanan)
    local box = Instance.new("TextBox")
    box.Name = "Input"
    box.BackgroundColor3 = Color3.fromRGB(18,18,18)
    box.Size = UDim2.new(0.2, 0, 1, -5)         -- 35% lebar
    box.Position = UDim2.new(0.79, 4, 0, 3)      -- mulai setelah label + 4px
    box.Font = Enum.Font.Gotham
    box.TextXAlignment = Enum.TextXAlignment.Center
    box.ClearTextOnFocus = false
    box.TextSize = 12
    box.TextColor3 = Color3.fromRGB(230,230,230)
    box.PlaceholderText = ""
    box.Text = currentValue
    box.Parent = row
    createCorner(box, 6)
    createStroke(box, Color3.fromRGB(60,60,60), 1, 0.6)

    local function trim(s)
        return (s and s:match("^%s*(.-)%s*$")) or ""
    end

    box.Focused:Connect(function()
        tweenColor(box, "BackgroundColor3", Color3.fromRGB(24,24,24))
        beforeFocusValue = currentValue

        -- Kosongkan supaya gampang edit, khususnya di HP
        if box.Text == currentValue then
            box.Text = ""
        end
    end)

    box.FocusLost:Connect(function(enterPressed)
        tweenColor(box, "BackgroundColor3", Color3.fromRGB(18,18,18))

        local newText = trim(box.Text)

        -- Kalau kosong â†’ kembalikan nilai lama, jangan trigger onChanged
        if newText == "" then
            box.Text = currentValue
            return
        end

        -- Kalau sama dengan nilai lama â†’ tidak ada perubahan
        if newText == beforeFocusValue then
            box.Text = currentValue
            return
        end

        -- Ada perubahan â†’ update currentValue + panggil callback
        currentValue = newText
        box.Text = currentValue

        if onChanged then
            onChanged(currentValue)
        end
    end)

    -- getter/setter: setGet(nil) â†’ get, setGet("123") â†’ set
    local function setGet(value)
        if value ~= nil then
            currentValue = tostring(value)
            box.Text = currentValue
        end
        return currentValue
    end

    return row, setGet
end


----------------------------------------------------------
-- ROW: SIMPLE LIST (list of toggle-buttons)
-- entries: { "Item A", "Item B", ... } atau
--          { {name="Item A", key="a"}, ... }
----------------------------------------------------------
function MainUI:CreateRowList(parent, titleText, entries, onItemToggle, order)
    entries      = entries or {}
    onItemToggle = onItemToggle or function() end

    --------------------------------------------------
    -- ROW + TITLE
    --------------------------------------------------
    local row = Instance.new("Frame")
    row.Name = "RowList"
    row.BackgroundTransparency = 1
    row.Size = UDim2.new(1, 0, 0, 0)
    row.AutomaticSize = Enum.AutomaticSize.Y
    row.LayoutOrder = order or (#parent:GetChildren() + 1)
    row.Parent = parent

    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.BackgroundTransparency = 1
    title.Position = UDim2.new(0, 0, 0, 0)
    title.Size = UDim2.new(1, 0, 0, 18)
    title.Font = Enum.Font.Gotham
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextSize = 12
    title.TextColor3 = COLOR_GRAY_TEXT
    title.Text = titleText or "List"
    title.Parent = row

    --------------------------------------------------
    -- CONTAINER LIST
    --------------------------------------------------
    local container = Instance.new("Frame")
    container.Name = "ListContainer"
    container.BackgroundColor3 = Color3.fromRGB(15, 15, 15)
    container.Position = UDim2.new(0, 0, 0, 20)
    container.Size = UDim2.new(1, 0, 0, 0)
    container.AutomaticSize = Enum.AutomaticSize.Y
    container.Parent = row

    createCorner(container, 6)
    createStroke(container, Color3.fromRGB(40, 40, 40), 1, 0.5)

    local pad = Instance.new("UIPadding")
    pad.PaddingTop    = UDim.new(0, 4)
    pad.PaddingBottom = UDim.new(0, 4)
    pad.PaddingLeft   = UDim.new(0, 4)
    pad.PaddingRight  = UDim.new(0, 4)
    pad.Parent = container

    local layout = Instance.new("UIListLayout")
    layout.FillDirection = Enum.FillDirection.Vertical
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 2)
    layout.Parent = container

    --------------------------------------------------
    -- STATE INTERNAL
    --------------------------------------------------
    local selectedMap    = {}           -- [key] = true/false
    local currentEntries = entries      -- list aktif sekarang

    local function normalizeEntry(e)
        if type(e) == "table" then
            return e.key or e.name, e.name or tostring(e.key)
        else
            return e, tostring(e)
        end
    end

    --------------------------------------------------
    -- BUILD BUTTONS
    --------------------------------------------------
    local function buildButtons(listOpt)
        -- kalau dipanggil dengan list baru â†’ update currentEntries
        if listOpt then
            currentEntries = listOpt
        end

        local list = currentEntries or {}

        -- clear lama
        for _, child in ipairs(container:GetChildren()) do
            if child:IsA("TextButton") then
                child:Destroy()
            end
        end

        for i, e in ipairs(list) do
            local key, labelText = normalizeEntry(e)

            -- kalau belum ada state, lihat dari field entry (selected / on)
            if selectedMap[key] == nil then
                if type(e) == "table" and (e.selected or e.on) then
                    selectedMap[key] = true
                else
                    selectedMap[key] = false
                end
            end

            local btn = Instance.new("TextButton")
            btn.Name = "Item_" .. tostring(key)
            btn.AutoButtonColor = false
            btn.BackgroundColor3 = Color3.fromRGB(22, 22, 22)
            btn.Size = UDim2.new(1, 0, 0, 22)
            btn.Text = "  " .. labelText
            btn.Font = Enum.Font.Gotham
            btn.TextXAlignment = Enum.TextXAlignment.Left
            btn.TextSize = 12
            btn.TextColor3 = Color3.fromRGB(200, 200, 200)
            btn.LayoutOrder = i
            btn.Parent = container
            createCorner(btn, 4)

            local function applyVisual()
                if selectedMap[key] then
                    tweenColor(btn, "BackgroundColor3", COLOR_YELLOW)
                    btn.TextColor3 = Color3.fromRGB(0, 0, 0)
                else
                    tweenColor(btn, "BackgroundColor3", Color3.fromRGB(22, 22, 22))
                    btn.TextColor3 = Color3.fromRGB(200, 200, 200)
                end
            end
            applyVisual()

            btn.MouseButton1Click:Connect(function()
                selectedMap[key] = not selectedMap[key]
                applyVisual()
                onItemToggle(key, selectedMap[key], labelText)
            end)
        end
    end

    -- build pertama
    buildButtons(currentEntries)

    --------------------------------------------------
    -- API
    --------------------------------------------------
    local function api(action, payload)
        if action == "setList" or action == "setItems" then
            -- ganti isi list + rebuild
            buildButtons(payload or {})

        elseif action == "setSelected" and type(payload) == "table" then
            -- ganti state selectedMap sesuai payload
            selectedMap = {}
            for k, v in pairs(payload) do
                if v then
                    selectedMap[k] = true
                end
            end
            -- redraw pakai currentEntries
            buildButtons()

        elseif action == "getSelected" then
            local result = {}
            for k, v in pairs(selectedMap) do
                if v then
                    table.insert(result, k)
                end
            end
            return result
        end
    end

    return row, api
end



----------------------------------------------------------
-- ROW: DROPDOWN (single / multi) dgn overlay + search
----------------------------------------------------------
-- opts:
-- {
--   label       = "Target Player",
--   placeholder = "Select...",
--   mode        = "single" / "multi"  (default: "single")
--   getItems    = function() return { "A", "B" } end
--                -- ATAU langsung table: { "A","B" } / { {key="a",name="A"}, ... }
--   initial     =   -- SINGLE: "key" / "name"
--                 -- MULTI : { [key]=true, [key2]=true }
--   onChanged   = function(mode, selected) end
-- }
function MainUI:CreateRowDropdown(parent, opts)
    opts = opts or {}
    local mode        = (opts.mode == "multi") and "multi" or "single"
    local labelText   = opts.label or "Dropdown"
    local placeholder = opts.placeholder or "Select..."

    -- Sumber item bisa function atau table
    local itemsSource = opts.getItems or {}

    local function getItemsList()
        if type(itemsSource) == "function" then
            local ok, res = pcall(itemsSource)
            if ok and type(res) == "table" then
                return res
            else
                warn("[NodeHubDropdown] getItems() tidak mengembalikan table, pakai {}")
                return {}
            end
        elseif type(itemsSource) == "table" then
            return itemsSource
        else
            warn("[NodeHubDropdown] getItems bukan function/table, pakai {}")
            return {}
        end
    end

    local onChanged   = opts.onChanged

    -- state
    local currentItems = {}
    local keyToLabel   = {}

    local selectedKey  = nil
    local selectedMap  = {}

    if mode == "single" then
        if opts.initial ~= nil then
            selectedKey = tostring(opts.initial)
        end
    else
        if type(opts.initial) == "table" then
            for k, v in pairs(opts.initial) do
                if v then
                    selectedMap[tostring(k)] = true
                end
            end
        end
    end

    ------------------------------------------------------
    -- ROW + LABEL + BUTTON
    ------------------------------------------------------
    local row = Instance.new("Frame")
    row.Name = "RowDropdown"
    row.BackgroundTransparency = 1
    row.Size = UDim2.new(1, 0, 0, 34)
    row.LayoutOrder = #parent:GetChildren() + 1
    row.Parent = parent

    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0, 0, 0, 0)
    label.Size = UDim2.new(0.6, 0, 1, 0)
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.TextSize = 12
    label.TextColor3 = COLOR_GRAY_TEXT
    label.Text = labelText
    label.Parent = row

    local button = Instance.new("TextButton")
    button.Name = "DropdownButton"
    button.AutoButtonColor = false
    button.BackgroundColor3 = Color3.fromRGB(18,18,18)
    button.Size = UDim2.new(0.4, 0, 1, -8)
    button.Position = UDim2.new(0.60, 0, 0, 3)
    button.Font = Enum.Font.Gotham
    button.TextXAlignment = Enum.TextXAlignment.Center
    button.TextSize = 11
    button.TextColor3 = Color3.fromRGB(230,230,230)
    button.Text = "  " .. placeholder
    button.Parent = row
    createCorner(button, 6)
    createStroke(button, Color3.fromRGB(60,60,60), 1, 0.6)

    local arrow = Instance.new("TextLabel")
    arrow.Name = "Arrow"
    arrow.BackgroundTransparency = 1
    arrow.Size = UDim2.new(0, 16, 1, 0)
    arrow.Position = UDim2.new(1, -18, 0, 0)
    arrow.Font = Enum.Font.GothamBold
    arrow.TextSize = 12
    arrow.TextXAlignment = Enum.TextXAlignment.Center
    arrow.TextColor3 = Color3.fromRGB(200,200,200)
    arrow.Text = "â–¼"
    arrow.Parent = button

    local function normalizeItem(e)
        if type(e) == "table" then
            local key = e.key or e.name
            local lbl = e.name or tostring(e.key)
            key = tostring(key)
            return key, lbl
        else
            local key = tostring(e)
            return key, key
        end
    end

    local function refreshButtonText()
        if mode == "single" then
            if not selectedKey then
                button.Text = "  " .. placeholder
                return
            end
            local label = keyToLabel[selectedKey] or selectedKey
            button.Text = "  " .. label
            return
        end

        local names = {}
        for k, on in pairs(selectedMap) do
            if on then
                table.insert(names, keyToLabel[k] or k)
            end
        end
        table.sort(names)

        if #names == 0 then
            button.Text = "  " .. placeholder
            return
        end

        local maxChars = 25
        local total = table.concat(names, ", ")
        if #total <= maxChars then
            button.Text = "  " .. total
            return
        end

        local shown, used = {}, 0
        for i, name in ipairs(names) do
            local part = (i == 1) and name or (", " .. name)
            if used + #part > maxChars then break end
            table.insert(shown, name)
            used += #part
        end
        local rest = #names - #shown
        local txt = table.concat(shown, ", ")
        if rest > 0 then
            txt ..= (" +%d"):format(rest)
        end
        button.Text = "  " .. txt
    end

local function openDropdown()
    -- parent: panel kanan / main frame NodeHub
    local parentFrame = self.right or self.mainFrame

    --------------------------------------------------
    -- OVERLAY DI DALAM NODEHUB (BLOCK CLICK DI BAWAH)
    --------------------------------------------------
    local overlay = Instance.new("TextButton")
    overlay.Name = "NodeHubDropdownOverlay"
    overlay.BackgroundColor3 = Color3.fromRGB(0,0,0)
    overlay.BackgroundTransparency = 0.25      -- agak gelap
    overlay.AutoButtonColor = false
    overlay.BorderSizePixel = 0
    overlay.Text = ""
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.Position = UDim2.new(0, 0, 0, 0)
    overlay.ZIndex = 98
    overlay.Active = true
    overlay.Parent = parentFrame

    --------------------------------------------------
    -- PANEL DROPDOWN (TENGAH NODEHUB)
    --------------------------------------------------
    local panel = Instance.new("Frame")
    panel.Name = "DropdownPanel"
    panel.Size = UDim2.new(0, 280, 0, 260)
    panel.AnchorPoint = Vector2.new(0.5, 0.5)
    panel.Position = UDim2.new(0.5, 0, 0.5, 0)
    panel.BackgroundColor3 = COLOR_PANEL
    panel.ZIndex = 99                 -- di atas overlay
    panel.Active = true
    panel.Parent = overlay
    createCorner(panel, 10)
    createStroke(panel, COLOR_YELLOW, 1, 0.3)

    local pad = Instance.new("UIPadding")
    pad.PaddingTop    = UDim.new(0, 8)
    pad.PaddingBottom = UDim.new(0, 8)
    pad.PaddingLeft   = UDim.new(0, 8)
    pad.PaddingRight  = UDim.new(0, 8)
    pad.Parent = panel

    --------------------------------------------------
    -- HEADER: LABEL (KIRI) + TOMBOL X (KANAN)
    --------------------------------------------------
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.BackgroundTransparency = 1
    header.Size = UDim2.new(1, 0, 0, 24)
    header.Position = UDim2.new(0, 0, 0, 0)
    header.ZIndex = 100
    header.Parent = panel

    local headerLabel = Instance.new("TextLabel")
    headerLabel.Name = "HeaderLabel"
    headerLabel.BackgroundTransparency = 1
    headerLabel.Size = UDim2.new(1, -28, 1, 0) -- sisakan space untuk X
    headerLabel.Position = UDim2.new(0, 0, 0, 0)
    headerLabel.Font = Enum.Font.Gotham
    headerLabel.TextSize = 12
    headerLabel.TextXAlignment = Enum.TextXAlignment.Left
    headerLabel.TextColor3 = COLOR_GRAY_TEXT
    headerLabel.Text = labelText   -- pakai label dari row
    headerLabel.ZIndex = 101
    headerLabel.Parent = header

    local closeBtn = Instance.new("TextButton")
    closeBtn.Name = "CloseButton"
    closeBtn.Size = UDim2.new(0, 22, 0, 22)
    closeBtn.AnchorPoint = Vector2.new(1, 0.5)
    closeBtn.Position = UDim2.new(1, 0, 0.5, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(18,18,18)
    closeBtn.AutoButtonColor = false
    closeBtn.BorderSizePixel = 0
    closeBtn.Text = "X"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 12
    closeBtn.TextColor3 = COLOR_WHITE
    closeBtn.ZIndex = 101
    closeBtn.Parent = header
    createCorner(closeBtn, 6)
    createStroke(closeBtn, COLOR_YELLOW, 1, 0.4)

    --------------------------------------------------
    -- SEARCH (DI BAWAH HEADER, FULL WIDTH)
    --------------------------------------------------
    local search = Instance.new("TextBox")
    search.Name = "SearchBox"
    search.Size = UDim2.new(1, 0, 0, 24)
    -- 24 (header) + 4 margin = 28
    search.Position = UDim2.new(0, 0, 0, 28)
    search.BackgroundColor3 = Color3.fromRGB(18,18,18)
    search.PlaceholderText = "Search..."
    search.ClearTextOnFocus = false
    search.Font = Enum.Font.Gotham
    search.TextSize = 12
    search.TextXAlignment = Enum.TextXAlignment.Center
    search.TextColor3 = Color3.fromRGB(230,230,230)
    search.ZIndex = 100
    search.Parent = panel
    createCorner(search, 6)
    createStroke(search, Color3.fromRGB(60,60,60), 1, 0.6)

    --------------------------------------------------
    -- LIST (DI BAWAH SEARCH)
    --------------------------------------------------
    -- total tinggi header+margin+search+margin = 24 + 4 + 24 + 8 = 60
    local listTopOffset = 60

    local list = Instance.new("ScrollingFrame")
    list.Name = "List"
    list.Size = UDim2.new(1, 0, 1, -listTopOffset)
    list.Position = UDim2.new(0, 0, 0, listTopOffset)
    list.BackgroundTransparency = 1
    list.ScrollBarThickness = 4
    list.ScrollBarImageTransparency = 0
    list.AutomaticCanvasSize = Enum.AutomaticSize.Y
    list.CanvasSize = UDim2.new(0, 0, 0, 0)
    list.ZIndex = 100
    list.Parent = panel

    local layout = Instance.new("UIListLayout")
    layout.FillDirection = Enum.FillDirection.Vertical
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 3)
    layout.Parent = list

    --------------------------------------------------
    -- REBUILD LIST (SAMA KAYAK KODEMU SEBELUMNYA)
    --------------------------------------------------
local function rebuildList()
    currentItems = {}
    keyToLabel   = {}

    -- build items + label map
    local rawItems = getItemsList() or {}
    for _, e in ipairs(rawItems) do
        local k, lbl = normalizeItem(e)
        table.insert(currentItems, { key = k, label = lbl })
        keyToLabel[k] = lbl
    end

    -- clear old list children (buttons/labels/frames)
    for _, c in ipairs(list:GetChildren()) do
        if not c:IsA("UIListLayout") and not c:IsA("UIPadding") then
            c:Destroy()
        end
    end

    local q = (search.Text or ""):lower()

    -- helper: check selected
    local function isSelected(k)
        if mode == "single" then
            return selectedKey == k
        else
            return selectedMap[k] == true
        end
    end

    -- filter + split selected/rest
    local picked, rest = {}, {}
    for _, info in ipairs(currentItems) do
        local lbl = tostring(info.label or "")
        local low = lbl:lower()
        if q == "" or low:find(q, 1, true) then
            if isSelected(info.key) then
                table.insert(picked, info)
            else
                table.insert(rest, info)
            end
        end
    end

    -- optional: sort per group biar rapi
    local function byLabel(a, b)
        return tostring(a.label):lower() < tostring(b.label):lower()
    end
    table.sort(picked, byLabel)
    table.sort(rest, byLabel)

    -- merge: selected dulu
    local ordered = {}
    for _, v in ipairs(picked) do table.insert(ordered, v) end
    for _, v in ipairs(rest)   do table.insert(ordered, v) end

    local idx = 0

    -- render
    for _, info in ipairs(ordered) do
        local k   = info.key
        local lbl = info.label

        idx += 1

        local btnItem = Instance.new("TextButton")
        btnItem.Name = "Item_" .. tostring(k)
        btnItem.AutoButtonColor = false
        btnItem.BackgroundColor3 = Color3.fromRGB(22,22,22)
        btnItem.Size = UDim2.new(1, 0, 0, 22)
        btnItem.Text = "  " .. tostring(lbl)
        btnItem.Font = Enum.Font.Gotham
        btnItem.TextXAlignment = Enum.TextXAlignment.Center
        btnItem.TextSize = 12
        btnItem.TextColor3 = Color3.fromRGB(220,220,220)
        btnItem.LayoutOrder = idx
        btnItem.ZIndex = 101
        btnItem.Parent = list
        createCorner(btnItem, 4)

        local function applyVisual()
            if mode == "single" then
                if selectedKey == k then
                    tweenColor(btnItem, "BackgroundColor3", COLOR_YELLOW)
                    btnItem.TextColor3 = COLOR_PANEL
                else
                    tweenColor(btnItem, "BackgroundColor3", Color3.fromRGB(22,22,22))
                    btnItem.TextColor3 = Color3.fromRGB(220,220,220)
                end
            else
                if selectedMap[k] then
                    tweenColor(btnItem, "BackgroundColor3", COLOR_YELLOW)
                    btnItem.TextColor3 = COLOR_PANEL
                else
                    tweenColor(btnItem, "BackgroundColor3", Color3.fromRGB(22,22,22))
                    btnItem.TextColor3 = Color3.fromRGB(220,220,220)
                end
            end
        end
        applyVisual()

        btnItem.MouseButton1Click:Connect(function()
            if mode == "single" then
                selectedKey = k
                refreshButtonText()
                if onChanged then
                    onChanged("single", selectedKey)
                end
                overlay:Destroy()
            else
                selectedMap[k] = not selectedMap[k]
                refreshButtonText()
                if onChanged then
                    local copy = {}
                    for kk, vv in pairs(selectedMap) do
                        copy[kk] = vv and true or false
                    end
                    onChanged("multi", copy)
                end

                -- biar langsung â€œnaik ke atasâ€ setelah dipilih/dilepas
                rebuildList()
                return
            end

            -- single: juga rebuild biar highlight konsisten (optional)
            -- rebuildList()
        end)
    end
end


    search:GetPropertyChangedSignal("Text"):Connect(rebuildList)

    --------------------------------------------------
    -- CLOSE HANDLER (X & KLIK DI LUAR PANEL)
    --------------------------------------------------
    local UserInputService = game:GetService("UserInputService")

    local function closeOverlay()
        if overlay and overlay.Parent then
            overlay:Destroy()
        end
    end

    closeBtn.MouseButton1Click:Connect(closeOverlay)

    overlay.MouseButton1Click:Connect(function()
        local mousePos = UserInputService:GetMouseLocation()
        local pPos = panel.AbsolutePosition
        local pSize = panel.AbsoluteSize

        local x, y = mousePos.X, mousePos.Y
        local insideX = x >= pPos.X and x <= pPos.X + pSize.X
        local insideY = y >= pPos.Y and y <= pPos.Y + pSize.Y

        -- kalau klik di LUAR panel â†’ close, kalau di dalam panel â†’ abaikan
        if not (insideX and insideY) then
            closeOverlay()
        end
    end)

    search.Text = ""
    rebuildList()
end




    button.MouseEnter:Connect(function()
        tweenColor(button, "BackgroundColor3", Color3.fromRGB(24,24,24))
    end)
    button.MouseLeave:Connect(function()
        tweenColor(button, "BackgroundColor3", Color3.fromRGB(18,18,18))
    end)
    button.MouseButton1Click:Connect(openDropdown)

    refreshButtonText()

    local api = {}

    function api.getMode()
        return mode
    end

    function api.setMode(newMode)
        if newMode == "multi" then
            mode = "multi"
        else
            mode = "single"
        end
        refreshButtonText()
    end

    function api.setSelected(value)
        if mode == "single" then
            selectedKey = value and tostring(value) or nil
        else
            selectedMap = {}
            if type(value) == "table" then
                for k, v in pairs(value) do
                    if v then
                        selectedMap[tostring(k)] = true
                    end
                end
            end
        end
        refreshButtonText()
    end

    function api.getSelected()
        if mode == "single" then
            return selectedKey
        else
            local copy = {}
            for k, v in pairs(selectedMap) do
                if v then copy[k] = true end
            end
            return copy
        end
    end

    function api.refreshLabel()
        refreshButtonText()
    end

    return row, api
end

function MainUI:OpenModePicker(items, currentId, onChosen)
    -- items: { {id="auto", label="AUTO - ..."}, ... }
    -- currentId: string (misal "auto")
    -- onChosen(id): callback

    -- ROOT GUI (bukan cuma panel kanan)


    local parentGui = self._sg or PlayerGui   -- â¬…ï¸ ScreenGui
    local parentFrame = parentGui             -- â¬…ï¸ pakai ini, bukan self.right

    --------------------------------------------------
    -- OVERLAY DI DALAM ROOT UI
    --------------------------------------------------
    local overlay = Instance.new("TextButton")
    overlay.Name = "NodeHubModeOverlay"
    overlay.BackgroundColor3 = Color3.fromRGB(0,0,0)
    overlay.BackgroundTransparency = 0.25
    overlay.AutoButtonColor = false
    overlay.BorderSizePixel = 0
    overlay.Text = ""
    overlay.Size = UDim2.new(1, 0, 1, 0)         -- full screen
    overlay.Position = UDim2.new(0, 0, 0, 0)
    overlay.ZIndex = 98
    overlay.Active = true
    overlay.Parent = parentGui     

    --------------------------------------------------
    -- PANEL TENGAH
    --------------------------------------------------
    local panel = Instance.new("Frame")
    panel.Name = "ModePanel"
    panel.Size = UDim2.new(0, 300, 0, 260) -- lebar default, nanti diubah
    panel.AnchorPoint = Vector2.new(0.5, 0.5)
    panel.Position = UDim2.new(0.5, 0, 0.5, 0)
    panel.BackgroundColor3 = COLOR_PANEL
    panel.ZIndex = 99
    panel.Active = true
    panel.Parent = overlay
    createCorner(panel, 10)
    createStroke(panel, COLOR_YELLOW, 1, 0.3)

    local pad = Instance.new("UIPadding")
    pad.PaddingTop    = UDim.new(0, 8)
    pad.PaddingBottom = UDim.new(0, 8)
    pad.PaddingLeft   = UDim.new(0, 8)
    pad.PaddingRight  = UDim.new(0, 8)
    pad.Parent = panel

    --------------------------------------------------
    -- CLOSE BUTTON
    --------------------------------------------------
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 22, 0, 22)
    closeBtn.AnchorPoint = Vector2.new(1, 0)
    closeBtn.Position = UDim2.new(1, 2, 0, 0)
    closeBtn.BackgroundColor3 = Color3.fromRGB(18,18,18)
    closeBtn.AutoButtonColor = false
    closeBtn.BorderSizePixel = 0
    closeBtn.Text = "X"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 12
    closeBtn.TextColor3 = COLOR_WHITE
    closeBtn.ZIndex = 101
    closeBtn.Parent = panel
    createCorner(closeBtn, 6)
    createStroke(closeBtn, COLOR_YELLOW, 1, 0.4)

    --------------------------------------------------
    -- TITLE + SEARCH
    --------------------------------------------------
    local title = Instance.new("TextLabel")
    title.BackgroundTransparency = 1
    title.Size = UDim2.new(1, -24, 0, 20)
    title.Position = UDim2.new(0, 0, 0, 0)
    title.Font = Enum.Font.GothamBold
    title.TextSize = 13
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextColor3 = COLOR_YELLOW
    title.Text = "Select Auto KG Stage Mode"
    title.ZIndex = 100
    title.Parent = panel

    local search = Instance.new("TextBox")
    search.Name = "SearchBox"
    search.Size = UDim2.new(1, 0, 0, 24)
    search.Position = UDim2.new(0, 0, 0, 24)
    search.BackgroundColor3 = Color3.fromRGB(18,18,18)
    search.PlaceholderText = "Search..."
    search.ClearTextOnFocus = false
    search.Font = Enum.Font.Gotham
    search.TextSize = 12
    search.TextXAlignment = Enum.TextXAlignment.Center
    search.TextColor3 = Color3.fromRGB(230,230,230)
    search.ZIndex = 100
    search.Parent = panel
    createCorner(search, 6)
    createStroke(search, Color3.fromRGB(60,60,60), 1, 0.6)

    --------------------------------------------------
    -- LIST
    --------------------------------------------------
    local list = Instance.new("ScrollingFrame")
    list.Name = "List"
    list.Size = UDim2.new(1, 0, 1, -56)
    list.Position = UDim2.new(0, 0, 0, 52)
    list.BackgroundTransparency = 1
    list.ScrollBarThickness = 4
    list.ScrollBarImageTransparency = 0
    list.AutomaticCanvasSize = Enum.AutomaticSize.Y
    list.CanvasSize = UDim2.new(0, 0, 0, 0)
    list.ZIndex = 100
    list.Parent = panel

    local layout = Instance.new("UIListLayout")
    layout.FillDirection = Enum.FillDirection.Vertical
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.Padding = UDim.new(0, 3)
    layout.Parent = list

    --------------------------------------------------
    -- CLOSE HANDLER
    --------------------------------------------------
    local function closeOverlay()
        if overlay and overlay.Parent then
            overlay:Destroy()
        end
    end

    closeBtn.MouseButton1Click:Connect(closeOverlay)

    local UIS = game:GetService("UserInputService")
    overlay.MouseButton1Click:Connect(function()
        local mp   = UIS:GetMouseLocation()
        local pPos = panel.AbsolutePosition
        local pSz  = panel.AbsoluteSize

        local insideX = mp.X >= pPos.X and mp.X <= pPos.X + pSz.X
        local insideY = mp.Y >= pPos.Y and mp.Y <= pPos.Y + pSz.Y
        if not (insideX and insideY) then
            closeOverlay()
        end
    end)

    --------------------------------------------------
    -- HITUNG LEBAR PANEL DARI TEKS TERPANJANG
    --------------------------------------------------
    --------------------------------------------------
-- HITUNG LEBAR PANEL DARI TEKS TERPANJANG
--------------------------------------------------
local function resizePanelWidthFromItems()
    if not TextService or not TextService.GetTextSize then
        panel.Size = UDim2.new(0, 300, 0, 260)
        return
    end

    local maxWidth  = 0
    local font      = Enum.Font.Gotham
    local textSize  = 11

    for _, opt in ipairs(items or {}) do
        local id   = tostring(opt.id)
        local text = opt.label or id
        local full = string.format("  [%s]  %s", id, text)

        local bounds = TextService:GetTextSize(
            full,
            textSize,
            font,
            Vector2.new(10000, 24)
        )

        if bounds.X > maxWidth then
            maxWidth = bounds.X
        end
    end

    -- hitung padding kiri/kanan dari UIPadding panel
    local padLeft  = pad and pad.PaddingLeft and pad.PaddingLeft.Offset or 0
    local padRight = pad and pad.PaddingRight and pad.PaddingRight.Offset or 0

    -- sedikit margin ekstra di kiri/kanan button
    local extraMargin = 15

    local desiredWidth = maxWidth + padLeft + padRight + extraMargin

    -- MIN & MAX LEBAR PANEL
    desiredWidth = math.clamp(desiredWidth, 340, 680)

    -- tinggi tetap 260
    panel.Size = UDim2.new(0, desiredWidth, 0, 290)
end


    resizePanelWidthFromItems()

    --------------------------------------------------
    -- REBUILD LIST
    --------------------------------------------------
    local function rebuildList()
        for _, c in ipairs(list:GetChildren()) do
            if c:IsA("TextButton") then
                c:Destroy()
            end
        end

        local q   = string.lower(search.Text or "")
        local idx = 0
        local cur = tostring(currentId or "")

        for _, opt in ipairs(items or {}) do
            local id   = tostring(opt.id)
            local text = opt.label or id
            local low  = string.lower(text)

            if q == "" or string.find(low, q, 1, true) then
                idx += 1

                local btn = Instance.new("TextButton")
                btn.Name = "Item_" .. id
                btn.AutoButtonColor = false
                btn.BackgroundColor3 = (id == cur)
                    and COLOR_YELLOW
                    or Color3.fromRGB(22,22,22)

                btn.Size = UDim2.new(1, 0, 0, 24)
                btn.Text = string.format("  %s", text)
                btn.Font = Enum.Font.Gotham
                btn.TextXAlignment = Enum.TextXAlignment.Left
                btn.TextSize = 12
                btn.TextColor3 = (id == cur)
                    and COLOR_PANEL
                    or Color3.fromRGB(220,220,220)
                btn.LayoutOrder = idx
                btn.ZIndex = 101

                -- jangan di-"..." (biar full, panel sudah dilebarkan)
                btn.TextTruncate = Enum.TextTruncate.None

                btn.Parent = list
                createCorner(btn, 4)

                btn.MouseButton1Click:Connect(function()
                    currentId = id
                    if onChosen then
                        onChosen(id)
                    end
                    closeOverlay()
                end)
            end
        end
    end

    search:GetPropertyChangedSignal("Text"):Connect(rebuildList)
    search.Text = ""
    rebuildList()
end


-- ======================
-- API: FOOTER BUTTONS
-- ======================
-- list: {
--   { text="START", kind="primary"/"danger"/"normal", order=1, onClick=function() end },
--   ...
-- }
-- RENDER FOOTER DARI LIST
-- ======================
-- API: FOOTER BUTTONS
-- ======================
-- list: {
--   { text="START", kind="primary"/"danger"/"normal", order=1, onClick=function() end },
--   ...
-- }
local TweenService = game:GetService("TweenService")
local RunService   = game:GetService("RunService")

local RUN_STROKE_NAME = "__RUN_ELECTRIC_STROKE"
local RUN_GRAD_NAME   = "__RUN_ELECTRIC_GRAD"
local RUN_TOKEN_ATTR  = "__RUN_ELECTRIC_TOKEN"

function MainUI:_applyRunningStyle(btn, isRunning)
    if not (btn and btn:IsA("GuiObject")) then return end

    -- STOP: cleanup
    if not isRunning then
        btn:SetAttribute(RUN_TOKEN_ATTR, nil)
        local st = btn:FindFirstChild(RUN_STROKE_NAME)
        if st then st:Destroy() end
        return
    end

    -- ensure stroke
    local st = btn:FindFirstChild(RUN_STROKE_NAME)
    if not st then
        st = Instance.new("UIStroke")
        st.Name = RUN_STROKE_NAME
        st.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
        st.Thickness = 2
        st.Transparency = 0.08
        st.Color = Color3.fromRGB(255, 217, 0) -- kuning NodeHub
        st.Parent = btn
    end

    -- ensure gradient (kilat)
    local grad = st:FindFirstChild(RUN_GRAD_NAME)
    if not grad then
        grad = Instance.new("UIGradient")
        grad.Name = RUN_GRAD_NAME
        grad.Rotation = 0
        grad.Parent = st

        -- Pola "electric": gelap â†’ terang â†’ putih â†’ terang â†’ gelap
        grad.Color = ColorSequence.new({
            ColorSequenceKeypoint.new(0.00, Color3.fromRGB(120, 90, 0)),
            ColorSequenceKeypoint.new(0.40, Color3.fromRGB(255, 217, 0)),
            ColorSequenceKeypoint.new(0.50, Color3.fromRGB(255, 255, 230)),
            ColorSequenceKeypoint.new(0.60, Color3.fromRGB(255, 217, 0)),
            ColorSequenceKeypoint.new(1.00, Color3.fromRGB(120, 90, 0)),
        })
    end

    -- anti double-loop: token unik
    local token = tostring(os.clock()) .. "_" .. tostring(math.random(1, 1e9))
    btn:SetAttribute(RUN_TOKEN_ATTR, token)

    -- Gerak listrik: rotation cepat + jitter + flicker
    task.spawn(function()
        local baseThickness = 1
        local baseTrans     = 0.08
        local rot = 0

        while btn.Parent and btn:GetAttribute(RUN_TOKEN_ATTR) == token do
            -- rotasi cepat (arus berjalan)
            rot = (rot + 35 + math.random(-6, 6)) % 360
            grad.Rotation = rot

            -- jitter kilat: kadang loncat lebih cepat
            if math.random() < 0.18 then
                grad.Rotation = (grad.Rotation + math.random(40, 120)) % 360
            end

            -- flicker transparency (kedip halus)
            if math.random() < 0.22 then
                st.Transparency = math.clamp(baseTrans + (math.random() * 0.20), 0, 0.35)
            else
                st.Transparency = baseTrans
            end

            -- â€œsnapâ€ ketebalan kayak setrum
            if math.random() < 0.16 then
                st.Thickness = baseThickness + 1
            else
                st.Thickness = baseThickness
            end

            task.wait(0.1 + math.random() * 0.02) -- cepat = listrik
        end
    end)
end

function MainUI:_startFooterRunningWatcher()
    if self.__footerRunWatcherStarted then return end
    self.__footerRunWatcherStarted = true

    task.spawn(function()
        local last = nil
        while self and self.mainFrame and self.mainFrame.Parent do
            local loop = rawget(_G, "AutoKGLoop")
            local running = false
            if loop and type(loop.IsRunning) == "function" then
                local ok, v = pcall(loop.IsRunning)
                running = (ok and v == true) or false
            end

            if running ~= last then
                last = running

                -- tombol start (pakai key yang konsisten)
                local btn = self.footerButtons and (self.footerButtons["START"] or self.footerButtons["Start"])
                if btn then
                    self:_applyRunningStyle(btn, running)
                    -- optional: ubah teks juga
                    btn.Text = running and "RUNNING" or "START"
                end
            end

            task.wait(0.25)
        end
    end)
end



function MainUI:_renderFooter(list)
    -- bersihkan footer lama
    for _, child in ipairs(self.footer:GetChildren()) do
        if child:IsA("TextButton") then
            child:Destroy()
        end
    end
    self.footerButtons = {}

    -- cek apakah ada tombol footer?
    local hasButtons = (type(list) == "table" and #list > 0)

    -- kalau TIDAK ADA tombol â†’ sembunyikan footer & panjangkan content
    if not hasButtons then
        -- hide footer bar
        if self.footer then
            self.footer.Visible = false
        end

        -- panjangkan content sampai bawah (pakai preset no-footer kalau ada)
        if self._contentSizeNoFooter then
            self.content.Size = self._contentSizeNoFooter
        end

        return
    end

    -- kalau ADA tombol â†’ footer kelihatan & content pakai size normal
    if self.footer then
        self.footer.Visible = true
    end
    if self._contentSizeWithFooter then
        self.content.Size = self._contentSizeWithFooter
    end

    --------------------------------------------------
    -- render tombol seperti biasa
    --------------------------------------------------
    for idx, def in ipairs(list) do
        local kind = def.kind or "normal"
        local text = def.text or ("Btn" .. idx)

        local bgColor  = COLOR_PANEL
        local txtColor = COLOR_WHITE
        local strokeT  = 1
        local strokeTr = 0.4
        local width    = 80

        if kind == "primary" then
            bgColor  = COLOR_YELLOW
            txtColor = COLOR_PANEL
            strokeT  = 2
            strokeTr = 0.1
            width    = 120
        elseif kind == "danger" then
            bgColor  = Color3.fromRGB(80, 0, 0)
            txtColor = COLOR_WHITE
            strokeT  = 2
            strokeTr = 0.1
            width    = 90
        end

        local btn = Instance.new("TextButton")
        btn.Size = UDim2.new(0, width, 1, 0)
        btn.AutoButtonColor = false
        btn.BackgroundColor3 = bgColor
        btn.Text = text
        btn.TextSize = 12
        btn.Font = Enum.Font.GothamBold
        btn.TextColor3 = txtColor
        btn.LayoutOrder = def.order or idx
        btn.Parent = self.footer
        -- apply running style kalau def.running true
self:_applyRunningStyle(btn, def.running == true)

        createCorner(btn, 999)
        createStroke(btn, COLOR_YELLOW, strokeT, strokeTr)

        if def.onClick then
            btn.MouseButton1Click:Connect(def.onClick)
        end

        local key = def.key or text
self.footerButtons[key] = btn

        
        if def.onReady then
            pcall(def.onReady, btn)
        end
        self:_startFooterRunningWatcher()

    end
end


-- DEFAULT FOOTER (berlaku global jika tidak ada override per-tab)
function MainUI:SetFooterButtons(list)
    self.footerConfig.default = list
    -- kalau belum ada main tab aktif, render langsung
    if not self.activeMainKey then
        self:_renderFooter(list)
    else
        -- kalau tab aktif belum punya footer khusus, pakai default
        if not self.footerConfig[self.activeMainKey] then
            self:_renderFooter(list)
        end
    end
end

-- FOOTER KHUSUS UNTUK MAIN TAB TERTENTU
function MainUI:SetFooterButtonsFor(mainKey, list)
    self.footerConfig[mainKey] = list
    if self.activeMainKey == mainKey then
        self:_renderFooter(list)
    end
end

function MainUI:_setMinimized(state)
    state = state and true or false
    self.isMinimized = state

    if state then
        -- MINIMIZE: tutup panel utama, buka icon
        if self.overlay then
            self.overlay.Visible = false
        end
        if self.mainFrame then
            self.mainFrame.Visible = false
        end
        if self._miniBtn then
            self._miniBtn.Visible = true
        end
    else
        -- RESTORE: buka panel utama, tutup icon
        if self.overlay then
            self.overlay.Visible = true
        end
        if self.mainFrame then
            self.mainFrame.Visible = true
        end
        if self._miniBtn then
            self._miniBtn.Visible = false
        end
    end
end

function MainUI:Minimize()
    self:_setMinimized(true)
end

function MainUI:Restore()
    self:_setMinimized(false)
end
end -- End of if false
-- tabs_autokg.lua
-- Main tab "Auto KG" â†’ sub tab:
--   noos, boost, xp, seratusage, gbxp, settingkg(âš™)
--
-- âœ… Fitur:
-- - Summary auto update global (walau tab lain sedang dibuka)
-- - List bisa auto update (pakai listApi("setItems") + listApi("setSelected"))
-- - GBXP auto-select kandidat baru (reconcile periodik, bukan seed sekali)
-- - Footer: Mode picker + Start/Stop (GBXP_STAGE_MODE)

local M = {}

function M.Register(ui, STATE, PetListView)
    ----------------------------------------------------------------
    -- SAFETY DEFAULTS
    ----------------------------------------------------------------
    PetListView = PetListView or {
        buildEntriesForTab = function() return {} end,
        listPetsForTab     = function() return {} end,
        listAllMutations   = function() return {} end,
        buildPetItems      = function() return {} end,
        buildPetBoostItems = function() return {} end,
    }

    STATE = STATE or {}

    ----------------------------------------------------------------
    -- helper autosave: pakai ui:SaveState() dari main.lua
    ----------------------------------------------------------------
    local function autoSave()
        if ui and type(ui.SaveState) == "function" then
            task.defer(function()
                local ok, err = pcall(function()
                    ui:SaveState()
                end)
                if not ok then
                    warn("[AutoKG] Gagal ui:SaveState():", err)
                end
            end)
        else
            warn("[AutoKG] ui.SaveState() tidak tersedia, perubahan TIDAK di-persist.")
        end
    end

    ----------------------------------------------------------------
    -- GLOBALS yang dipakai state.lua
    ----------------------------------------------------------------
    selected = selected or {
        boost      = {},
        xp         = {},
        noos       = {},
        seratusage = {},
        gbxp       = {},
    }

    TAB_AGE_EQUIP_MIN   = TAB_AGE_EQUIP_MIN   or {}
    TAB_AGE_UNEQUIP_MIN = TAB_AGE_UNEQUIP_MIN or {}
    TAB_W_EQUIP_MIN     = TAB_W_EQUIP_MIN     or {}
    TAB_W_UNEQUIP_MAX   = TAB_W_UNEQUIP_MAX   or {}

    local ALL_TABS = { "noos", "boost", "seratusage", "xp", "gbxp" }

    local function ensureTabDefaults(tabKey)
        TAB_AGE_EQUIP_MIN[tabKey]   = tonumber(TAB_AGE_EQUIP_MIN[tabKey])   or 0
        TAB_AGE_UNEQUIP_MIN[tabKey] = tonumber(TAB_AGE_UNEQUIP_MIN[tabKey]) or 0

        TAB_W_EQUIP_MIN[tabKey]     = tonumber(TAB_W_EQUIP_MIN[tabKey])     or 0
        TAB_W_UNEQUIP_MAX[tabKey]   = tonumber(TAB_W_UNEQUIP_MAX[tabKey])   or 999999

        selected[tabKey] = selected[tabKey] or {}
    end

    for _, k in ipairs(ALL_TABS) do
        ensureTabDefaults(k)
    end

    ----------------------------------------------------------------
    -- UI REGISTRY (biar bisa update walau tab lain aktif)
    ----------------------------------------------------------------
    local UIREF = {
        tabs = {},         -- [tabKey] = { listApi=..., selSet=... }
        summaryTitles = {},-- [tabKey] = summaryTitle
    }

    ----------------------------------------------------------------
    -- Helper: hitung total selected & bikin teks summary
    ----------------------------------------------------------------
    local function countSelected(setTbl)
        local n = 0
        if type(setTbl) == "table" then
            for _, on in pairs(setTbl) do
                if on then n += 1 end
            end
        end
        return n
    end

    local function buildSummaryText()
        local cNoos  = countSelected(selected.noos)
        local cBoost = countSelected(selected.boost)
        local c100   = countSelected(selected.seratusage)
        local cXP    = countSelected(selected.xp)
        local cGBXP  = countSelected(selected.gbxp)

        return string.format(
            "ðŸ˜ Elephant (%d)    ðŸŒ™ Nightmare (%d)    ðŸ’¯ 100 Age (%d)    ðŸ“˜ XP (%d)    ðŸ§ª GBXP (%d)",
            cNoos, cBoost, c100, cXP, cGBXP
        )
    end

    local function refreshAllSummary()
        local txt = buildSummaryText()
        for _, title in pairs(UIREF.summaryTitles) do
            if title and title.Parent then
                title.Text = txt
            end
        end
    end

    ----------------------------------------------------------------
    -- LIST REFRESH (butuh CreateRowList API setItems & setSelected)
    ----------------------------------------------------------------
    local function refreshTabList(tabKey)
        local ref = UIREF.tabs[tabKey]
        if not ref or not ref.listApi or type(ref.listApi) ~= "function" then
            return
        end

        local entries = {}
        local ok, res = pcall(function()
            return PetListView.buildEntriesForTab(tabKey, ref.selSet)
        end)
        if ok and type(res) == "table" then
            entries = res
        end

        pcall(function()
            ref.listApi("setItems", entries)
        end)

        local map = {}
        for uuid, on in pairs(ref.selSet or {}) do
            if on then map[uuid] = true end
        end
        pcall(function()
            ref.listApi("setSelected", map)
        end)
    end

    ----------------------------------------------------------------
    -- AUTO SELECT GBXP (reconcile periodik)
    ----------------------------------------------------------------
    if STATE.gbxpAutoSelect == nil then
        STATE.gbxpAutoSelect = true
    end

    local function reconcileGBXP()
        if STATE.gbxpAutoSelect ~= true then
            return
        end

        selected.gbxp = selected.gbxp or {}

        local ok, pets = pcall(function()
            return PetListView.listPetsForTab("gbxp")
        end)
        if not ok or type(pets) ~= "table" then
            return
        end

        local changed = false
        for _, p in ipairs(pets) do
            local uuid = p and p.uuid
            if uuid and not selected.gbxp[uuid] then
                selected.gbxp[uuid] = true
                changed = true
            end
        end

        if changed then
            autoSave()
            refreshAllSummary()
            refreshTabList("gbxp")
        end
    end

    ----------------------------------------------------------------
    -- MAIN TAB: Auto KG
    ----------------------------------------------------------------
    ui:RegisterMainTab("autokg", "Auto KG", 1)

    ----------------------------------------------------------------
    -- Helper: bangun satu sub-tab AutoKG generik
    ----------------------------------------------------------------
    local function buildAutoKGSubTab(tabKey, niceName, order)
        ui:RegisterSubTab("autokg", tabKey, niceName, function()
            ui:ClearSubContent()

            ensureTabDefaults(tabKey)

            -- list untuk menyimpan setter setiap section
            local sectionSetters = {}
            local function createSection(title)
                local body, setExpanded = ui:CreateSection(title, true)
                table.insert(sectionSetters, setExpanded)
                return body
            end

            --------------------------------------------------------
            -- SECTION: Threshold Age & KG untuk tab ini
            --------------------------------------------------------
            local sectionTitle = string.format("( %s Team ) Threshold Age & Kg", niceName)
            local body = createSection(sectionTitle)

            local selSet = selected[tabKey]

            --------------------------------------------------------
            -- ROW LABEL: SUMMARY TOTAL SEMUA TAB
            --------------------------------------------------------
            local summaryRow, summaryTitle
            if ui.CreateRowLabel then
                summaryRow, summaryTitle = ui:CreateRowLabel(body, buildSummaryText())
            else
                local row = Instance.new("Frame")
                row.Name = "Row_Summary"
                row.BackgroundTransparency = 1
                row.Size = UDim2.new(1, 0, 0, 20)
                row.Parent = body

                local txt = Instance.new("TextLabel")
                txt.BackgroundTransparency = 1
                txt.Size = UDim2.new(1, 0, 1, 0)
                txt.Font = Enum.Font.GothamSemibold
                txt.TextSize = 12
                txt.TextXAlignment = Enum.TextXAlignment.Left
                txt.TextColor3 = Color3.fromRGB(255, 230, 120)
                txt.TextWrapped = true
                txt.Text = buildSummaryText()
                txt.Parent = row

                summaryRow   = row
                summaryTitle = txt
            end

            if summaryTitle then
                summaryTitle.TextColor3 = Color3.fromRGB(255, 230, 120)
                summaryTitle.Font       = Enum.Font.GothamSemibold
                summaryTitle.TextSize   = 12
                summaryTitle.TextWrapped = true
            end

            -- register summary title untuk global refresh
            UIREF.summaryTitles[tabKey] = summaryTitle

            --------------------------------------------------------
            -- 1) Equip Age
            --------------------------------------------------------
            ui:CreateRowInput(body, "Equip Age", tostring(TAB_AGE_EQUIP_MIN[tabKey]), function(text)
                local v = tonumber(text)
                if v then
                    TAB_AGE_EQUIP_MIN[tabKey] = v
                    autoSave()
                else
                    warn(string.format("[AutoKG/%s] Equip Age tidak valid: %s", tabKey, text))
                end
            end)

            --------------------------------------------------------
            -- 2) Unequip Age
            --------------------------------------------------------
            ui:CreateRowInput(body, "Unequip Age", tostring(TAB_AGE_UNEQUIP_MIN[tabKey]), function(text)
                local v = tonumber(text)
                if v then
                    TAB_AGE_UNEQUIP_MIN[tabKey] = v
                    autoSave()
                else
                    warn(string.format("[AutoKG/%s] Unequip Age tidak valid: %s", tabKey, text))
                end
            end)

            --------------------------------------------------------
            -- 3) Equip W100 Min
            --------------------------------------------------------
            ui:CreateRowInput(body, "Equip When KG Min ( Assumed at age 100 )", tostring(TAB_W_EQUIP_MIN[tabKey]), function(text)
                local v = tonumber(text)
                if v then
                    TAB_W_EQUIP_MIN[tabKey] = v
                    autoSave()
                else
                    warn(string.format("[AutoKG/%s] Equip W100 Min tidak valid: %s", tabKey, text))
                end
            end)

            --------------------------------------------------------
            -- 4) Unequip W100 Max
            --------------------------------------------------------
            ui:CreateRowInput(body, "Unequip When KG Max ( Assumed at age 100 )", tostring(TAB_W_UNEQUIP_MAX[tabKey]), function(text)
                local v = tonumber(text)
                if v then
                    TAB_W_UNEQUIP_MAX[tabKey] = v
                    autoSave()
                else
                    warn(string.format("[AutoKG/%s] Unequip W100 Max tidak valid: %s", tabKey, text))
                end
            end)
            
            --------------------------------------------------------
-- GBXP: Max Equip
--------------------------------------------------------
if tabKey == "gbxp" then
    GBXP_MAX_EQUIP = tonumber(GBXP_MAX_EQUIP) or 2

    ui:CreateRowInput(body, "GBXP Max Equip", tostring(GBXP_MAX_EQUIP), function(text)
        local v = tonumber(text)
        if v then
            -- clamp biar aman (optional)
            if v < 1 then v = 1 end
            if v > 8 then v = 8 end

            GBXP_MAX_EQUIP = v
            autoSave()

            -- kalau kamu mau trigger refresh loop lain:
            _G.__AUTOKG_DIRTY = true
        else
            warn("[AutoKG/gbxp] GBXP Max Equip tidak valid:", text)
        end
    end)
end


            --------------------------------------------------------
            -- LIST: Daftar Pet untuk tab ini
            --------------------------------------------------------
            local listLabel
            if tabKey == "gbxp" then
                listLabel = "Select Pet GBXP (Non Favorite)"
            elseif tabKey == "noos" then
                listLabel = "Select Pet Elephant Team (Favorite List)"
            elseif tabKey == "boost" then
                listLabel = "Select Pet Nightmare Team (Favorite List)"
            elseif tabKey == "xp" then
                listLabel = "Select Pet XP Team (Favorite List)"
            elseif tabKey == "seratusage" then
                listLabel = "Select Pet 100 Age Team (Favorite List)"
            else
                listLabel = "Select Pet"
            end

            local entries = {}
            local okE, resE = pcall(function()
                return PetListView.buildEntriesForTab(tabKey, selSet)
            end)
            if okE and type(resE) == "table" then
                entries = resE
            end

            local _, listApi = ui:CreateRowList(body, listLabel, entries, function(key, on, label)
                if on then
                    selSet[key] = true
                else
                    selSet[key] = nil
                end
                autoSave()
                refreshAllSummary()
            end)

            -- register list api untuk refresh
            UIREF.tabs[tabKey] = {
                listApi = listApi,
                selSet  = selSet,
            }

            -- set selected awal
            local preSelected = {}
            for uuid, on in pairs(selSet) do
                if on then preSelected[uuid] = true end
            end
            pcall(function()
                listApi("setSelected", preSelected)
            end)

            -- refresh summary pertama kali
            refreshAllSummary()

            --------------------------------------------------------
            -- Section open/close default
            --------------------------------------------------------
            if #sectionSetters == 1 then
                sectionSetters[1](true)
            else
                for _, fn in ipairs(sectionSetters) do
                    fn(false)
                end
            end
        end, order)
    end

    ----------------------------------------------------------------
    -- REGISTER SUB TAB TEAM
    ----------------------------------------------------------------
    buildAutoKGSubTab("noos",       "Elephant",  1)
    buildAutoKGSubTab("boost",      "Nightmare", 2)
    buildAutoKGSubTab("seratusage", "100 Age",   3)
    buildAutoKGSubTab("xp",         "XP",        4)
    buildAutoKGSubTab("gbxp",       "GBXP",      5)

    ----------------------------------------------------------------
    -- SUB TAB: settingkg (âš™)
    ----------------------------------------------------------------
    ui:RegisterSubTab("autokg", "settingkg", "âš™", function()
        ui:ClearSubContent()

        local sectionSetters = {}
        local function createSection(title)
            local body, setExpanded = ui:CreateSection(title, true)
            table.insert(sectionSetters, setExpanded)
            return body
        end

        -- sync toggle mutation dari global yang di-load state.lua
        if STATE.autokgMutationEnabled == nil then
            STATE.autokgMutationEnabled = (AUTOKG_MUTATION_ENABLED == true)
        end

        if STATE.autoBoostEnabled == nil then
            STATE.autoBoostEnabled = (AUTO_BOOST_ENABLED == true)
        end

        local body1 = createSection("Auto Shard Cleaner")
        local body2 = createSection("Auto Boost")
        local body3 = createSection(" Auto Feed (Fruit)")
        local body4 = createSection("Auto Collect (Fruit)")
        

        ------------------------------------------------------
        -- MUTATION DROPDOWN
        ------------------------------------------------------
        local mutationItems = {}
        do
            local mutList = {}
            local ok, res = pcall(function()
                return PetListView.listAllMutations()
            end)
            if ok and type(res) == "table" then
                mutList = res
            end

            for _, mutName in ipairs(mutList) do
                table.insert(mutationItems, { key = mutName, name = mutName })
            end
        end

        ui:CreateRowDropdown(body1, {
            label       = "Select Mutation to Maintain / Keep",
            placeholder = "Select Mutation...",
            mode        = "multi",
            getItems    = function() return mutationItems end,
            initial     = GBXP_MUT_SELECTED or {},
            onChanged   = function(mode, selectedMap)
                GBXP_MUT_SELECTED = {}
                if type(selectedMap) == "table" then
                    for mutName, on in pairs(selectedMap) do
                        if on then
                            GBXP_MUT_SELECTED[mutName] = true
                        end
                    end
                end
                autoSave()
            end,
        })

        ui:CreateRowToggle(
            body1,
            "Auto Shard Cleaner ( Mutations not selected above will be Cleaned )",
            STATE.autokgMutationEnabled,
            function(isOn)
                STATE.autokgMutationEnabled = isOn and true or false
                AUTOKG_MUTATION_ENABLED     = STATE.autokgMutationEnabled

                pcall(function()
                    if _G.WorldShardCleaner and _G.WorldShardCleaner.setEnabled then
                        _G.WorldShardCleaner:setEnabled(STATE.autokgMutationEnabled)
                    end
                end)

                autoSave()
            end
        )

        ------------------------------------------------------
        -- AUTO BOOST (pet types + boost item)
        ------------------------------------------------------
        SELECTED_PET_TYPES = SELECTED_PET_TYPES or {}
        PETBOOST_SELECTED  = PETBOOST_SELECTED  or {}

        local PetItems = {}
        local PetBoostItems = {}
        pcall(function()
            PetItems = PetListView.buildPetItems() or {}
        end)
        pcall(function()
            PetBoostItems = PetListView.buildPetBoostItems() or {}
        end)

        ui:CreateRowDropdown(body2, {
            label       = "Select Pet To Boost",
            placeholder = "Select Pet...",
            mode        = "multi",
            getItems    = function() return PetItems end,
            initial     = SELECTED_PET_TYPES or {},
            onChanged   = function(mode, selectedMap)
                SELECTED_PET_TYPES = {}
                for petName, enabled in pairs(selectedMap or {}) do
                    if enabled then
                        SELECTED_PET_TYPES[petName] = true
                    end
                end
                autoSave()
            end,
        })

        ui:CreateRowDropdown(body2, {
            label       = "Select Pet Boost Item",
            placeholder = "Select Boost...",
            mode        = "multi",
            getItems    = function() return PetBoostItems end,
            initial     = PETBOOST_SELECTED or {},
            onChanged   = function(mode, selectedMap)
                PETBOOST_SELECTED = {}
                for uuid, enabled in pairs(selectedMap or {}) do
                    if enabled then
                        PETBOOST_SELECTED[uuid] = true -- simpan UUID saja
                    end
                end
                autoSave()
            end,
        })
    
    
ui:CreateRowInput(body2, "Delay Boost ( Sec )", tostring(AUTO_BOOST_DELAY or 20), function(text)
    text = tostring(text or ""):gsub("%s+", "")
    if text == "" then
        return -- biarin, jangan spam warn saat user hapus lalu ketik lagi
    end

    local v = tonumber(text)
    if not v or v <= 0 then
        warn("[AutoBoost] Delay Boost tidak valid: " .. tostring(text))
        return
    end

    -- optional: bulatkan biar delay rapi & konsisten
    v = math.floor(v + 0.5)

    AUTO_BOOST_DELAY = v
    local G = (getgenv and getgenv()) or _G
    G.AUTO_BOOST_DELAY = v

    -- âœ… prioritas: setDelay (update tanpa restart)
    local BoostModule = _G.AutoKGBoost
    if BoostModule then
        pcall(function()
            if type(BoostModule.setDelay) == "function" then
                BoostModule.setDelay(v)         -- kalau fungsi biasa (.)
            elseif type(BoostModule.SetDelay) == "function" then
                BoostModule.SetDelay(v)
            elseif type(BoostModule.setDelay) == "function" then
                BoostModule:setDelay(v)         -- kalau method (:)
            elseif type(BoostModule.SetDelay) == "function" then
                BoostModule:SetDelay(v)
            else
                -- fallback property
                BoostModule.delay = v
                BoostModule.DELAY = v
            end
        end)
    end

    -- âœ… autosave agak ditunda biar gak spam writefile pas ngetik
    if ui and type(ui._boostDelaySaveDebounce) ~= "thread" then
        -- nothing
    end
    task.defer(function()
        -- debounce sederhana: tunggu sebentar, kalau nilainya masih sama baru save
        local cur = v
        task.wait(0.35)
        if AUTO_BOOST_DELAY == cur then
            autoSave()
        end
    end)
end)



        local BoostModule = _G.AutoKGBoost

        ui:CreateRowToggle(
            body2,
            "Enable Auto Boost",
            AUTO_BOOST_ENABLED == true,
            function(isOn)
                AUTO_BOOST_ENABLED = isOn and true or false

                if BoostModule then
                    if AUTO_BOOST_ENABLED and BoostModule.start then
                        pcall(BoostModule.start)
                    elseif (not AUTO_BOOST_ENABLED) and BoostModule.stop then
                        pcall(BoostModule.stop)
                    end
                end

                autoSave()
            end
        )


-- ============================================================
-- Auto Feed (body3)
-- ============================================================

-- default state
AUTO_FEED_ENABLED          = (AUTO_FEED_ENABLED == true)
AUTO_FEED_DELAY            = tonumber(AUTO_FEED_DELAY or 10) or 10
AUTO_FEED_PETS_SELECTED    = AUTO_FEED_PETS_SELECTED or {}      -- map key->true (sesuai PetItems.key)
AUTO_FEED_FRUITS_SELECTED  = AUTO_FEED_FRUITS_SELECTED or {}    -- map fruit->true

local G = (getgenv and getgenv()) or _G
G.AUTO_FEED_ENABLED = AUTO_FEED_ENABLED
G.AUTO_FEED_DELAY   = AUTO_FEED_DELAY

-- module optional (kalau sudah ada)
local FeedModule = rawget(_G, "AutoFeed") or rawget(_G, "AutoKGFeed") or rawget(_G, "AutoKGAutoFeed")

-- items fruit (sesuaikan nama sesuai game kamu)
local function getAutoBuy()
    local env = (getgenv and getgenv()) or _G
    return env.AutoBuyModule or _G.AutoBuyModule
end

local function getSeedItemsForFruit()
    local AutoBuy = getAutoBuy()
    if not AutoBuy or type(AutoBuy.GetLists) ~= "function" then
        warn("[AutoFeed UI] AutoBuyModule belum siap / GetLists() tidak ada")
        return {}
    end

    local ok, seedList = pcall(function()
        local a = AutoBuy.GetLists() -- returns SeedItems, EggItems, GearItems
        return a
    end)

    if ok and type(seedList) == "table" then
        return seedList
    end

    return {}
end

local function wrapStringList(list)
    local out = {}
    for _, name in ipairs(list or {}) do
        out[#out+1] = { key = tostring(name), name = tostring(name) }
    end
    return out
end

local function cleanSelectedMap(selectedMap)
    local out = {}
    for k, v in pairs(selectedMap or {}) do
        if v == true then out[tostring(k)] = true end
    end
    return out
end

-- 1) Dropdown Pet (multi)
ui:CreateRowDropdown(body3, {
    label       = "Select Pet To Feed",
    placeholder = "Select Pet...",
    mode        = "multi",
    getItems    = function() return PetItems end,
    initial     = AUTO_FEED_PETS_SELECTED or {},
    onChanged   = function(mode, selectedMap)
        AUTO_FEED_PETS_SELECTED = {}
        for k, enabled in pairs(selectedMap or {}) do
            if enabled then
                AUTO_FEED_PETS_SELECTED[k] = true
            end
        end
        G.AUTO_FEED_PETS_SELECTED = AUTO_FEED_PETS_SELECTED

        -- optional sync ke module
        pcall(function()
            if FeedModule and type(FeedModule.setPets) == "function" then
                FeedModule.setPets(AUTO_FEED_PETS_SELECTED)
            elseif FeedModule and type(FeedModule.SetPets) == "function" then
                FeedModule.SetPets(AUTO_FEED_PETS_SELECTED)
            elseif FeedModule and type(FeedModule.syncFromState) == "function" then
                FeedModule:syncFromState()
            end
        end)

        autoSave()
    end,
})

AUTO_FEED_FRUITS_SELECTED = cleanSelectedMap(AUTO_FEED_FRUITS_SELECTED or {})

ui:CreateRowDropdown(body3, {
    label       = "Select Fruit",
    placeholder = "Select Fruit...",
    mode        = "multi",
    getItems    = function()
        local SeedNames = getSeedItemsForFruit()
        return wrapStringList(SeedNames)
    end,
    initial     = AUTO_FEED_FRUITS_SELECTED,
    onChanged   = function(_, selectedMap)
        AUTO_FEED_FRUITS_SELECTED = cleanSelectedMap(selectedMap)
        G.AUTO_FEED_FRUITS_SELECTED = AUTO_FEED_FRUITS_SELECTED

        -- optional sync ke module feed
        pcall(function()
            if FeedModule and type(FeedModule.setFruits) == "function" then
                FeedModule.setFruits(AUTO_FEED_FRUITS_SELECTED)
            elseif FeedModule and type(FeedModule.SetFruits) == "function" then
                FeedModule.SetFruits(AUTO_FEED_FRUITS_SELECTED)
            elseif FeedModule and type(FeedModule.syncFromState) == "function" then
                FeedModule:syncFromState()
            end
        end)

        autoSave()
    end,
})


-- 3) Input Hunger Under (SKALA BESAR: contoh 60000)
local function getFeed()
    return rawget(_G, "AutoFeed") or rawget(_G, "AutoKGFeed")
end

ui:CreateRowInput(body3, "If Hunger Under", tostring(AUTO_FEED_HUNGER_UNDER or 60000), function(text)
    text = tostring(text or ""):gsub("%s+", "")
    if text == "" then return end

    local v = tonumber(text)
    if not v then
        warn("[AutoFeed] Hunger Under tidak valid: " .. tostring(text))
        return
    end

    v = math.floor(v + 0.5)

    -- âœ… jangan clamp 1..100 (hunger kamu 0..60000)
    -- pilih max sesuai kebutuhan (aku pakai 200000 biar aman)
    v = math.clamp(v, 1, 200000)

    AUTO_FEED_HUNGER_UNDER = v
    local G = (getgenv and getgenv()) or _G
    G.AUTO_FEED_HUNGER_UNDER = v

    -- âœ… push realtime ke module yang aktif
    pcall(function()
        local Feed = getFeed()
        if not Feed then return end

        if type(Feed.setHungerUnder) == "function" then
            Feed.setHungerUnder(v)
        elseif type(Feed.SetHungerUnder) == "function" then
            Feed.SetHungerUnder(v)
        elseif type(Feed.syncFromState) == "function" then
            Feed:syncFromState()
        else
            Feed.HUNGER_UNDER = v
        end
    end)

    -- autosave (anti spam)
    task.defer(function()
        local cur = v
        task.wait(0.35)
        if AUTO_FEED_HUNGER_UNDER == cur then
            autoSave()
        end
    end)
end)




-- 4) Toggle Enable Auto Feed
ui:CreateRowToggle(
    body3,
    "Enable Auto Feed",
    AUTO_FEED_ENABLED == true,
    function(isOn)
        AUTO_FEED_ENABLED = isOn and true or false
        G.AUTO_FEED_ENABLED = AUTO_FEED_ENABLED

        if FeedModule then
            if AUTO_FEED_ENABLED and FeedModule.start then
                pcall(FeedModule.start)
            elseif (not AUTO_FEED_ENABLED) and FeedModule.stop then
                pcall(FeedModule.stop)
            elseif type(FeedModule.SetEnabled) == "function" then
                pcall(function() FeedModule.SetEnabled(AUTO_FEED_ENABLED) end)
            elseif type(FeedModule.setEnabled) == "function" then
                pcall(function() FeedModule.setEnabled(AUTO_FEED_ENABLED) end)
            end
        end

        autoSave()
    end
)




ui:CreateRowToggle(
    body4,
    "Enable Auto Collect (Fruit)",
    AUTO_COLLECT_FRUIT_ENABLED == true,
    function(isOn)
        AUTO_COLLECT_FRUIT_ENABLED = isOn and true or false
        G.AUTO_COLLECT_FRUIT_ENABLED = AUTO_COLLECT_FRUIT_ENABLED

        -- coba hidup/matikan module kalau ada
        if AutoCollectFruit then
            if AUTO_COLLECT_FRUIT_ENABLED and AutoCollectFruit.start then
                pcall(AutoCollectFruit.start)
            elseif (not AUTO_COLLECT_FRUIT_ENABLED) and AutoCollectFruit.stop then
                pcall(AutoCollectFruit.stop)
            elseif type(AutoCollectFruit.SetEnabled) == "function" then
                pcall(function() AutoCollectFruit.SetEnabled(AUTO_COLLECT_FRUIT_ENABLED) end)
            elseif type(AutoCollectFruit.setEnabled) == "function" then
                pcall(function() AutoCollectFruit.setEnabled(AUTO_COLLECT_FRUIT_ENABLED) end)
            end
        end

        autoSave()
    end
)


        if #sectionSetters == 1 then
            sectionSetters[1](true)
        else
            for _, fn in ipairs(sectionSetters) do
                fn(false)
            end
        end
    end, 6)

    ----------------------------------------------------------------
    -- FOOTER: Mode Picker + Start/Stop
    ----------------------------------------------------------------
    -- pastikan default global
    GBXP_STAGE_MODE = GBXP_STAGE_MODE or "auto"

local function isAutoKGRunning()
    local loop = rawget(_G, "AutoKGLoop")
    if not loop then return false end
    if type(loop.IsRunning) == "function" then
        local ok, v = pcall(loop.IsRunning)
        if ok then return v == true end
    end
    return loop.running == true
end


    local function getEffectiveModeId()
        local m = GBXP_STAGE_MODE
        if not m or m == "" then m = "auto" end
        return m
    end

    local function getModeOptionsDynamic()
        -- Ambil batas dari tab noos untuk label yang selalu up-to-date
        local MODE_AGE_LIMIT = tonumber(TAB_AGE_EQUIP_MIN.noos) or 40
        local MODE_KG_LIMIT  = tonumber(TAB_W_EQUIP_MIN.noos) or 60.45
        MODE_KG_LIMIT = math.abs(MODE_KG_LIMIT)

        return {
            { id = "auto", label = "AUTO  -  Aâ†’Bâ†’Câ†’D otomatis" },
            { id = "A",    label = "Stage A  -  Cari mutasi (Pilih mutasi di tab âš™)" },
            { id = "B",    label = "Stage B  -  Up Age ke 40" },
            {
                id = "C",
                label = string.format("Stage C  -  Up KG (Age â‰¥ %.0f & KG < %.2f) ðŸ˜", MODE_AGE_LIMIT, MODE_KG_LIMIT),
            },
            {
                id = "D",
                label = string.format("Stage D  -  Up Age sampai 100 (KG â‰¥ %.2f)", MODE_KG_LIMIT),
            },
            {
                id = "BC",
                label = string.format("Stage B + C  -  Age < %.0f & Age â‰¥ %.0f (KG < %.2f)", MODE_AGE_LIMIT, MODE_AGE_LIMIT, MODE_KG_LIMIT),
            },
            {
                id = "CD",
                label = string.format("Stage C + D  -  KG < %.2f & KG â‰¥ %.2f s/d Age 100", MODE_KG_LIMIT, MODE_KG_LIMIT),
            },
            {
                id = "CAD",
                label = string.format(
                    "Stage C â†’ A â†’ D  -  Prioritas C (Age â‰¥ %.0f & KG < %.2f), lalu A (cari mutasi), lalu D (KG â‰¥ %.2f s/d Age 100)",
                    MODE_AGE_LIMIT, MODE_KG_LIMIT, MODE_KG_LIMIT
                ),
            },
        }
    end

    local function getModeButtonText()
        return "Mode: " .. tostring(getEffectiveModeId())
    end
    
    

 -- ==================================================
-- FOOTER AUTO KG (FULL)
-- ==================================================
local function refreshFooter()
    local running = isAutoKGRunning()
    local MODE_OPTIONS = getModeOptionsDynamic()

    ui:SetFooterButtonsFor("autokg", {

        -- MODE PICKER
        {
            text  = getModeButtonText(),
            kind  = "normal",
            order = 3,
            onClick = function()
                ui:OpenModePicker(MODE_OPTIONS, getEffectiveModeId(), function(newId)
                    if type(setGBXPStageMode) == "function" then
                        setGBXPStageMode(newId)
                    else
                        GBXP_STAGE_MODE = newId
                    end

                    autoSave()
                    _G.__AUTOKG_DIRTY = true
                    refreshFooter()
                end)
            end,
        },

        -- START KG
        {
            key     = "autokg_start",
            text    = running and "âš¡ RUNNING." or "âš¡ START KG",
            kind    = "normal",
            running = running,
            order   = 1,

            onClick = function()
                -- âœ… user klik START = buka manual-stop lock
                _G.__AUTOKG_MANUAL_STOP = false
                -- âœ… kalau sebelumnya ada autostart inflight (PSReconnect/qtp), lepas
                _G.__AUTOKG_AUTOSTART_INFLIGHT = false

                -- âœ… jangan double-start kalau sudah running
                if isAutoKGRunning() then
                    _G.__AUTOKG_DIRTY = true
                    refreshFooter()
                    return
                end

                local modeId = getEffectiveModeId()

                -- simpan mode + reset stage biar konsisten
                if type(setGBXPStageMode) == "function" then
                    setGBXPStageMode(modeId)
                else
                    GBXP_STAGE_MODE = modeId
                end

                -- start loop
                local loop = rawget(_G, "AutoKGLoop")
                if loop and type(loop.Start) == "function" then
                    pcall(function()
                        loop.Start(modeId)
                    end)
                end

                autoSave()
                _G.__AUTOKG_DIRTY = true
                refreshFooter()
            end,

            onReady = function(btn)
                -- biar kerasa â€œelectricâ€
                if isAutoKGRunning() then
                    btn.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
                    btn.TextColor3       = Color3.fromRGB(255, 217, 0)
                else
                    btn.BackgroundColor3 = COLOR_PANEL
                    btn.TextColor3       = COLOR_WHITE
                end
            end,
        },

        -- STOP
        {
            text  = "STOP",
            kind  = "normal",
            order = 2,

            onClick = function()
                -- âœ… user klik STOP = kunci supaya autostart (PSReconnect/qtp/main) gak nyalain lagi
                _G.__AUTOKG_MANUAL_STOP = true

                local loop = rawget(_G, "AutoKGLoop")
                if loop and type(loop.Stop) == "function" then
                    pcall(function()
                        loop.Stop("manual")
                    end)
                end

                autoSave()
                _G.__AUTOKG_DIRTY = true
                refreshFooter()
            end,
        },

    })
end

-- initial build
refreshFooter()

-- watcher 1: fast dirty signal
task.spawn(function()
    while true do
        task.wait(0.5)
        if _G.__AUTOKG_DIRTY then
            _G.__AUTOKG_DIRTY = false
            pcall(refreshFooter)
        end
    end
end)

-- watcher 2: polling running/mode changes
task.spawn(function()
    local lastRunning, lastMode = nil, nil
    while true do
        task.wait(1.5)

        local nowRunning = isAutoKGRunning()
        local nowMode    = getEffectiveModeId()

        if nowRunning ~= lastRunning or nowMode ~= lastMode or _G.__AUTOKG_DIRTY then
            _G.__AUTOKG_DIRTY = false
            lastRunning, lastMode = nowRunning, nowMode
            pcall(refreshFooter)
        end
    end
end)


    ----------------------------------------------------------------
    -- AUTO SYNC LOOP (summary + gbxp reconcile + list refresh)
    ----------------------------------------------------------------
    if STATE._autokgSyncStarted ~= true then
        STATE._autokgSyncStarted = true

        task.spawn(function()
            while true do
                -- 1) reconcile gbxp candidates (auto select)
                reconcileGBXP()

                -- 2) summary global selalu update (aman, ringan)
                refreshAllSummary()
                
                if _G.__AUTOKG_DIRTY then
    _G.__AUTOKG_DIRTY = false
    refreshAllSummary()
    refreshTabList("noos")
    refreshTabList("boost")
    refreshTabList("seratusage")
    refreshTabList("xp")
    refreshTabList("gbxp")
end


                -- 3) optional: refresh list tab lain yang sedang kebuka
                -- (kalau tab belum pernah dibuka, UIREF.tabs[tabKey] belum ada â†’ aman)
                -- refreshTabList("noos")
                -- refreshTabList("boost")
                -- refreshTabList("seratusage")
                -- refreshTabList("xp")
                -- gbxp sudah di-refresh saat reconcile berubah

                task.wait(4)
            end
        end)
    end
end
-- tabs_misc.lua
-- Main tab "Misc" â†’ sub tab:
--   gift (3 baris konfigurasi auto gift)

local M = {}



function M.Register(ui, STATE, PetListView)
    PetListView = PetListView or {
        buildEntriesForTab = function()
            return {}
        end,
    }

    --------------------------------------------------
    -- BIND STATE.GIFT_CFG â†’ ikut di-save ke file
    --------------------------------------------------
    STATE.GIFT_CFG = STATE.GIFT_CFG or GIFT_CFG
    local giftCfg = STATE.GIFT_CFG

    ----------------------------------------------------------------
    -- helper autosave: pakai ui:SaveState() dari main.lua
    ----------------------------------------------------------------
    local function autoSave()
        if ui and type(ui.SaveState) == "function" then
            task.defer(function()
                local ok, err = pcall(function()
                    ui:SaveState()
                end)
                if not ok then
                    warn("[Misc/Gift] Gagal ui:SaveState():", err)
                end
            end)
        else
            warn("[Misc/Gift] ui.SaveState() tidak tersedia, perubahan TIDAK di-persist.")
        end
    end
    
    
   local Players = game:GetService("Players")
   local LocalPlayer = Players.LocalPlayer

    --------------------------------------------------
    -- DATA SOURCE: TARGET DROPDOWN (PAKAI PLAYERS)
    --------------------------------------------------
local function getTargetItems()
    local items = {}

    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            table.insert(items, {
                key      = plr.Name,     -- dipakai dropdown
                name     = plr.Name,     -- tampil di UI
                userId   = plr.UserId,   -- disimpan ke config
            })
        end
    end

    return items
end


    --------------------------------------------------
    -- MAIN TAB: Misc
    --------------------------------------------------
    ui:RegisterMainTab("misc", "Misc", 2)
    if ui.SetFooterButtonsFor then
        -- kosongkan footer â†’ footer hidden, content melebar
        ui:SetFooterButtonsFor("misc", {})
    end

ui:RegisterSubTab("misc", "buy", "Auto Buy", function()
    ui:ClearSubContent()

    local sectionSetters = {}
    local function createSection(title, defaultOpen)
        local body, setExpanded = ui:CreateSection(title, defaultOpen or false)
        table.insert(sectionSetters, setExpanded)
        return body
    end

    local body1 = createSection(" Auto Buy Seed", false)
    local body2 = createSection(" Auto Buy Egg",  false)
    local body3 = createSection(" Auto Buy Gear", false)

    local function cleanSelectedMap(selectedMap)
        local out = {}
        for k, v in pairs(selectedMap or {}) do
            if v == true then out[tostring(k)] = true end
        end
        return out
    end

    local function getAutoBuy()
        local env = (getgenv and getgenv()) or _G
        return env.AutoBuyModule or _G.AutoBuyModule
    end

    -- âœ… normalize list: support {"A","B"} atau {{key="A",name="A"},...}
    local function normalizeDropdownItems(list)
        local out = {}
        if type(list) ~= "table" then return out end

        for _, it in ipairs(list) do
            if type(it) == "string" then
                out[#out+1] = { key = it, name = it }
            elseif type(it) == "table" then
                local k = it.key or it.name or it.id
                local n = it.name or it.key or it.id
                if k and n then
                    out[#out+1] = { key = tostring(k), name = tostring(n) }
                end
            end
        end
        return out
    end

    -- âœ… PREFETCH LIST SEKALI
    local AutoBuy = getAutoBuy()
    if not AutoBuy or (type(AutoBuy.GetLists) ~= "function" and type(AutoBuy.GetShopInfo) ~= "function") then
        warn("[AutoBuy UI] AutoBuyModule belum siap / GetLists() tidak ada")
        ui:CreateRowLabel(body1, "âš  AutoBuyModule belum siap. Reopen tab.")
        return
    end

    local SeedItems, EggItems, GearItems = {}, {}, {}
    do
        local ok, a, b, c = pcall(function()
            if type(AutoBuy.GetLists) == "function" then
                return AutoBuy.GetLists()          -- function style
            else
                return {}, {}, {}
            end
        end)

        if ok then
            SeedItems = normalizeDropdownItems(a or {})
            EggItems  = normalizeDropdownItems(b or {})
            GearItems = normalizeDropdownItems(c or {})
        end

       -- print("[AutoBuy UI] lists:", "seed", #SeedItems, "egg", #EggItems, "gear", #GearItems)
        --if SeedItems[1] then print("[AutoBuy UI] seed sample:", SeedItems[1].key, SeedItems[1].name) end
    end

local function syncAutoBuy()
    if AutoBuy and type(AutoBuy.SyncFromGlobals) == "function" then
        pcall(AutoBuy.SyncFromGlobals)
    end

    -- âœ… auto start/stop loop berdasarkan toggle
    local anyOn = (AUTO_BUY_SEED_ENABLED == true) or (AUTO_BUY_EGG_ENABLED == true) or (AUTO_BUY_GEAR_ENABLED == true)
    if AutoBuy and type(AutoBuy.Start) == "function" and type(AutoBuy.Stop) == "function" then
        if anyOn then
            AutoBuy.Start()
        else
            AutoBuy.Stop()
        end
    end
end


    -- =========================
    -- AUTO BUY SEED
    -- =========================
    SEED_SELECTED = cleanSelectedMap(SEED_SELECTED or {})
    AUTO_BUY_SEED_ENABLED = (AUTO_BUY_SEED_ENABLED == true)

    ui:CreateRowDropdown(body1, {
        label       = "Select Seed",
        placeholder = "Select Seed...",
        mode        = "multi",
        getItems    = function() return SeedItems end,
        initial     = SEED_SELECTED,
        onChanged   = function(_, selectedMap)
            SEED_SELECTED = cleanSelectedMap(selectedMap)
            syncAutoBuy()
            autoSave()
        end,
    })

    ui:CreateRowToggle(body1, "Auto Buy Seed", AUTO_BUY_SEED_ENABLED, function(isOn)
        AUTO_BUY_SEED_ENABLED = (isOn == true)
        syncAutoBuy()
        autoSave()
    end)

    -- =========================
    -- AUTO BUY EGG
    -- =========================
    EGG_SELECTED = cleanSelectedMap(EGG_SELECTED or {})
    AUTO_BUY_EGG_ENABLED = (AUTO_BUY_EGG_ENABLED == true)

    ui:CreateRowDropdown(body2, {
        label       = "Select Egg",
        placeholder = "Select Egg...",
        mode        = "multi",
        getItems    = function() return EggItems end,
        initial     = EGG_SELECTED,
        onChanged   = function(_, selectedMap)
            EGG_SELECTED = cleanSelectedMap(selectedMap)
            syncAutoBuy()
            autoSave()
        end,
    })

    ui:CreateRowToggle(body2, "Auto Buy Egg", AUTO_BUY_EGG_ENABLED, function(isOn)
        AUTO_BUY_EGG_ENABLED = (isOn == true)
        syncAutoBuy()
        autoSave()
    end)

    -- =========================
    -- AUTO BUY GEAR
    -- =========================
    GEAR_SELECTED = cleanSelectedMap(GEAR_SELECTED or {})
    AUTO_BUY_GEAR_ENABLED = (AUTO_BUY_GEAR_ENABLED == true)

    ui:CreateRowDropdown(body3, {
        label       = "Select Gear",
        placeholder = "Select Gear...",
        mode        = "multi",
        getItems    = function() return GearItems end,
        initial     = GEAR_SELECTED,
        onChanged   = function(_, selectedMap)
            GEAR_SELECTED = cleanSelectedMap(selectedMap)
            syncAutoBuy()
            autoSave()
        end,
    })

    ui:CreateRowToggle(body3, "Auto Buy Gear", AUTO_BUY_GEAR_ENABLED, function(isOn)
        AUTO_BUY_GEAR_ENABLED = (isOn == true)
        syncAutoBuy()
        autoSave()
    end)

    syncAutoBuy()

    if #sectionSetters >= 1 then
        sectionSetters[1](true)
        for i = 2, #sectionSetters do sectionSetters[i](false) end
    end
end, 1)







    --------------------------------------------------
    -- Helper: bangun satu section Gift (row 1 / 2 / 3)
    --------------------------------------------------
    local function buildGiftSection(body, suffix, title, PetItems)
        suffix = suffix or ""  -- "", "B", "C"

        local keyEnabled = "enabled" .. suffix
        local keyTargets = "targets" .. suffix
        local keyMinKG   = "minKG"   .. suffix
        local keyMinAge  = "minAge"  .. suffix
        local keyPetType = "petType" .. suffix

        -- default
        giftCfg[keyEnabled] = giftCfg[keyEnabled] or false
        giftCfg[keyTargets] = giftCfg[keyTargets] or {}
        giftCfg[keyMinKG]   = giftCfg[keyMinKG]   or 0
        giftCfg[keyMinAge]  = giftCfg[keyMinAge]  or 0
        giftCfg[keyPetType] = giftCfg[keyPetType] or {}



        ------------------------------------------------------
        -- DROPDOWN: Target  (pakai Players:GetPlayers())
        ------------------------------------------------------
        ui:CreateRowDropdown(body, {
            label       = "Target",
            placeholder = "Pilih target gift...",
            mode        = "multi",

            getItems = function()
                return getTargetItems()
            end,

            -- initial: konversi dari GIFT_CFG.targets/targetsB/targetsC
            -- bisa format struct lama ({userId=, name=}) atau map bool
initial = (function()
    local map = {}
    local src = giftCfg[keyTargets]

    if type(src) == "table" then
        for k, v in pairs(src) do
            if type(v) == "table" and v.name then
                map[v.name] = true
            elseif v == true then
                map[tostring(k)] = true
            end
        end
    end
    return map
end)(),


onChanged = function(mode, selectedMap)
    giftCfg[keyTargets] = {}

    if type(selectedMap) == "table" then
        for name, enabled in pairs(selectedMap) do
            if enabled then
                -- Cari player ID agar tetap bisa disimpan
                local plr = Players:FindFirstChild(name)
                local uid = plr and plr.UserId or nil

                giftCfg[keyTargets][name] = {
                    userId = uid,
                    name   = name,
                }
            end
        end
    end

    autoSave()
end,

        })

    
                ------------------------------------------------------
        -- DROPDOWN: Pet Type  (pakai PetItems dari PetListView)
        ------------------------------------------------------
        ui:CreateRowDropdown(body, {
            label       = "Select Pet Type",
            placeholder = "Select Pet...",
            mode        = "multi",

            getItems = function()
                return PetItems   -- sama seperti di autokg.lua
            end,

            -- map: { ["Dragon"] = true, ["Elephant"] = true, ... }
            initial = giftCfg[keyPetType] or {},

            onChanged = function(mode, selectedMap)
                giftCfg[keyPetType] = {}

                if type(selectedMap) == "table" then
                    for petName, enabled in pairs(selectedMap) do
                        if enabled then
                            giftCfg[keyPetType][petName] = true   -- simpan HANYA key (nama)
                        end
                    end
                end

                autoSave()
            end,
        })

        ------------------------------------------------------
        -- INPUT: Min Age  (boleh minus)
        ------------------------------------------------------
        ui:CreateRowInput(
            body,
            "Age",
            tostring(giftCfg[keyMinAge] or 0),
            function(text)
                text = tostring(text or ""):gsub("%s+", "")

                -- âœ… izinkan user ngetik "-" dulu (belum angka)
                if text == "" or text == "-" then
                    return
                end

                local num = tonumber(text)
                if num == nil then
                    return
                end

                -- kalau kamu tetap mau clamp: (opsional)
                -- if num < 0 then num = 0 end

                giftCfg[keyMinAge] = num
                autoSave()
            end
        )

        ------------------------------------------------------
        -- INPUT: Min KG (Assumed at age 100)  (boleh minus)
        ------------------------------------------------------
        ui:CreateRowInput(
            body,
            "KG ( Assumed at age 100 )",
            tostring(giftCfg[keyMinKG] or 0),
            function(text)
                text = tostring(text or ""):gsub("%s+", "")

                -- âœ… izinkan "-" dulu
                if text == "" or text == "-" then
                    return
                end

                local num = tonumber(text)
                if num == nil then
                    return
                end

                -- kalau kamu tetap mau clamp: (opsional)
                -- if num < 0 then num = 0 end

                giftCfg[keyMinKG] = num
                autoSave()
            end
        )





    
    
    
                ------------------------------------------------------
        -- TOGGLE: Gift X Enabled
        ------------------------------------------------------
        ui:CreateRowToggle(
            body,
            title .. " Enabled",
            giftCfg[keyEnabled] == true,
            function(isOn)
                giftCfg[keyEnabled] = isOn and true or false
                autoSave()
            end
        )
    end
    


    --------------------------------------------------
    -- SUBTAB: misc > gift
    --------------------------------------------------
    ui:RegisterSubTab("misc", "gift", "Auto Gift", function()
        ui:ClearSubContent()

        -- ðŸ”¹ ambil PetItems DI SINI, sama persis seperti di autokg.lua
        local PetItems = {}
        if PetListView and PetListView.buildPetItems then
            PetItems = PetListView.buildPetItems()
        end

        -- debug dikit kalau mau cek
        -- print("[Misc/Gift] PetItems count =", #PetItems)

        -- list setter section buat open/close
        local sectionSetters = {}

        local function createSection(title, defaultOpen)
            local body, setExpanded = ui:CreateSection(title, defaultOpen or false)
            table.insert(sectionSetters, setExpanded)
            return body
        end

        -- 3 Section Gift
        local body1 = createSection("Gift 1", false)   -- default kebuka
        local body2 = createSection("Gift 2", false)
        local body3 = createSection("Gift 3", false)
        local body4 = createSection("Auto Accept Gift / Trade", false)

        -- isi tiap section (PetItems dikirim ke masing2)
        buildGiftSection(body1,  "",  "Gift 1", PetItems)
        buildGiftSection(body2,  "B", "Gift 2", PetItems)
        buildGiftSection(body3,  "C", "Gift 3", PetItems)


    
        ------------------------------------------------------
        -- TOGGLE: Auto Accept Trade
        ------------------------------------------------------
        giftCfg.autoAcceptTrade = giftCfg.autoAcceptTrade or false

        ui:CreateRowToggle(
            body4,
            "Auto Accept Trade",
            giftCfg.autoAcceptTrade == true,
            function(isOn)
                giftCfg.autoAcceptTrade = isOn and true or false
                autoSave()
            end
        )

        ------------------------------------------------------
        -- TOGGLE: Auto Accept Gift
        ------------------------------------------------------
        giftCfg.autoAcceptGift = giftCfg.autoAcceptGift or false

        ui:CreateRowToggle(
            body4,
            "Auto Accept Gift",
            giftCfg.autoAcceptGift == true,
            function(isOn)
                giftCfg.autoAcceptGift = isOn and true or false
                autoSave()
            end
        )
        -- aturan expand: default cuma Gift 1 yang kebuka
        if #sectionSetters >= 1 then
            sectionSetters[1](false)
            for i = 2, #sectionSetters do
                sectionSetters[i](false)
            end
        end
    end, 2)
    
    
ui:RegisterSubTab("misc", "webhook", "Webhook", function()
    ui:ClearSubContent()

    local sectionSetters = {}
    local function createSection(title, defaultOpen)
        local body, setExpanded = ui:CreateSection(title, defaultOpen or false)
        table.insert(sectionSetters, setExpanded)
        return body
    end

    local body1 = createSection("( Few Day )", true)


    if #sectionSetters >= 1 then
        sectionSetters[1](true)
        for i = 2, #sectionSetters do
            sectionSetters[i](false)
        end
    end
end, 3)


ui:RegisterSubTab("misc", "rejoin", "Rejoin", function()
    ui:ClearSubContent()

    local sectionSetters = {}
    local function createSection(title, defaultOpen)
        local body, setExpanded = ui:CreateSection(title, defaultOpen or false)
        table.insert(sectionSetters, setExpanded)
        return body
    end

    local body1 = createSection("Auto Reconnect / Start", true)

    local function syncReconnectModule()
        pcall(function()
            if _G.PSReconnect and type(_G.PSReconnect.SetEnabled) == "function" then
                _G.PSReconnect:SetEnabled(AUTO_RECONNECT_ENABLED == true)
            end
            local ak = (AUTO_START_KG_ON_REJOIN == true)
if type(_G.PSReconnect.SetAutoStartKG) == "function" then
    _G.PSReconnect:SetAutoStartKG(ak)
elseif type(_G.PSReconnect.setAutoStartKG) == "function" then
    _G.PSReconnect:setAutoStartKG(ak)
end

        end)
    end

    -- Toggle: Auto Exec (save saja; PSReconnect baca dari file saat join/teleport)
    ui:CreateRowToggle(body1, "Auto Exec", AUTO_START_ON_REJOIN == true, function(on)
        AUTO_START_ON_REJOIN = (on == true)
        autoSave()
        -- tidak perlu sync modul
    end)

    -- Toggle: Auto Reconnect (langsung sync modul)
    ui:CreateRowToggle(body1, "Auto Reconnect", AUTO_RECONNECT_ENABLED == true, function(on)
        AUTO_RECONNECT_ENABLED = (on == true)
        syncReconnectModule()
        autoSave()
    end)

    -- Toggle: Auto Start KG (nanti disambung; sekarang save saja)
    ui:CreateRowToggle(body1, "Auto Start KG", AUTO_START_KG_ON_REJOIN == true, function(on)
        AUTO_START_KG_ON_REJOIN = (on == true)
        autoSave()
    end)

    -- Momentary toggle: Rejoin Now (tidak disave)
    ui:CreateRowToggle(body1, "Rejoin Now", false, function(on)
        if on ~= true then return end

        local done = false
        pcall(function()
            if _G.PSReconnect then
                if type(_G.PSReconnect.RejoinNow) == "function" then
                    _G.PSReconnect:RejoinNow()
                    done = true
                elseif type(_G.PSReconnect.rejoinNow) == "function" then
                    _G.PSReconnect:rejoinNow()
                    done = true
                end
            end
        end)

        if not done then
            pcall(function()
                local TeleportService = game:GetService("TeleportService")
                local Players = game:GetService("Players")
                TeleportService:Teleport(game.PlaceId, Players.LocalPlayer)
            end)
        end

        -- optional reset OFF (kalau UI punya helper)
        task.defer(function()
            if ui.SetToggleValue then
                ui:SetToggleValue("Rejoin Now", false)
            end
        end)
    end)

    if #sectionSetters >= 1 then
        sectionSetters[1](true)
        for i = 2, #sectionSetters do sectionSetters[i](false) end
    end

    syncReconnectModule()
end, 4)





    --------------------------------------------------
    -- Subtab Misc lain bisa kamu tambahkan di bawah sini
    --------------------------------------------------
end
-- pet_list_view.lua
-- Helper untuk membangun list pet per tab.
-- Output utama:
--   M.buildEntriesForTab(tabKey, selectedSet)
--     â†’ { { key=uuid, name="Label ..." }, ... }

local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer
local HttpService = game:GetService("HttpService")

-- Modul game yang dipakai
local PetsService       = require(ReplicatedStorage.Modules.PetServices.PetsService)
local PetRegistry       = require(ReplicatedStorage.Data.PetRegistry)
local ActivePetsService = require(ReplicatedStorage.Modules.PetServices.ActivePetsService)
local PetUtilities      = require(ReplicatedStorage.Modules.PetServices.PetUtilities)
local mutationModule    = require(ReplicatedStorage.Data.PetRegistry.PetMutationRegistry)
local Backpack = LocalPlayer:WaitForChild("Backpack")

-- SESUAI contohmu: DataService.InventoryData
local DataService = require(ReplicatedStorage.Modules.DataService)
local PetList = require(ReplicatedStorage.Data.PetRegistry.PetList)

-------------------------------------------------------------
-- 1) MUTATION MAP: EnumId (a, b, c, A, B, ...) â†’ Nama mutasi
-------------------------------------------------------------
local MUT_CODE_TO_NAME = {}
-------------------------------------------------------------
-- 1b) Daftar master nama mutasi (untuk UI dropdown, dll)
-------------------------------------------------------------
local MUTATION_LIST = {}

local function __build_mutation_list()
    -- modul yang sama dengan di atas (mutationModule)
    -- bisa punya field PetMutationRegistry atau langsung table mutasi
    local reg = mutationModule and (mutationModule.PetMutationRegistry or mutationModule)

    if type(reg) ~= "table" then
        warn("[PetListView] PetMutationRegistry invalid untuk MUTATION_LIST:", typeof(reg))
        return
    end

    for mutName, info in pairs(reg) do
        -- kalau mau filter: contoh hanya yang AvaliableFromMutationMachine
        -- if info.AvaliableFromMutationMachine then
        --     table.insert(MUTATION_LIST, mutName)
        -- end

        -- sekarang: ambil semua nama mutasi
        table.insert(MUTATION_LIST, mutName)
    end

    table.sort(MUTATION_LIST, function(a, b)
        return tostring(a) < tostring(b)
    end)
end

__build_mutation_list()



do
    local reg = mutationModule and mutationModule.PetMutationRegistry
    if type(reg) == "table" then
        for mutName, def in pairs(reg) do
            if type(def) == "table" then
                local code = def.EnumId       -- 'a','b','c','A',...
                if type(code) == "string" and #code == 1 then
                    MUT_CODE_TO_NAME[code] = mutName
                end
            end
        end
    else
        warn("[PetListView] PetMutationRegistry invalid:", typeof(reg))
    end
end

-------------------------------------------------------------
-- 2) Helper kecil (UUID, number, scale, dst)
-------------------------------------------------------------
local function __normUUID(u)
    if not u or u == "" then return nil, nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core, "{"..core.."}"
end

local function __toNumberKG(v)
    if v == nil then return nil end
    if type(v) == "number" then return v end
    local s = tostring(v):lower()
    s = s:gsub("[^%d%,%.]+", "")
    s = s:gsub(",", ".")
    return tonumber(s)
end

local SCALE_PER_LVL = PetRegistry.PetConfig.WEIGHT_CONFIG.SCALE_PERCENTAGE_OF_BASE_WEIGHT_PER_LEVEL

local function __number_from_candidates(tbl, keys, srcOut)
    for _,k in ipairs(keys) do
        local v = tbl[k]
        if type(v) == "number" then
            if srcOut then srcOut[1]=k end
            return v
        end
        if type(v) == "string" then
            local n = tonumber((v:gsub(",", ".")))
            if n then
                if srcOut then srcOut[1]=k end
                return n
            end
        end
    end
    return nil
end

local function __age_from_record(rec, srcOut)
    local PD = rec.PetData or rec.Data or {}
    return __number_from_candidates(rec, {"Age","age","Level","level"}, srcOut)
        or __number_from_candidates(PD,  {"Age","age","Level","level"}, srcOut)
end

local function __base_from_record(rec, srcOut)
    local PD = rec.PetData or rec.Data or {}
    return __number_from_candidates(rec, {"BaseWeight","BaseWeightKG","WeightBase","baseWeight","base_weight"}, srcOut)
        or __number_from_candidates(PD,  {"BaseWeight","BaseWeightKG","WeightBase","baseWeight","base_weight"}, srcOut)
end

local function __current_from_record(rec, srcOut)
    local PD = rec.PetData or rec.Data or {}
    return __number_from_candidates(rec, {"Weight","weight","KG","kg","W","w","WeightNow","weight_now","currentWeight"}, srcOut)
        or __number_from_candidates(PD,  {"Weight","weight","KG","kg","W","w","WeightNow","weight_now","currentWeight"}, srcOut)
end

-- FAVORITE langsung dari datastore
local function __is_favorite(rec)
    if type(rec) ~= "table" then return false end
    local PD = rec.PetData or rec.Data or {}

    if typeof(PD.IsFavorite) == "boolean" then
        return PD.IsFavorite
    end
    if typeof(rec.IsFavorite) == "boolean" then
        return rec.IsFavorite
    end
    return false
end

-------------------------------------------------------------
-- 3) Mutation names dari record
-------------------------------------------------------------
local function __mutation_names_from_record(rec)
    if type(rec) ~= "table" then return {} end

    local PD = rec.PetData or rec.Data or {}

    local raw =
        PD.MutationType or
        rec.MutationType  or
        PD.Mutations      or PD.Mutation or PD.MutationCodes or
        rec.Mutations     or rec.Mutation or rec.MutationCodes

    if not raw then
        return {}
    end

    local codes = {}

    if type(raw) == "string" then
        for c in raw:gmatch("%a") do
            table.insert(codes, c)
        end
    elseif type(raw) == "table" then
        for _, v in pairs(raw) do
            if type(v) == "string" then
                for c in v:gmatch("%a") do
                    table.insert(codes, c)
                end
            elseif type(v) == "table" and type(v.MutationType) == "string" then
                for c in v.MutationType:gmatch("%a") do
                    table.insert(codes, c)
                end
            end
        end
    end

    local names, seen = {}, {}
    for _, code in ipairs(codes) do
        local name = MUT_CODE_TO_NAME[code]
        if name and not seen[name] then
            seen[name] = true
            table.insert(names, name)
        end
    end

    return names
end

-------------------------------------------------------------
-- 4) Ambil bag dari datastore
-------------------------------------------------------------
local function __getStoreBag()
    if not ActivePetsService or not ActivePetsService.GetPlayerDatastorePetData then
        warn("[PetListView] ActivePetsService:GetPlayerDatastorePetData not available")
        return nil
    end

    local ok, store = pcall(function()
        return ActivePetsService:GetPlayerDatastorePetData(LocalPlayer.Name)
    end)
    if not ok then
        warn("[PetListView] GetPlayerDatastorePetData error:", store)
        return nil
    end
    if not store or not store.PetInventory or not store.PetInventory.Data then
        warn("[PetListView] Store/PetInventory/Data empty")
        return nil
    end

    return store.PetInventory.Data
end

------------------------------------------------------------
-- GBXP HELPERS (mirip logic syncGBXPFromStoreOnce lama)
------------------------------------------------------------
local function _getSelectedGlobal()
    local G = (getgenv and getgenv()) or _G
    return rawget(G, "selected") or rawget(getfenv(0), "selected") or {}
end

local function _normUUIDCore(u)
    if not u then return nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core
end

-- cek apakah uuid sudah dipakai di tab lain (noos/boost/xp/seratusage)
local function _in_other_tabs(uuid)
    local core = _normUUIDCore(uuid)
    if not core then return false end

    local sel = _getSelectedGlobal()
    local function has(tbl)
        if type(tbl) ~= "table" then return false end
        if tbl[uuid] or tbl["{"..core.."}"] or tbl[core] then
            return true
        end
        for k,_ in pairs(tbl) do
            local kc = _normUUIDCore(k)
            if kc == core then return true end
        end
        return false
    end

    return has(sel.noos) or has(sel.boost) or has(sel.xp) or has(sel.seratusage)
end

-- whitelist type (pakai _G.GBXP_TYPE_WHITELIST kalau ada)
local function _get_gbxp_whitelist()
    local G = (getgenv and getgenv()) or _G
    local w = rawget(G, "GBXP_TYPE_WHITELIST")
           or rawget(getfenv(0), "GBXP_TYPE_WHITELIST")
    if type(w) == "table" then
        return w
    end
    return nil
end

local function _gbxp_whitelist_match(petTypeNorm)
    petTypeNorm = tostring(petTypeNorm or ""):lower()
    if petTypeNorm == "" then return false end

    local w = _get_gbxp_whitelist()
    -- kalau whitelist nil atau kosong â†’ semua lolos
    if not w or (next(w) == nil) then
        return true
    end

    for key,_ in pairs(w) do
        local pat = tostring(key or ""):lower()
        if pat ~= "" and petTypeNorm:find(pat, 1, true) then
            return true
        end
    end
    return false
end

-- hitung W100 pakai helper yang SUDAH ada di file ini
local function _weight_at_100_for_rec(rec, uuid)
    local SCALE = SCALE_PER_LVL or 0
    local age   = __age_from_record(rec)
    local base  = __base_from_record(rec)
    local cur   = __current_from_record(rec)

    -- A) pakai base dari record
    if base then
        return base * (1 + SCALE * 100)
    end

    -- B) proyeksi dari current + age
    if cur and age then
        local delta = math.max(0, 100 - age)
        return cur * (1 + SCALE * delta)
    end

    return nil
end

-- keputusan final: boleh jadi kandidat GBXP atau tidak
local function _is_gbxp_candidate(rec, uuid, petTypeNorm, fav)
    -- ambil config global kalau ada, kalau tidak pakai default
    local G = (getgenv and getgenv()) or _G
    local AGE_CUTOFF          = rawget(G, "AGE_CUTOFF")          or 101
    local WEIGHT100_THRESHOLD = rawget(G, "WEIGHT100_THRESHOLD") or 120
    local GBXP_SKIP_FAVORITE  = rawget(G, "GBXP_SKIP_FAVORITE")
    if GBXP_SKIP_FAVORITE == nil then
        GBXP_SKIP_FAVORITE = true
    end

    -- non-favorite only
    if GBXP_SKIP_FAVORITE and fav then
        return false
    end

    -- type whitelist
    if not _gbxp_whitelist_match(petTypeNorm) then
        return false
    end

    -- age check
    local age = __age_from_record(rec)
    if not age or age >= AGE_CUTOFF then
        return false
    end

    -- W100 check
    local w100 = _weight_at_100_for_rec(rec, uuid)
    if not w100 or w100 >= WEIGHT100_THRESHOLD then
        return false
    end

    -- tidak dipakai tab lain
    if _in_other_tabs(uuid) then
        return false
    end

    return true
end

-------------------------------------------------------------
-- 5) List pet per tab
-------------------------------------------------------------
local function listPetsForTab(tabKey)
    local pets = {}

    local bag = __getStoreBag()
    if not bag then
        return pets
    end

    for rawUUID, rec in pairs(bag) do
        if type(rec) == "table" then
            local core, br = __normUUID(rawUUID)
            local uuid = br or core

            local fav = __is_favorite(rec) and true or false
            local PD  = rec.PetData or rec.Data or {}

            -- Ambil PetType
            local petTypeRaw =
                rec.Type or rec.PetType or
                PD.Type  or PD.PetType  or
                rec.Name or PD.Name     or
                "Pet"

            local petTypeLabel = tostring(petTypeRaw)
            local petTypeNorm  = petTypeLabel:lower()

            --------------------------------------------------------
            -- RULE FILTER PER TAB
            --------------------------------------------------------
            local allowed
            if tabKey == "gbxp" then
                -- FULL RULE: whitelist, non-fav, age < AGE_CUTOFF,
                -- W100 < WEIGHT100_THRESHOLD, tidak dipakai tab lain
                allowed = _is_gbxp_candidate(rec, uuid, petTypeNorm, fav)
            elseif tabKey == "noos" or tabKey == "boost"
                or tabKey == "xp" or tabKey == "seratusage" then
                -- Tab lain: hanya favorite
                allowed = (fav == true)
            else
                allowed = true
            end

            if allowed then
                -- Age / level sekarang
                local age = __age_from_record(rec) or 0

                -- BaseWeight dari datastore
                local base = __base_from_record(rec)

                -- KG sekarang
                local kgNow
                if base then
                    local lvl   = age or 0
                    local scale = SCALE_PER_LVL or 0
                    kgNow = base * (1 + scale * lvl)
                else
                    kgNow = __current_from_record(rec)
                end

                local ageText = age > 0 and string.format("Age %d", age) or "Age ?"
                local kgText  = kgNow and string.format("%.2f KG", kgNow) or "? KG"

                local mutNames  = __mutation_names_from_record(rec)
                local mutPrefix = ""
                if #mutNames > 0 then
                    mutPrefix = "[" .. table.concat(mutNames, ", ") .. "] "
                end

                local label = string.format("%s%s | %s | %s",
                    mutPrefix,
                    petTypeLabel,
                    ageText,
                    kgText
                )

                table.insert(pets, {
                    uuid   = uuid,
                    name   = label,
                    age    = age or 0,
                    kg     = kgNow or 0,
                    ptype  = petTypeNorm,
                })
            end
        end
    end

    table.sort(pets, function(a, b)
        if a.ptype == b.ptype then
            if a.age == b.age then
                return a.kg < b.kg
            end
            return a.age < b.age
        end
        return a.ptype < b.ptype
    end)

    return pets
end



local function buildPetItems()
    local list = {}

    for petName, cfg in pairs(PetList) do
        table.insert(list, {
            key   = petName,        -- dipakai sebagai key di selectedMap
            name  = petName,        -- teks di list
            right = cfg.Rarity,     -- optional: tampilkan rarity di kanan (kalau CreateRowDropdown support)
            icon  = cfg.Icon,       -- optional: kalau mau dipakai icon
                     -- simpan config full kalau perlu
        })
    end

    table.sort(list, function(a, b)
        return a.name < b.name
    end)

    return list
end


local DataService
do
    local ok, mod = pcall(function()
        return require(ReplicatedStorage.Modules.DataService)
    end)
    if ok then
        DataService = mod
    else
        warn("[PetListView] Gagal require DataService:", mod)
    end
end

local function __getInventoryDataTable()
    if not DataService or type(DataService.GetData) ~= "function" then
        warn("[PetListView] DataService atau GetData tidak tersedia")
        return nil
    end

    local ok, profile = pcall(function()
        return DataService:GetData()
    end)
    if not ok or type(profile) ~= "table" then
        warn("[PetListView] DataService:GetData() gagal / profile bukan table:", profile)
        return nil
    end

    local inv = profile.InventoryData
    if type(inv) ~= "table" then
        warn("[PetListView] profile.InventoryData kosong / bukan table")
        return nil
    end

    return inv
end


-------------------------------------------------------------
-- 6) List Item PetBoost dari InventoryData + Backpack
-------------------------------------------------------------
local function __listPetBoostItems()
    local items = {}

    local inv = __getInventoryDataTable()
    if type(inv) ~= "table" then
        return items
    end

    for rawUUID, rec in pairs(inv) do
        if type(rec) == "table" and rec.ItemType == "PetBoost" then
            local coreUUID = __normUUID(rawUUID)
            if coreUUID then
                -- ðŸ” CARI TOOL DI BACKPACK DULU
                local prettyName = nil
                for _, tool in ipairs(Backpack:GetChildren()) do
                    local attr = tool:GetAttribute("c") or tool:GetAttribute("C")
                    if attr then
                        local attrCore = __normUUID(attr)
                        if attrCore == coreUUID then
                            prettyName = tool.Name
                            break
                        end
                    end
                end

                -- â— KALAU TIDAK KETEMU DI BACKPACK â†’ SKIP
                if prettyName and prettyName ~= "" then
                    table.insert(items, {
                        key  = coreUUID,   -- DISIMPAN: UUID
                        name = prettyName, -- TAMPIL: nama tool di Backpack SAJA
                    })
                end
            end
        end
    end

    table.sort(items, function(a, b)
        return a.name < b.name
    end)

    return items
end




local M = {}

function M.buildEntriesForTab(tabKey, selectedSet)
    selectedSet = selectedSet or {}
    local pets = listPetsForTab(tabKey)

    if tabKey == "gbxp" then
        local empty = true
        for _, v in pairs(selectedSet) do
            if v then empty = false break end
        end
        if empty then
            for _, p in ipairs(pets) do
                selectedSet[p.uuid] = true
            end
        end
    end

    local result = {}
    for _, p in ipairs(pets) do
        table.insert(result, {
            key  = p.uuid,
            name = p.name,
        })
    end
    return result
end

-- ðŸ”¹ INI WAJIB ADA
function M.listPetsForTab(tabKey)
    return listPetsForTab(tabKey)
end

function M.listAllMutations()
    return MUTATION_LIST
end

function M.buildPetItems()
    return buildPetItems()
end

function M.buildPetBoostItems()
    return __listPetBoostItems()
end

-- Tambahan API untuk module lain (misalnya gift.lua)
-- Mengembalikan:
--   bag     â†’ tabel datastore (store.PetInventory.Data)
--   index   â†’ map [core/bracedUUID] = rec
--   helpers â†’ table berisi fungsi-fungsi helper (age, favorite, mutasi, w100, dll)
function M.getDatastoreBagIndex()
    local bag = __getStoreBag()
    if not bag then
        return nil, nil, nil
    end

    local index = {}
    for rawUUID, rec in pairs(bag) do
        if type(rec) == "table" then
            local core, br = __normUUID(rawUUID)
            if core then
                index[core] = rec
                if br then
                    index[br] = rec
                end
            end
        end
    end

    local helpers = {
        normUUID                   = __normUUID,
        age_from_record            = __age_from_record,
        base_from_record           = __base_from_record,
        current_from_record        = __current_from_record,
        is_favorite                = __is_favorite,
        mutation_names_from_record = __mutation_names_from_record,
        weight_at_100_for_rec      = _weight_at_100_for_rec,
    }

    return bag, index, helpers
end


-- WorldShardCleaner.lua
-- Auto-cleanse world pets dengan mutasi BURUK saja (selain yang kamu tandai GOOD_MUTATIONS / dari GBXP UI).
-- â€¢ Mapping enum/huruf â†’ nama penuh via PetMutationRegistry (Nightmare = "A" aman)
-- â€¢ Auto equip/unequip Cleansing Shard
-- â€¢ Scan world models milik player sendiri
-- â€¢ Rate limit ApplyShard

-------------------------- Services & Modules --------------------------
local Players = game:GetService("Players")
local RS      = game:GetService("ReplicatedStorage")
local WS      = game:GetService("Workspace")
local CS      = game:GetService("CollectionService")

local LP = Players.LocalPlayer

-- Modules (ubah path bila berbeda di game kamu)
local ActivePetsService = require(RS.Modules.PetServices.ActivePetsService)

-- Registry resmi (dump yang kamu kirim)
local PetMutReg          = require(RS.Data.PetRegistry.PetMutationRegistry)  -- berisi EnumToPetMutation & PetMutationToEnum
local EnumToPetMutation  = PetMutReg and PetMutReg.EnumToPetMutation or nil

------------------------------ DEBUG -----------------------------------
local DEBUG            = false
local TRACE_OWNER      = false
local TRACE_MUT_READ   = false
local TRACE_WORLD_SCAN = false

local function dprint(tag, ...)
    if DEBUG then
        print(("[ShardDebug/%s]"):format(tag), ...)
    end
end

local function dx(tag, ...)
    warn(("[ShardDebug/%s]"):format(tag), ...)
end

local function sf(fmt, ...)
    local ok, msg = pcall(string.format, fmt, ...)
    return ok and msg or (tostring(fmt) .. " (fmt-error)")
end

------------------------------- Config ---------------------------------
local TARGET_PLAYER_NAME = LP and LP.Name or ""
local ROOTS = {
    WS:FindFirstChild("PetsPhysical"),
    WS:FindFirstChild("ActivePets"),
    WS:FindFirstChild("PetMover"),
    WS, -- fallback, kalau struktur berbeda
}

-- Mutasi yang DIANGGAP BAIK (TIDAK di-cleanse), disimpan lowercase.
-- Default: nightmare/jumbo/mega/tethered/rainbow
local GOOD_MUTATIONS = {
    ["nightmare"] = true,
    ["jumbo"]     = true,
    ["mega"]      = true,
    ["tethered"]  = true,
    ["rainbow"]   = true,
    ["hyperhunger"]   = true,
}

local SCAN_EVERY = 3
local EQUIP_WAIT = 1
local APPLY_GAP  = 1.5 -- rate limit antar ApplyShard

------------------------------ Remote ----------------------------------
local ge      = RS:FindFirstChild("GameEvents")
local ShardRE = ge and ge:FindFirstChild("PetShardService_RE")

------------------------------ Helpers ---------------------------------
local function normalizeUUID(u)
    if not u then return nil, nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core, "{" .. core .. "}"
end

local function ownedByTargetFromMover(mover)
    -- Beberapa game beda nama atribut
    local ownerName = mover:GetAttribute("OWNER")
        or mover:GetAttribute("Owner")
        or mover:GetAttribute("OwnerName")
        or mover:GetAttribute("Player")

    if TRACE_OWNER then
        dprint("OWNER", sf("mover=%s ownerAttr=%s", mover:GetFullName(), tostring(ownerName)))
    end

    return ownerName == TARGET_PLAYER_NAME
end

-- Ambil record pet dari datastore berdasarkan UUID
local function getPetRecordForUUID(uuid)
    if not uuid or uuid == "" then return nil end

    local core, braced = normalizeUUID(uuid)

    local okStore, store = pcall(function()
        return ActivePetsService:GetPlayerDatastorePetData(Players.LocalPlayer.Name)
    end)

    if not okStore or not store or not store.PetInventory or not store.PetInventory.Data then
        return nil
    end

    local bag = store.PetInventory.Data
    local rec = bag[core] or bag[braced]
    if type(rec) == "table" then
        return rec
    end

    return nil
end

-- Cek apakah pet di-favorite oleh player
local function isFavoriteUUID(uuid)
    local rec = getPetRecordForUUID(uuid)
    if not rec then
        return false
    end

    -- Beberapa kemungkinan nama field favorit
    local fav =
        rec.IsFavourite or rec.IsFavorite or rec.Favorite or
        (rec.PetData and (rec.PetData.IsFavourite or rec.PetData.IsFavorite or rec.PetData.Favorite))

    return fav == true
end

-- Ambil mutationType dari datastore pemain (bisa huruf 1 char atau nama penuh)
local function getRawMutationFromUUID(uuid)
    if not uuid or uuid == "" then return "" end

    local rec = getPetRecordForUUID(uuid)
    if rec then
        local mt = rec.MutationType or (rec.PetData and rec.PetData.MutationType)
        if type(mt) == "string" and mt ~= "" then
            return mt
        end
    end

    return ""
end



-- Normalisasi: huruf tunggal (termasuk "A") â†’ nama penuh via registry; kalau sudah nama, jadikan lowercase
local function normalizeMutationNameLower(raw)
    if not raw or raw == "" then return "" end

    local s = tostring(raw)
    if #s == 1 and EnumToPetMutation then
        -- registry bisa case-sensitive; coba 3 varian
        local full = EnumToPetMutation[s] or EnumToPetMutation[s:lower()] or EnumToPetMutation[s:upper()]
        if type(full) == "string" and full ~= "" then
            return full:lower()
        end
        -- fallback: kembalikan huruf (akan dianggap bukan bad jika tak cocok nama good)
        return s:lower()
    end

    return s:lower()
end

local function isBadMutation(raw)
    local nm = normalizeMutationNameLower(raw)

    -- kalau tidak ada mutasi sama sekali, jangan di-cleanse
    if nm == "" then
        return false
    end

    -- bad = semua mutasi yang TIDAK ada di GOOD_MUTATIONS
    return not GOOD_MUTATIONS[nm]
end

-------------------------- Bridge dari UI GBXP --------------------------
_G.WorldShardCleaner = _G.WorldShardCleaner or {}

-- gbxpTable = GBXP_MUT_SELECTED dari UI (nama mutasi -> boolean)
function _G.WorldShardCleaner:setGoodMutationsFromGBXP(gbxpTable)
    if type(gbxpTable) ~= "table" then return end

    GOOD_MUTATIONS = {}

    for mutName, on in pairs(gbxpTable) do
        if on then
            local key = tostring(mutName):lower()
            GOOD_MUTATIONS[key] = true
        end
    end

    -- dprint("CFG", "[ShardCleaner] GOOD_MUTATIONS updated from GBXP_MUT_SELECTED")
end

------------------------- World Model Collector -------------------------
local function hasTagSafe(inst, tag)
    -- Beberapa game monkey-patch :HasTag; tetap utamakan CollectionService
    local okCs = pcall(function()
        return CS:HasTag(inst, tag)
    end)
    if okCs then
        return CS:HasTag(inst, tag)
    end

    if typeof(inst.HasTag) == "function" then
        local ok, res = pcall(inst.HasTag, inst, tag)
        if ok then return res end
    end

    return false
end

local function collectPetModelsForOwner()
    local out, seen = {}, {}

    for _, root in ipairs(ROOTS) do
        if root then
            for _, inst in ipairs(root:GetDescendants()) do
                if inst:IsA("Model") and hasTagSafe(inst, "PetModel") then
                    local mover = inst.Parent
                    if mover and mover:IsA("BasePart") and ownedByTargetFromMover(mover) then
                        local uuid = mover:GetAttribute("UUID")
                            or mover:GetAttribute("Guid")
                            or mover:GetAttribute("GUID")
                            or mover:GetAttribute("Id")

                        local core = uuid and normalizeUUID(uuid)
                        core = type(core) == "table" and core[1] or core
                        if core and not seen[core] then
                            seen[core] = true
                            table.insert(out, { uuid = core, model = inst, mover = mover })
                        end
                    end
                end
            end
        end
    end

    if TRACE_WORLD_SCAN then
        dprint("SCAN", sf("Kumpul %d pet model milik %s", #out, TARGET_PLAYER_NAME))
    end

    return out
end

------------------------- Auto Equip / Unequip --------------------------
local function getShardTool()
    local backpack = LP:FindFirstChild("Backpack")
    if not backpack then return nil end

    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA("Tool") and tool.Name:find("Cleansing") then
            return tool
        end
    end

    return nil
end

-- Unequip SEMUA tool dari character â†’ pindah ke Backpack
local function unequipAllToolsFromCharacter()
    local char     = LP.Character
    local backpack = LP:FindFirstChild("Backpack") or LP.Backpack

    if not char or not backpack then
        return
    end

    for _, inst in ipairs(char:GetChildren()) do
        if inst:IsA("Tool") then
            inst.Parent = backpack
        end
    end
end

local function isEquipped()
    local char = LP.Character
    if not char then return false, nil end

    for _, tool in ipairs(char:GetChildren()) do
        if tool:IsA("Tool") and tool.Name:find("Cleansing") then
            return true, tool
        end
    end

    return false, nil
end

-- Pastikan Cleansing Shard KEPEgang:
-- 1) kalau sudah pegang â†’ ok
-- 2) kalau belum:
--    - unequip semua tool lain dari character
--    - ambil shard dari Backpack
--    - equip ke character
local function ensureEquipped()
    local char = LP.Character
    if not char then
        dx("EQUIP", "Character belum siap, skip equip shard")
        return false
    end

    -- kalau sudah pegang shard â†’ langsung ok
    local eq, tool = isEquipped()
    if eq and tool then
        return true, tool
    end

    -- sebelum equip shard, lepas SEMUA tool dari character
    unequipAllToolsFromCharacter()

    -- cari shard di backpack
    local shard = getShardTool()
    if not shard then
        dx("EQUIP", "Shard tidak ditemukan di Backpack!")
        return false
    end

    dprint("EQUIP", "Equipping shard...")
    shard.Parent = char
    task.wait(EQUIP_WAIT)

    -- double check
    local ok2, tool2 = isEquipped()
    if ok2 and tool2 then
        return true, tool2
    else
        dx("EQUIP", "Gagal equip Cleansing Shard (tidak muncul di character)")
        return false
    end
end

-- Lepas shard dari character (balik ke Backpack)
local function ensureUnequipped()
    local eq, tool = isEquipped()
    if eq and tool then
        dprint("EQUIP", "Unequipping shard...")
        tool.Parent = LP:FindFirstChild("Backpack") or LP.Backpack
        task.wait(EQUIP_WAIT)
    end
end

----------------------------- Cleanse call ------------------------------
local _lastSendAt = 0

local function fireCleanseModel(model)
    if not ShardRE then
        dx("SHARD", "Remote PetShardService_RE tidak ditemukan.")
        return false
    end

    local now   = workspace:GetServerTimeNow()
    local since = now - _lastSendAt
    if since < APPLY_GAP then
        task.wait(APPLY_GAP - since)
    end
    _lastSendAt = workspace:GetServerTimeNow()

    local ok, err = pcall(function()
        -- Sesuai log kamu: "ApplyShard", <Instance>
        ShardRE:FireServer("ApplyShard", model)
    end)

    if ok then
        dprint("SHARD", "ApplyShard OK â†’", model:GetFullName())
        return true
    else
        dx("SHARD", "ApplyShard error:", tostring(err))
        return false
    end
end

------------------------------- Main ------------------------------------
local RUN = false

task.spawn(function()
    while true do
        if RUN then
            local pets       = collectPetModelsForOwner()
            local badTargets = {}

            -- filter pet dengan mutasi "buruk"
                        -- filter pet dengan mutasi "buruk"
            for _, it in ipairs(pets) do
                -- ðŸ”’ SKIP kalau pet ini favorite
                if isFavoriteUUID(it.uuid) then
                    if DEBUG then
                        dprint("FAV", sf("Skip shard untuk pet favorite uuid=%s", tostring(it.uuid)))
                    end
                else
                    local raw = getRawMutationFromUUID(it.uuid)
                    local bad = isBadMutation(raw)

                    if TRACE_MUT_READ then
                        dx(
                            "MUT",
                            sf(
                                "uuid=%s raw=%s -> norm=%s -> bad=%s",
                                tostring(it.uuid),
                                tostring(raw),
                                normalizeMutationNameLower(raw),
                                tostring(bad)
                            )
                        )
                    end

                    if bad then
                        table.insert(badTargets, it)
                    end
                end
            end


            if #badTargets > 0 then
                -- sebelum cleanse: pastikan shard ke-equip (akan auto unequip semua tool lain)
                if ensureEquipped() then
                    for _, it in ipairs(badTargets) do
                        fireCleanseModel(it.model)
                        task.wait(0.10)
                    end
                end

                -- sesudah dipakai, shard dilepas lagi
                ensureUnequipped()
            else
                -- tidak ada bad pet, pastikan shard juga tidak nempel di tangan
                ensureUnequipped()
            end

            dprint("LOOP", sf("Selesai loop | badCount=%d", #badTargets))
        end

        task.wait(SCAN_EVERY)
    end
end)

------------------------------- Hotkeys / Bridge ------------------------
function _G.WorldShardCleaner:getRun()
    return RUN
end

function _G.WorldShardCleaner:setRun(v)
    RUN = not not v
    -- dprint("CFG", "[ShardCleaner] RUN => " .. (RUN and "ON" or "OFF"))
end

-- Alias lebih jelas untuk dipakai dari UI / state
function _G.WorldShardCleaner:setEnabled(v)
    self:setRun(v)
end
-- boost.lua
-- Auto apply PetBoost item ke pet AKTIF
-- Filter:
--   â€¢ SELECTED_PET_TYPES  â†’ pet-type yang di-boost (kosong = ALL)
--   â€¢ PETBOOST_SELECTED  â†’ daftar PetBoost (UUID) yang dipakai
-- TANPA cek PASSIVE_BOOST
-- Interval pakai AUTO_BOOST_DELAY (default 20)

local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LP = Players.LocalPlayer

local ActivePetsService = require(
    ReplicatedStorage.Modules.PetServices.ActivePetsService
)

local ge = ReplicatedStorage:FindFirstChild("GameEvents")
        or ReplicatedStorage:FindFirstChild("gameEvents")

local PetBoostRE = ge and ge:FindFirstChild("PetBoostService")

----------------------------------------------------------------
-- CONFIG & DEBUG
----------------------------------------------------------------
local DEFAULT_DELAY       = 20
local AUTO_BOOST_RUNNING  = false
local AUTO_BOOST_THREAD   = nil
local STOP_TOKEN          = 0

local DEBUG_BOOST = false

local function bprint(...)
    if DEBUG_BOOST then
        print("[AutoKGBoost]", ...)
    end
end

local function bwarn(...)
    if DEBUG_BOOST then
        warn("[AutoKGBoost]", ...)
    end
end

----------------------------------------------------------------
-- UUID helpers
----------------------------------------------------------------
local function normalizeUUID(u)
    if not u then return nil, nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core, "{" .. core .. "}"
end

----------------------------------------------------------------
-- Unequip semua tools di character
----------------------------------------------------------------
local function unequipAllTools()
    local char     = LP.Character
    local backpack = LP:FindFirstChild("Backpack") or LP.Backpack
    if not char or not backpack then return end

    for _, inst in ipairs(char:GetChildren()) do
        if inst:IsA("Tool") then
            inst.Parent = backpack
        end
    end
end

----------------------------------------------------------------
-- Cari boost tool di Backpack berdasarkan UUID
----------------------------------------------------------------
local function findBoostToolByUUID(boostUUID)
    if not boostUUID then return nil end

    local boostCore = select(1, normalizeUUID(boostUUID))
    if not boostCore then return nil end

    local backpack = LP:FindFirstChild("Backpack") or LP.Backpack
    if not backpack then return nil end

    for _, tool in ipairs(backpack:GetChildren()) do
        if tool:IsA("Tool") then
            local attr = tool:GetAttribute("c") or tool:GetAttribute("C")
            if attr then
                local attrCore = select(1, normalizeUUID(attr))
                if attrCore == boostCore then
                    return tool
                end
            end
        end
    end

    return nil
end

local function equipTool(tool)
    local char = LP.Character
    if not char or not tool then return false end

    unequipAllTools()
    tool.Parent = char
    task.wait(0.4)
    return true
end

----------------------------------------------------------------
-- Pet type filter
----------------------------------------------------------------
local function buildSelectedPetTypeMap()
    local map = _G.SELECTED_PET_TYPES or SELECTED_PET_TYPES or {}

    local hasAny = false
    for _, enabled in pairs(map) do
        if enabled then
            hasAny = true
            break
        end
    end

    if not hasAny then
        return nil -- ALL
    end

    local out = {}
    for petName, enabled in pairs(map) do
        if enabled then
            out[tostring(petName):lower()] = true
        end
    end
    return out
end

----------------------------------------------------------------
-- Ambil active pets sesuai filter
----------------------------------------------------------------
local function getActivePetsFiltered()
    local out = {}

    local cps = ActivePetsService.ClientPetState
    if type(cps) ~= "table" then return out end

    local perPlayer = cps[LP] or cps[LP.UserId] or cps[LP.Name]
    if type(perPlayer) ~= "table" then return out end

    local selectedMap = buildSelectedPetTypeMap()

    for uuidKey, handlers in pairs(perPlayer) do
        if type(handlers) == "table" then
            local rec = handlers.PetModelHandler
                    or handlers.PetVFXHandler
                    or handlers.PetSoundHandler

            if type(rec) == "table" then
                local pd = rec.PetData or rec.Data or {}
                local pt = pd.PetType or rec.PetType or rec.Name

                local petTypeName  = pt and tostring(pt) or ""
                local petTypeLower = petTypeName:lower()

                local allowed = (selectedMap == nil) or selectedMap[petTypeLower]
                if allowed then
                    local core, braced = normalizeUUID(rec.UUID or uuidKey)
                    table.insert(out, {
                        uuidCore   = core,
                        uuidBraced = braced,
                        petType    = petTypeName,
                    })
                end
            end
        end
    end

    return out
end

----------------------------------------------------------------
-- Ambil boost UUID terpilih
----------------------------------------------------------------
local function getSelectedBoostUUIDs()
    local list = {}
    local src = _G.PETBOOST_SELECTED or PETBOOST_SELECTED

    if type(src) ~= "table" then
        return list
    end

    for uuid, enabled in pairs(src) do
        if enabled then
            table.insert(list, uuid)
        end
    end

    return list
end

----------------------------------------------------------------
-- APPLY BOOST SEKALI (TANPA PASSIVE CHECK)
-- + bisa diputus cepat kalau STOP (token berubah / running false)
----------------------------------------------------------------
local function applyAutoBoostOnce(myToken)
    if not PetBoostRE then return false end
    if (not AUTO_BOOST_RUNNING) or (myToken ~= STOP_TOKEN) then return false end

    local boostUUIDs = getSelectedBoostUUIDs()
    if #boostUUIDs == 0 then return false end

    local pets = getActivePetsFiltered()
    if #pets == 0 then return false end

    local usedAny = false

    for _, info in ipairs(pets) do
        if (not AUTO_BOOST_RUNNING) or (myToken ~= STOP_TOKEN) then break end

        local uuidBraced = info.uuidBraced
        local petType    = info.petType or "?"

        bprint("Boost pet:", petType, uuidBraced)

        for _, boostUUID in ipairs(boostUUIDs) do
            if (not AUTO_BOOST_RUNNING) or (myToken ~= STOP_TOKEN) then break end

            local tool = findBoostToolByUUID(boostUUID)
            if tool and equipTool(tool) then
                if (not AUTO_BOOST_RUNNING) or (myToken ~= STOP_TOKEN) then
                    unequipAllTools()
                    break
                end

                task.wait(0.2)

                local ok = pcall(function()
                    PetBoostRE:FireServer("ApplyBoost", uuidBraced)
                end)

                if ok then
                    usedAny = true
                    bprint("ApplyBoost OK:", uuidBraced, tool.Name)
                end

                task.wait(0.2)
                unequipAllTools()
            end
        end
    end

    return usedAny
end

----------------------------------------------------------------
-- PUBLIC MODULE
----------------------------------------------------------------
local M = {}

function M.isRunning()
    return AUTO_BOOST_RUNNING
end

function M.setDelay(v)
    local n = tonumber(v)
    if not n or n <= 0 then return end
    n = math.floor(n + 0.5) -- rapihin
    AUTO_BOOST_DELAY = n
    _G.AUTO_BOOST_DELAY = n
end

function M.stop()
    AUTO_BOOST_RUNNING = false
    STOP_TOKEN += 1           -- âœ… matikan loop yang sedang jalan
    AUTO_BOOST_THREAD  = nil
    pcall(unequipAllTools)    -- âœ… bersih
end

function M.start()
    if AUTO_BOOST_RUNNING then return end
    AUTO_BOOST_RUNNING = true

    local myToken = STOP_TOKEN

    AUTO_BOOST_THREAD = task.spawn(function()
        while AUTO_BOOST_RUNNING and (myToken == STOP_TOKEN) do
            pcall(applyAutoBoostOnce, myToken)

            local delay = tonumber(_G.AUTO_BOOST_DELAY or AUTO_BOOST_DELAY) or DEFAULT_DELAY
            delay = math.max(delay, 1)

            local t = delay
            while t > 0 and AUTO_BOOST_RUNNING and (myToken == STOP_TOKEN) do
                task.wait(1)
                t -= 1
            end
        end
    end)
end

function M.syncFromState()
    local d = tonumber(_G.AUTO_BOOST_DELAY or AUTO_BOOST_DELAY) or DEFAULT_DELAY
    M.setDelay(d)

    if AUTO_BOOST_ENABLED == true then
        M.start()
    else
        M.stop()
    end
end
-- gift.lua
-- Auto Gift NodeHub (pakai PetListView sebagai data core)
-- â€¢ Scan Tool pet di Backpack
-- â€¢ Ambil record dari datastore via PetListView.getDatastoreBagIndex()
-- â€¢ Filter per row GIFT_CFG (Gift 1/2/3):
--      enabled / enabledB / enabledC
--      targets / targetsB / targetsC
--      minKG / minKGB / minKGC  (pakai W100, negatif = batas atas)
--      minAge / minAgeB / minAgeC (negatif = batas atas)
--      petType / petTypeB / petTypeC (map petName â†’ true, kosong = off)
-- â€¢ Filter mutasi (GIFT_MUT_SELECTED, kalau ada)
-- â€¢ Skip favorite
-- â€¢ Router target: player dengan pet Tool paling sedikit di Backpack

----------------------------------------------------------------
-- SERVICES & MODULES
----------------------------------------------------------------
local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer

-- Backpack ref (akan di-refresh lagi kalau CharacterAdded)
local Backpack = LocalPlayer:WaitForChild("Backpack")

----------------------------------------------------------------
-- PET LIST VIEW RESOLVER
-- â€¢ Tidak pakai require, karena module sudah di-load via main.lua
-- â€¢ Ambil dari getgenv() / _G.PetListView
-- â€¢ Lazy-resolve setiap kali dipanggil, supaya aman kalau race load
----------------------------------------------------------------
local PetListView

local function _resolvePetListView()
    if PetListView then
        return PetListView
    end

    local G = (getgenv and getgenv()) or _G
    if G and type(G.PetListView) == "table" then
        PetListView = G.PetListView
        return PetListView
    end

    return nil
end


-- Gifting service (sesuaikan path kalau beda)
local PetGiftingService
do
    local ok, mod = pcall(function()
        return require(ReplicatedStorage.Modules.PetServices.PetGiftingService)
    end)
    if ok then
        PetGiftingService = mod
    else
        --warn("[Gift] Gagal require PetGiftingService:", mod)
    end
end

----------------------------------------------------------------
-- CONFIG / DEBUG
----------------------------------------------------------------
local AUTO_GIFT_SCAN_INTERVAL      = 1      -- detik antar scan
local AUTO_GIFT_MAX_SEND_PER_PASS  = 1      -- maksimal pet per loop
local AUTO_GIFT_GIFT_DELAY         = 1.2    -- jeda kecil setelah gift
local AUTO_GIFT_DEBUG              = false  -- ubah ke true untuk debug

GIFT_CFG = GIFT_CFG or {}

----------------------------------------------------------------
-- DEBUG UTIL
----------------------------------------------------------------
local function dbg(...)
    if AUTO_GIFT_DEBUG then
        print("[AutoGift]", ...)
    end
end

local function _debugSkip(tag, reason, ...)
    if not AUTO_GIFT_DEBUG then return end
    print("[AutoGift][SKIP]", "["..tostring(tag).."]", reason, ...)
end

----------------------------------------------------------------
-- BACKPACK & TOOL HELPER
----------------------------------------------------------------
local function _getBackpack()
    return LocalPlayer:FindFirstChildOfClass("Backpack")
        or LocalPlayer:FindFirstChild("Backpack")
end

local function _isPetTool(t)
    if not (t and t:IsA("Tool")) then return false end
    local it = t:GetAttribute("ItemType") or t:GetAttribute("Itemtype")
    return it and string.lower(tostring(it)) == "pet"
end

local function _countTargetBackpack(plr)
    if not (plr and plr:IsA("Player")) then
        return math.huge
    end
    local bp = plr:FindFirstChild("Backpack")
    if not bp then
        return math.huge
    end
    local cnt = 0
    for _, child in ipairs(bp:GetChildren()) do
        if _isPetTool(child) then
            cnt += 1
        end
    end
    return cnt
end

local function _pickLeastBackpackTarget(targets)
    if type(targets) ~= "table" or #targets == 0 then
        return nil
    end
    if #targets == 1 then
        return targets[1]
    end

    local best, bestCnt
    for _, p in ipairs(targets) do
        local c = _countTargetBackpack(p)
        if not best or c < bestCnt then
            best = p
            bestCnt = c
        end
    end
    return best or targets[1]
end

local function _unequipAllTools()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hum  = char:FindFirstChildOfClass("Humanoid")
    if hum then
        pcall(function() hum:UnequipTools() end)
    end

    local bp = _getBackpack()
    if not (bp and char) then return end

    for _, t in ipairs(char:GetChildren()) do
        if t:IsA("Tool") then
            t.Parent = bp
        end
    end
    task.wait(0.05)
end

----------------------------------------------------------------
-- TARGET: GIFT_CFG.targets / targetsB / targetsC
----------------------------------------------------------------
local function _getGiftTargets(which)
    which = which or "targets"
    local result = {}

    if GIFT_CFG and GIFT_CFG[which] and next(GIFT_CFG[which]) ~= nil then
        for key, info in pairs(GIFT_CFG[which]) do
            local userId = info.userId or tonumber(key)
            local name   = info.name

            local plr
            if userId then
                plr = Players:GetPlayerByUserId(userId)
            end

            if (not plr) and name and name ~= "" then
                local want = string.lower(name)
                for _, p in ipairs(Players:GetPlayers()) do
                    if string.lower(p.Name) == want then
                        plr = p
                        break
                    end
                end
            end

            if plr then
                table.insert(result, plr)
            end
        end

        return result
    end

    -- fallback lama (kalau config lama masih ada)
    if which == "targets" then
        local target
        if GIFT_CFG and GIFT_CFG.targetUserId then
            target = Players:GetPlayerByUserId(GIFT_CFG.targetUserId)
        end
        if (not target) and GIFT_CFG and GIFT_CFG.targetName and GIFT_CFG.targetName ~= "" then
            local want = string.lower(GIFT_CFG.targetName)
            for _, p in ipairs(Players:GetPlayers()) do
                if string.lower(p.Name) == want then
                    target = p
                    break
                end
            end
        end
        if target then
            table.insert(result, target)
        end
    end

    return result
end

----------------------------------------------------------------
-- PET TYPE FILTER (petType / petTypeB / petTypeC)
----------------------------------------------------------------
local function _passesPetType(petTypeNorm, cfgMap)
    if not cfgMap or type(cfgMap) ~= "table" then
        -- tidak ada map â†’ filter off
        return true
    end

    local hasAny = false
    for _, v in pairs(cfgMap) do
        if v then
            hasAny = true
            break
        end
    end

    if not hasAny then
        -- tidak ada yang dipilih â†’ filter off (semua boleh)
        return true
    end

    if not petTypeNorm or petTypeNorm == "" then
        return false
    end

    -- key di cfg adalah nama pet dari PetList (misalnya "Dragon")
    for key, enabled in pairs(cfgMap) do
        if enabled then
            if petTypeNorm == tostring(key):lower() then
                return true
            end
        end
    end

    return false
end

----------------------------------------------------------------
-- W100 / AGE FILTER (negatif = batas atas)
----------------------------------------------------------------
local function _passesGiftGroup(weightArg, age, kgRaw, ageRaw)
    kgRaw  = tonumber(kgRaw)  or 0
    ageRaw = tonumber(ageRaw) or 0

    local kgLimit   = math.abs(kgRaw)
    local ageLimit  = math.abs(ageRaw)
    local useMaxKG  = (kgRaw  < 0)
    local useMaxAge = (ageRaw < 0)

    if kgLimit > 0 then
        if (not useMaxKG) and weightArg < kgLimit then
            return false
        elseif useMaxKG and weightArg > kgLimit then
            return false
        end
    end

    if ageLimit > 0 then
        if (not useMaxAge) and age < ageLimit then
            return false
        elseif useMaxAge and age > ageLimit then
            return false
        end
    end

    return true
end

----------------------------------------------------------------
-- MUTASI FILTER (GIFT_MUT_SELECTED)
----------------------------------------------------------------
local function _matchGiftMutation(rec, helpers)
    if not GIFT_MUT_SELECTED then
        return true
    end

    local hasSelected = false
    for _, v in pairs(GIFT_MUT_SELECTED) do
        if v then hasSelected = true break end
    end

    if not hasSelected then
        dbg("mut_filter_off (no selection)")
        return true
    end

    local muts = helpers.mutation_names_from_record(rec)
    if #muts == 0 then
        dbg("mut_empty â†’ skip")
        return false
    end

    local sel = {}
    for k, v in pairs(GIFT_MUT_SELECTED) do
        if v then
            sel[string.lower(k)] = true
        end
    end

    for _, m in ipairs(muts) do
        if sel[string.lower(m)] then
            dbg("mut_match", table.concat(muts, "+"))
            return true
        end
    end

    dbg("mut_no_match", table.concat(muts, "+"))
    return false
end

----------------------------------------------------------------
-- CORE GIVE
----------------------------------------------------------------
local function _give(uuidFmt, target, tool)
    if not PetGiftingService then
        _debugSkip(uuidFmt, "PetGiftingService_nil")
        return false
    end

    local useTool = tool

    -- cari Tool kalau belum dikasih (fallback)
    if (not useTool) then
        local bp = _getBackpack()
        if bp then
            for _, t in ipairs(bp:GetChildren()) do
                if t:IsA("Tool") then
                    local id = t:GetAttribute("PET_UUID")
                        or t:GetAttribute("UUID")
                        or t:GetAttribute("PetUUID")
                    if id then
                        local coreAttr = tostring(id):match("{?([0-9a-fA-F%-]+)}?") or tostring(id)
                        local fmtAttr  = "{"..coreAttr.."}"
                        if fmtAttr == uuidFmt or coreAttr == uuidFmt then
                            useTool = t
                            break
                        end
                    end
                end
            end
        end
    end

    if useTool then
        dbg("give via tool", uuidFmt, useTool.Name)
        _unequipAllTools()
        task.wait(1)
        useTool.Parent = LocalPlayer.Character
        task.wait(1)

        local ok, res = pcall(function()
            return PetGiftingService:GivePet(target)
        end)
        if not ok then
            _debugSkip(uuidFmt, "GivePet_tool_err", res)
        end

        task.wait(1)
        _unequipAllTools()
        task.wait(AUTO_GIFT_GIFT_DELAY)
        return ok and res ~= false
    end

    dbg("give direct", uuidFmt)
    local ok, res = pcall(function()
        return PetGiftingService:GivePet(uuidFmt, target)
    end)
    if not ok then
        _debugSkip(uuidFmt, "GivePet_direct_err", res)
    end
    task.wait(AUTO_GIFT_GIFT_DELAY)
    return ok and res ~= false
end

----------------------------------------------------------------
-- 1 PASS: SCAN BACKPACK & FILTER BY GIFT_CFG
----------------------------------------------------------------
local function _autoGiftPass()
    local PLV = _resolvePetListView()
    if not PLV or type(PLV.getDatastoreBagIndex) ~= "function" then
        _debugSkip("PASS", "PetListView/getDatastoreBagIndex belum siap")
        return
    end

    local bp = _getBackpack()
    if not bp then
        _debugSkip("PASS", "backpack_nil")
        return
    end

    local bag, index, helpers = PetListView.getDatastoreBagIndex()
    if not bag or not index or not helpers then
        _debugSkip("PASS", "datastore_bag_nil")
        return
    end

    local cfg = GIFT_CFG or {}

    -- Build target list per row
    local targets1 = _getGiftTargets("targets")
    local targets2 = _getGiftTargets("targetsB")
    local targets3 = _getGiftTargets("targetsC")

    local groups = {}

    local function addGroup(id, enabledKey, targets, kgKey, ageKey, petTypeKey)
        if not (cfg[enabledKey] == true) then
            return
        end
        if not (targets and #targets > 0) then
            return
        end

        table.insert(groups, {
            id         = id,
            targets    = targets,
            kgRaw      = tonumber(cfg[kgKey])      or 0,
            ageRaw     = tonumber(cfg[ageKey])     or 0,
            petTypeMap = cfg[petTypeKey]          or {},
        })
    end

    -- Urutan prioritas: Gift 1 â†’ Gift 2 â†’ Gift 3
    addGroup("1", "enabled",  targets1, "minKG",  "minAge",  "petType")
    addGroup("2", "enabledB", targets2, "minKGB", "minAgeB", "petTypeB")
    addGroup("3", "enabledC", targets3, "minKGC", "minAgeC", "petTypeC")

    if #groups == 0 then
        if AUTO_GIFT_DEBUG then
            dbg("NO ACTIVE GROUP (tidak ada Gift row yang enabled + punya target)")
        end
        return
    end

    local sent = 0

    for _, tool in ipairs(bp:GetChildren()) do
        if sent >= AUTO_GIFT_MAX_SEND_PER_PASS then
            break
        end

        if _isPetTool(tool) then
            local idAttr = tool:GetAttribute("PET_UUID")
                or tool:GetAttribute("UUID")
                or tool:GetAttribute("PetUUID")

            if not idAttr then
                _debugSkip(tool.Name, "no_uuid_attr")
            else
                local core, br = helpers.normUUID(idAttr)
                local rec = index[core] or index[br]
                local uuidFmt = br or ("{"..tostring(core or idAttr).."}")

                if not rec then
                    _debugSkip(uuidFmt, "rec_nil_in_datastore")
                else
                    if helpers.is_favorite(rec) then
                        _debugSkip(uuidFmt, "favorite")
                    else
                        local age  = helpers.age_from_record(rec)
                        local w100 = helpers.weight_at_100_for_rec(rec)

                        if (not age) or (not w100) then
                            _debugSkip(uuidFmt, "age_or_w100_nil", "age=", age, "w100=", w100)
                        else
                            if not _matchGiftMutation(rec, helpers) then
                                _debugSkip(uuidFmt, "mut_no_match")
                            else
                                -- petType dari record (pakai logic sama dengan PetListView)
                                local PD = rec.PetData or rec.Data or {}
                                local petTypeRaw =
                                    rec.Type or rec.PetType or
                                    PD.Type  or PD.PetType  or
                                    rec.Name or PD.Name     or
                                    "Pet"
                                local petTypeLabel = tostring(petTypeRaw)
                                local petTypeNorm  = petTypeLabel:lower()

                                local chosenGroup
                                for _, grp in ipairs(groups) do
                                    if _passesGiftGroup(w100, age, grp.kgRaw, grp.ageRaw)
                                        and _passesPetType(petTypeNorm, grp.petTypeMap)
                                    then
                                        chosenGroup = grp
                                        break
                                    end
                                end

                                if not chosenGroup then
                                    if AUTO_GIFT_DEBUG then
                                        _debugSkip(
                                            uuidFmt,
                                            "group_fail_all",
                                            "age=", age, "w100=", w100
                                        )
                                    end
                                else
                                    local target = _pickLeastBackpackTarget(chosenGroup.targets)
                                    if target then
                                        local okGive = _give(uuidFmt, target, tool)
                                        if okGive then
                                            sent += 1
                                            dbg(
                                                ("SEND OK [Gift%s]"):format(chosenGroup.id),
                                                uuidFmt, "â†’", target.Name,
                                                "age=", age,
                                                "w100=", w100,
                                                "type=", petTypeLabel
                                            )
                                        else
                                            _debugSkip(
                                                uuidFmt,
                                                "give_fail",
                                                "group", chosenGroup.id,
                                                "target", target.Name
                                            )
                                        end
                                    else
                                        _debugSkip(uuidFmt, "no_valid_target_in_group", chosenGroup.id)
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        -- kalau bukan Tool pet, otomatis dilewati
    end

    if AUTO_GIFT_DEBUG and sent == 0 then
        dbg("Pass selesai, TIDAK ADA pet yang dikirim.")
    end
end

----------------------------------------------------------------
-- AUTO UPDATE BACKPACK REF
----------------------------------------------------------------
LocalPlayer.CharacterAdded:Connect(function()
    task.delay(1, function()
        Backpack = _getBackpack()
    end)
end)

----------------------------------------------------------------
-- MODULE API & LOOP START
----------------------------------------------------------------
local M = {}
local _loopStarted = false

local function _startLoop()
    if _loopStarted then return end
    _loopStarted = true

    task.spawn(function()
        dbg("AutoGift loop START (gift.lua pakai PetListView)")
        while true do
            local ok, err = pcall(_autoGiftPass)
            if not ok then
                warn("[AutoGift] ERROR dalam _autoGiftPass:", err)
            end
            task.wait(AUTO_GIFT_SCAN_INTERVAL)
        end
    end)
end

-- Auto start loop saat module di-require
_startLoop()

-- Optional API: manual single pass
function M.RunOnePass()
    local ok, err = pcall(_autoGiftPass)
    if not ok then
        warn("[AutoGift] RunOnePass error:", err)
    end
end

-- Flag auto accept (listener-nya dibuat di module lain)
function M.IsAutoAcceptGiftEnabled()
    return GIFT_CFG and GIFT_CFG.autoAcceptGift == true
end

function M.IsAutoAcceptTradeEnabled()
    return GIFT_CFG and GIFT_CFG.autoAcceptTrade == true
end
-- autoaccept.lua
-- Auto Accept Gift + Trade untuk NodeHub
-- Baca toggle dari GIFT_CFG.autoAcceptGift & GIFT_CFG.autoAcceptTrade (state.lua + misc.lua)

--------------------------------------------------
-- Services & Globals
--------------------------------------------------
local Players           = game:GetService("Players")
local RunService        = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace         = game:GetService("Workspace")

local RS = ReplicatedStorage
local LP = Players.LocalPlayer

local G = (getgenv and getgenv()) or _G

--------------------------------------------------
-- Helper: Ambil GIFT_CFG Global
--------------------------------------------------
local function getGiftCfg()
    -- coba beberapa nama, tergantung kamu assign di mana
    local cfg = rawget(G, "GIFT_CFG")
        or G.GIFT_CFG
        or rawget(_G, "GIFT_CFG")
        or _G.GIFT_CFG
        or rawget(_G, "giftCfg")
        or _G.giftCfg
        or _G.GIFT_CONFIG
        or GIFT_CFG

    if typeof(cfg) ~= "table" then
        return nil
    end
    return cfg
end

local function isAutoGiftOn()
    local cfg = getGiftCfg()
    return cfg and cfg.autoAcceptGift == true
end

local function isAutoTradeOn()
    local cfg = getGiftCfg()
    return cfg and cfg.autoAcceptTrade == true
end

--------------------------------------------------
-- 1) AUTO ACCEPT GIFT
--------------------------------------------------
local CLEAR_WINDOW_SEC   = 3      -- berapa lama bersihin notif gift
local CLEAR_INTERVAL_SEC = 0.25   -- interval cek UI notif

local okGift, giftErr = pcall(function()
    local GameEvents = RS:WaitForChild("GameEvents")
    local GiftPet    = GameEvents:WaitForChild("GiftPet")
    local AcceptGift = GameEvents:WaitForChild("AcceptPetGift")

    GiftPet.OnClientEvent:Connect(function(uuid, petName, fromPlayer)
        -- cek toggle dari GIFT_CFG
        if not isAutoGiftOn() then
            return
        end

        -- Auto accept gift langsung ke server
        AcceptGift:FireServer(true, uuid)

        -- Bersihkan notifikasi "Gift_Notification" biar layar bersih
        task.spawn(function()
            local playerGui = LP:WaitForChild("PlayerGui")
            local deadline  = tick() + CLEAR_WINDOW_SEC

            while tick() < deadline do
                local root = playerGui:FindFirstChild("Gift_Notification")
                if root then
                    local frame = root:FindFirstChild("Frame")
                    if frame then
                        local inner = frame:FindFirstChild("Gift_Notification")
                        if inner then
                            inner:Destroy()
                        end
                    end
                end

                task.wait(CLEAR_INTERVAL_SEC)
            end
        end)
    end)
end)

if not okGift then
    warn("[AutoAccept] Gagal inisialisasi Auto Accept Gift:", giftErr)
end

--------------------------------------------------
-- 2) AUTO ACCEPT TRADE (FULL)
--------------------------------------------------
local DEBUG          = false
local TIMEOUT_READY  = 200
local TIMEOUT_ACTION = 200

local function dbg(...)
    if DEBUG then
        print("[TradeRecvDBG]", ...)
    end
end

local function warnx(...)
    warn("[TradeRecvDBG]", ...)
end

--------------------------------------------------
-- Safe require helper
--------------------------------------------------
local function safeRequire(obj)
    local ok, mod = pcall(function()
        return require(obj)
    end)
    if not ok then
        dbg("require fail:", tostring(obj))
    end
    return ok and mod or nil
end

--------------------------------------------------
-- Ambil TradeEvents & Modules
--------------------------------------------------
local TradeEvents
local SendRequestEv, RespondRequestEv, AcceptEv, ConfirmEv, DeclineEv, UpdateState
local ReplicationReciever
local TradeData

local TRADE_SYSTEM_OK = false

do
    local okTrade, err = pcall(function()
        local GE = RS:WaitForChild("GameEvents")
        TradeEvents      = GE:WaitForChild("TradeEvents")

        SendRequestEv    = TradeEvents:WaitForChild("SendRequest")
        RespondRequestEv = TradeEvents:WaitForChild("RespondRequest")
        AcceptEv         = TradeEvents:WaitForChild("Accept")
        ConfirmEv        = TradeEvents:WaitForChild("Confirm")
        DeclineEv        = TradeEvents:WaitForChild("Decline")
        UpdateState      = TradeEvents:WaitForChild("UpdateTradeState")

        local modules = RS:WaitForChild("Modules")
        ReplicationReciever = safeRequire(modules:WaitForChild("ReplicationReciever"))

        local dataFolder = RS:WaitForChild("Data")
        TradeData = safeRequire(dataFolder:WaitForChild("TradeData")) or { ButtonCooldown = 0 }

        if not ReplicationReciever then
            error("ReplicationReciever module tidak ditemukan")
        end
    end)

    if not okTrade then
        warnx("Inisialisasi TradeEvents gagal, auto-accept trade dimatikan:", err)
        TRADE_SYSTEM_OK = false
    else
        TRADE_SYSTEM_OK = true
    end
end

if not TRADE_SYSTEM_OK then
    -- Jangan return seluruh file, biarkan Auto Gift tetap jalan.
    dbg("Trade system tidak siap, bagian auto-accept trade skip.")
end

--------------------------------------------------
-- Trade replicator state & helper
--------------------------------------------------
local player        = LP
local currentTradeId = nil
local replicator     = nil

-- dapatkan states, index-ku, dan index lawan
local function getStateIndices()
    if not replicator then return nil end

    local ok, data = pcall(function()
        return replicator:GetData()
    end)
    if not ok or not data then
        return nil
    end

    local players = data.players or {}
    local states  = data.states  or {}
    local myIdx

    for i, p in ipairs(players) do
        if p == player then
            myIdx = i
            break
        end
    end
    if not myIdx then
        return nil
    end

    local otherIdx = (myIdx == 1) and 2 or 1
    return states, myIdx, otherIdx
end

-- true kalau lawan sudah Accepted
local function otherAccepted()
    local states, myIdx, otherIdx = getStateIndices()
    if not states or not myIdx or not otherIdx then
        return false
    end
    local myState    = states[myIdx]
    local otherState = states[otherIdx]

    if otherState == "Accepted" then
        return true, ("other=%s my=%s"):format(tostring(otherState), tostring(myState))
    end

    return false, ("other=%s my=%s"):format(tostring(otherState), tostring(myState))
end

-- true kalau lawan sudah Confirmed
local function otherConfirmed()
    local states, myIdx, otherIdx = getStateIndices()
    if not states or not myIdx or not otherIdx then
        return false
    end
    local myState    = states[myIdx]
    local otherState = states[otherIdx]

    if otherState == "Confirmed" then
        return true, ("other=%s my=%s"):format(tostring(otherState), tostring(myState))
    end

    return false, ("other=%s my=%s"):format(tostring(otherState), tostring(myState))
end

local function waitUntil(pred, timeout)
    local t0    = os.clock()
    local limit = timeout or 10
    while os.clock() - t0 < limit do
        local ok, why = pred()
        if ok then
            return true, why
        end
        RunService.Heartbeat:Wait()
    end
    return false, "timeout"
end

-- cooldown dari TradeData (pakai data replicator)
local function cooldownSatisfied()
    if not replicator then
        return false
    end

    local ok, data = pcall(function()
        return replicator:GetData()
    end)
    if not ok or not data then
        return false
    end

    local delta = Workspace:GetServerTimeNow() - (data.lastChange or 0)
    local cd    = tonumber(TradeData.ButtonCooldown) or 0
    return delta >= cd, string.format("delta=%.3f cd=%.3f", delta, cd)
end

-- baca offer milik kita dari replicator
local function getMyOffer()
    if not replicator then return nil end

    local ok, data = pcall(function()
        return replicator:GetData()
    end)
    if not ok or not data then
        return nil
    end

    local idx
    for i, p in ipairs(data.players or {}) do
        if p == player then
            idx = i
            break
        end
    end
    if not idx then
        return nil
    end

    local bucket = (data.offers and data.offers[idx]) or {}
    return {
        items    = bucket.items or {},
        sheckles = bucket.sheckles or 0,
        states   = data.states,
        players  = data.players,
    }
end

-- tunggu kedua pihak Accepted
local function bothAccepted()
    local o = getMyOffer()
    if not o then
        return false
    end

    local players, states = o.players or {}, o.states or {}
    local myIdx
    for i, p in ipairs(players) do
        if p == player then
            myIdx = i
            break
        end
    end
    if not myIdx or not states then
        return false
    end

    local otherIdx = (myIdx == 1) and 2 or 1
    if not states[myIdx] or not states[otherIdx] then
        return false
    end

    return (states[myIdx] == "Accepted" and states[otherIdx] == "Accepted"), "both-accepted"
end

-- nunggu trade bener2 mulai (replicator + data siap)
local function waitTradeStarted(timeout)
    return waitUntil(function()
        if not currentTradeId or not replicator then
            return false
        end
        local o = getMyOffer()
        if o then
            return true, "trade-started"
        end
        return false
    end, timeout or TIMEOUT_READY)
end

-- nunggu trade berakhir (UpdateState kirim nil)
local function waitTradeEnded(timeout)
    return waitUntil(function()
        if not currentTradeId or not replicator then
            return true, "trade-ended"
        end
        return false
    end, timeout or TIMEOUT_ACTION)
end

--------------------------------------------------
-- FUNGSI UTAMA: Auto Accept + Confirm sekali jalan
--------------------------------------------------
local function runAutoAcceptOnce()
    -- kalau user matikan toggle di tengah-tengah, jangan lanjut
    if not isAutoTradeOn() then
        dbg("runAutoAcceptOnce dipanggil tapi autoAcceptTrade = false, batal.")
        return false
    end

    dbg("runAutoAcceptOnce: menunggu trade aktif...")

    -- 1) tunggu trade + data siap
    local okStart, whyStart = waitTradeStarted(TIMEOUT_READY)
    if not okStart then
        warnx("trade tidak aktif / replicator tidak siap:", whyStart)
        return false
    end
    dbg("Trade terdeteksi, replicator siap")

    -- 2) (opsional) cek offer lawan / kita sendiri (anti-scam bisa ditaruh di sini)
    local offer = getMyOffer()
    if offer then
        dbg(string.format(
            "Offer sekarang: items=%d, sheckles=%s",
            #(offer.items or {}), tostring(offer.sheckles or 0)
        ))
        -- TODO: kalau mau, di sini tambahkan filter minimal sheckles / minimal item dll.
    else
        warnx("getMyOffer() gagal, lanjut saja...")
    end

    ------------------------------------------------------------
    -- 3) ACCEPT: tunggu lawan ACCEPT dulu baru kita Accept
    ------------------------------------------------------------
    dbg("Menunggu lawan Accepted dulu sebelum kita Accept...")
    local okOtherAcc, whyOtherAcc = waitUntil(otherAccepted, TIMEOUT_ACTION)
    if not okOtherAcc then
        warnx("Lawan tidak Accepted dalam waktu limit:", whyOtherAcc)
        -- fallback: tetap coba Accept biar trade nggak macet
    else
        dbg("Lawan sudah Accepted:", whyOtherAcc)
    end

    dbg("Menunggu cooldown sebelum Accept...")
    waitUntil(cooldownSatisfied, TIMEOUT_ACTION)

    dbg("AcceptEv:FireServer() (penerima)")
    pcall(function()
        AcceptEv:FireServer()
    end)

    -- pastikan kedua pihak sudah Accepted
    dbg("Menunggu kedua pemain Accepted...")
    local okBoth, whyBoth = waitUntil(bothAccepted, TIMEOUT_ACTION)
    if not okBoth then
        warnx("BothAccepted timeout / gagal:", whyBoth)
        return false
    end
    dbg("Kedua pemain Accepted, siap masuk fase Confirm")

    ------------------------------------------------------------
    -- 4) CONFIRM: tunggu lawan CONFIRM dulu baru kita Confirm
    ------------------------------------------------------------
    dbg("Menunggu lawan Confirm dulu sebelum kita Confirm...")
    local okOtherConf, whyOtherConf = waitUntil(otherConfirmed, TIMEOUT_ACTION)
    if not okOtherConf then
        warnx("Lawan belum Confirm (timeout):", whyOtherConf)
        -- kalau mau lebih aman, bisa return false di sini:
        -- return false
    else
        dbg("Lawan sudah Confirm:", whyOtherConf)
    end

    dbg("Menunggu cooldown sebelum Confirm...")
    waitUntil(cooldownSatisfied, TIMEOUT_ACTION)

    dbg("ConfirmEv:FireServer() (penerima)")
    pcall(function()
        ConfirmEv:FireServer()
    end)

    ------------------------------------------------------------
    -- 5) tunggu trade benar-benar selesai
    ------------------------------------------------------------
    dbg("Menunggu trade selesai (trade-ended)...")
    local okEnd, whyEnd = waitTradeEnded(TIMEOUT_ACTION)
    if not okEnd then
        warnx("Trade belum selesai (timeout):", whyEnd)
        return false
    end

    dbg("Trade selesai (confirmed & UpdateState nil)")
    return true
end

--------------------------------------------------
-- Event binding ONLY kalau Trade system siap
--------------------------------------------------
if TRADE_SYSTEM_OK then
    ------------------------------------------------------
    -- 2.1) AUTO RESPOND REQUEST (tanpa klik tombol UI)
    ------------------------------------------------------
    SendRequestEv.OnClientEvent:Connect(function(tradeId, fromPlayer, expireAt)
        local remaining = (expireAt or 0) - Workspace:GetServerTimeNow()
        dbg(("Incoming trade request dari %s | tradeId=%s | sisa=%.2fs")
            :format(fromPlayer and fromPlayer.Name or "?", tostring(tradeId), remaining))

        -- cek toggle auto-accept trade
        if not isAutoTradeOn() then
            dbg("autoAcceptTrade = false â†’ cuma log, tidak auto RespondRequest")
            return
        end

        if not tradeId then
            warnx("tradeId nil, tidak bisa RespondRequest")
            return
        end

        -- setara dengan pencet tombol ACCEPT di UI asli
        pcall(function()
            RespondRequestEv:FireServer(tradeId, true)
        end)
        dbg("RespondRequestEv:FireServer(tradeId, true) (auto-accept undangan)")
    end)

    ------------------------------------------------------
    -- 2.2) HOOK UpdateTradeState â†’ pasang replicator & autoAccept
    ------------------------------------------------------
    UpdateState.OnClientEvent:Connect(function(tradeId)
        dbg("UpdateTradeState:", tradeId)

        -- bersihkan replicator lama
        if replicator then
            pcall(function()
                replicator:Destroy()
            end)
            replicator = nil
        end

        currentTradeId = tradeId

        if tradeId then
            -- buat replicator baru
            local ok, rep = pcall(function()
                return ReplicationReciever.new(tradeId)
            end)
            if ok and rep then
                replicator = rep
                dbg("Replicator baru ready")

                if isAutoTradeOn() then
                    task.defer(function()
                        task.wait(0.3) -- sedikit delay biar data sempat sync
                        runAutoAcceptOnce()
                    end)
                else
                    dbg("UpdateState: autoAcceptTrade = false, tidak jalankan runAutoAcceptOnce()")
                end
            else
                warnx("ReplicationReciever.new() gagal:", rep)
            end
        else
            dbg("TradeState = nil (trade selesai / dibatalkan)")
        end
    end)

    dbg("Auto-accept trade siap. Toggle dikontrol GIFT_CFG.autoAcceptTrade")
end

--------------------------------------------------
-- Optional return (kalau dipakai sebagai ModuleScript)
--------------------------------------------------
local M = {}

function M.IsAutoGiftOn()
    return isAutoGiftOn()
end

function M.IsAutoTradeOn()
    return isAutoTradeOn()
end
-- autokg_loop.lua
-- Loop utama AutoKG / GBXP (Stage A/B/C/D + NOOS/XP/BOOST/AGE support)
-- Dibungkus module dengan Start/Stop, diexpose ke _G.AutoKGLoop
-- === SINGLETON GUARD (WAJIB) ===
if rawget(_G, "AutoKGLoop") and type(_G.AutoKGLoop) == "table" then
    local old = _G.AutoKGLoop
    if type(old.Start) == "function" and type(old.Stop) == "function" and type(old.IsRunning) == "function" then
        return old
    end
end

local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LocalPlayer = Players.LocalPlayer

-- ðŸ”¹ GLOBAL ENV
local G = (getgenv and getgenv()) or _G

------------------------------------------------------------
-- DEPENDENCY (diasumsikan sudah ada di environment-mu)
------------------------------------------------------------
-- Harus ada di luar:
--   ActivePetsService
--   PetUtilities
--   PetRegistry
--   GetPetCooldownRF (RemoteFunction)
--   safeEquip, safeUnequip, equipMany, unequipMany
--   setToArray
--   _getMutationNamesForUUID (untuk GBXP_MUT_SELECTED & Boost rule)
--   TAB_AGE_EQUIP_MIN, TAB_AGE_UNEQUIP_MIN, TAB_W_EQUIP_MIN, TAB_W_UNEQUIP_MAX
--   GBXP_STAGE_MODE, GBXP_MUT_SELECTED, GBXP_MAX_EQUIP

local ActivePetsService = ActivePetsService or require(ReplicatedStorage.Modules.PetServices.ActivePetsService)
local PetUtilities      = PetUtilities      or require(ReplicatedStorage.Modules.PetServices.PetUtilities)
local PetRegistry       = PetRegistry       or require(ReplicatedStorage.Data.PetRegistry)

local GameEvents        = ReplicatedStorage:WaitForChild("GameEvents")
local GetPetCooldownRF  = GetPetCooldownRF or GameEvents:WaitForChild("GetPetCooldown")
local mutationModule = require(ReplicatedStorage.Data.PetRegistry.PetMutationRegistry)
------------------------------------------------------------
-- MODULE TABLE
------------------------------------------------------------
local M = {}

-- flag utama loop
local running       = false
local __prevRunning = false

-- bisa kamu atur dari luar kalau mau
local GBXP_DEBUG    = GBXP_DEBUG or false
local DEBUG_LEVEL   = DEBUG_LEVEL or 2

------------------------------------------------------------
-- Pastikan table selected ada + helper setToArray
------------------------------------------------------------
selected = selected or {
    boost      = {},
    xp         = {},
    noos       = {},
    seratusage = {},
    gbxp       = {},
}

local function setToArray(setTbl)
    local arr = {}
    if type(setTbl) ~= "table" then
        return arr
    end
    for uuid, on in pairs(setTbl) do
        if on then
            arr[#arr+1] = uuid
        end
    end
    return arr
end



-------------------------------------------------------------
-- MUTATION MAP: EnumId (a, b, c, A, B, ...) â†’ Nama mutasi
-------------------------------------------------------------
local MUT_CODE_TO_NAME = {}

do
    -- Di game ini, daftar mutasi ada di mutationModule.PetMutationRegistry
    local reg = mutationModule and mutationModule.PetMutationRegistry
    if type(reg) == "table" then
        for mutName, def in pairs(reg) do
            if type(def) == "table" then
                local code = def.EnumId       -- 'a','b','c','A',...
                if type(code) == "string" and #code == 1 then
                    -- contoh: 'c' â†’ "Rainbow", 'A' â†’ "Nightmare"
                    MUT_CODE_TO_NAME[code] = mutName
                end
            end
        end
    else
        warn("[PetSwitcher] PetMutationRegistry invalid:", typeof(reg))
    end

    -- debug sekali, cuma buat cek di console
    -- for k,v in pairs(MUT_CODE_TO_NAME) do print("MUT", k, "=>", v) end
end


-- daftar nama mutasi untuk panel kanan GBXP
local RS = game:GetService("ReplicatedStorage")

-- SESUAI PATH GAME-MU
local PetMutModule = require(RS.Data.PetRegistry.PetMutationRegistry)

-- Deteksi bentuk modul-nya
local PetMutReg = PetMutModule.PetMutationRegistry
if not PetMutReg then
    -- fallback: kalau modul langsung berisi Shocked/Golden/... tanpa field PetMutationRegistry
    PetMutReg = PetMutModule
end

-- Bangun daftar nama mutasi
local MUTATION_LIST = {}

for mutName, info in pairs(PetMutReg) do
    -- kalau mau cuma yang bisa dari mutation machine:
    -- if info.AvaliableFromMutationMachine then
    --     table.insert(MUTATION_LIST, mutName)
    -- end

    -- atau tampilkan semua:
    table.insert(MUTATION_LIST, mutName)
end

table.sort(MUTATION_LIST)
--print("[GBXP_MUT] total mutasi:", #MUTATION_LIST)

-- contoh isi:
-- GBXP_MUT_SELECTED = { Nightmare = true, Rainbow = true, Spectral = true }

GBXP_MUT_SELECTED    = GBXP_MUT_SELECTED or {}
local GBXP_MUT_SELECTED_LC = GBXP_MUT_SELECTED_LC or {}

local function _refreshMutSelectedLC()
    table.clear(GBXP_MUT_SELECTED_LC)
    for name, _ in pairs(GBXP_MUT_SELECTED) do
        if name then
            local s = tostring(name)
            GBXP_MUT_SELECTED[s] = true
            GBXP_MUT_SELECTED_LC[s:lower()] = true
        end
    end
end

_refreshMutSelectedLC()

local function _isMutationSelected(uuid)
    local muts = _getMutationNamesForUUID(uuid) or {}
    if type(muts) ~= "table" then return false end

    local matched = false
    local dbg = {}

    for _, name in ipairs(muts) do
        local s  = tostring(name)
        local sL = s:lower()
        table.insert(dbg, s)
        if GBXP_MUT_SELECTED[s] or GBXP_MUT_SELECTED_LC[sL] then
            matched = true
        end
    end

    if not matched then
        --print("[GBXP_MUT] uuid=", uuid,
           -- "mutasi=", (#dbg>0 and table.concat(dbg, "+") or "-"),
      --      "TIDAK match GBXP_MUT_SELECTED")
    else
   --     print("[GBXP_MUT] uuid=", uuid,
   --         "mutasi=", table.concat(dbg, "+"),
    --        "MATCH GBXP_MUT_SELECTED")
    end

    return matched
end


----------------------------------------------------------------
-- UUID & Number helpers
----------------------------------------------------------------
local function __normUUID(u)
    if not u or u == "" then return nil, nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core, "{"..core.."}"
end

local function __toNumberKG(v)
    if v == nil then return nil end
    if type(v) == "number" then return v end
    local s = tostring(v):lower()
    s = s:gsub("[^%d%,%.]+", "")  -- keep digits, comma, dot
    s = s:gsub(",", ".")
    return tonumber(s)
end

----------------------------------------------------------------
-- SCALE (auto-normalize: 2 => 0.02)
----------------------------------------------------------------
local SCALE_PER_LVL = PetRegistry.PetConfig.WEIGHT_CONFIG.SCALE_PERCENTAGE_OF_BASE_WEIGHT_PER_LEVEL
local SCALE = SCALE_PER_LVL

----------------------------------------------------------------
-- Type / favorite / age extractors
----------------------------------------------------------------
local function __norm_text(s)
    s = tostring(s or ""):lower()
    s = s:gsub("[%c%p]+", " "):gsub("%s+"," ")
    s = s:match("^%s*(.-)%s*$") or s
    return s
end

local function __pet_type_from_record(rec)
    if type(rec) ~= "table" then return nil end
    local PD = rec.PetData or rec.Data or {}
    local petTypeRaw = rec.Type or rec.PetType or PD.Type or PD.PetType
    if petTypeRaw == nil then return nil end
    return string.lower(tostring(petTypeRaw))
end

-- FAVORITE = baca murni dari datastore (sesuai dump)
local function __is_favorite(rec)
    if type(rec) ~= "table" then return false end

    local PD = rec.PetData or rec.Data or {}

    -- 1) Prioritas: PetData.IsFavorite
    if typeof(PD.IsFavorite) == "boolean" then
        return PD.IsFavorite
    end

    -- 2) Fallback: rec.IsFavorite (beberapa pet bisa taruh di root)
    if typeof(rec.IsFavorite) == "boolean" then
        return rec.IsFavorite
    end

    -- 3) Kalau nggak ada field sama sekali â†’ anggap BUKAN fav
    return false
end


-- true kalau GBXP_TYPE_WHITELIST tidak punya entry sama sekali
local function __is_whitelist_empty()
    if type(GBXP_TYPE_WHITELIST) ~= "table" then
        return true
    end
    for _ in pairs(GBXP_TYPE_WHITELIST) do
        return false -- ada minimal 1 key
    end
    return true
end


local function __whitelist_match(petTypeNorm)
    if not petTypeNorm or petTypeNorm == "" then
        return false
    end

    -- kalau whitelist kosong, anggap SEMUA type lolos
    if __is_whitelist_empty() then
        return true
    end

    for key,_ in pairs(GBXP_TYPE_WHITELIST) do
        local pat = __norm_text(key)
        if #pat > 0 and petTypeNorm:find(pat, 1, true) then
            return true
        end
    end
    return false
end


local function __number_from_candidates(tbl, keys, srcOut)
    for _,k in ipairs(keys) do
        local v = tbl[k]
        if type(v) == "number" then if srcOut then srcOut[1]=k end; return v end
        if type(v) == "string" then
            local n = tonumber((v:gsub(",", ".")))
            if n then if srcOut then srcOut[1]=k end; return n end
        end
    end
    return nil
end

local function __age_from_record(rec, srcOut)
    local PD = rec.PetData or rec.Data or {}
    return __number_from_candidates(rec, {"Age","age","Level","level"}, srcOut)
        or __number_from_candidates(PD,  {"Age","age","Level","level"}, srcOut)
end

local function __base_from_record(rec, srcOut)
    local PD = rec.PetData or rec.Data or {}
    return __number_from_candidates(rec, {"BaseWeight","BaseWeightKG","WeightBase","baseWeight","base_weight"}, srcOut)
        or __number_from_candidates(PD,  {"BaseWeight","BaseWeightKG","WeightBase","baseWeight","base_weight"}, srcOut)
end

local function __current_from_record(rec, srcOut)
    local PD = rec.PetData or rec.Data or {}
    return __number_from_candidates(rec, {"Weight","weight","KG","kg","W","w","WeightNow","weight_now","currentWeight"}, srcOut)
        or __number_from_candidates(PD,  {"Weight","weight","KG","kg","W","w","WeightNow","weight_now","currentWeight"}, srcOut)
end

----------------------------------------------------------------
-- getBaseKg via datastore (core/braced key)
----------------------------------------------------------------
local function getBaseKg(uuid)
    if not uuid or uuid == "" then return nil end
    local core, braced = __normUUID(uuid)

    if not ActivePetsService or not ActivePetsService.GetPlayerDatastorePetData then
        d("ActivePetsService:GetPlayerDatastorePetData MISSING")
        return nil
    end

    local ok, store = pcall(function()
        return ActivePetsService:GetPlayerDatastorePetData(LocalPlayer.Name)
    end)
    if not ok then d("GetPlayerDatastorePetData ERROR"); return nil end
    if not store or not store.PetInventory or not store.PetInventory.Data then
        d("Store/PetInventory/Data EMPTY")
        return nil
    end

    local rec = store.PetInventory.Data[core] or store.PetInventory.Data[braced]
    if type(rec) ~= "table" then return nil end
    local PD = rec.PetData or rec.Data or {}
    local raw = rec.BaseWeight or rec.BaseWeightKG or rec.WeightBase
            or PD.BaseWeight  or PD.BaseWeightKG  or PD.WeightBase
    local n = __toNumberKG(raw)
    return n
end

----------------------------------------------------------------
-- weight@100 resolver (rec + uuid) + DEBUG sumber
----------------------------------------------------------------
local function __weight_at_100(rec, uuid, dbg)
    local bw_src, cur_src, age_src = {""},{""},{""}
    local bw_rec = __base_from_record(rec, bw_src)
    local age    = __age_from_record(rec, age_src)
    local cur    = __current_from_record(rec, cur_src)

    -- A) pakai base dari record
    if bw_rec then
        local w100 = bw_rec * (1 + SCALE * 100)
        if dbg then dbg.mode="rec.base"; dbg.bw=bw_rec; dbg.bw_src=bw_src[1]; dbg.cur=cur; dbg.cur_src=cur_src[1]; dbg.age=age; dbg.age_src=age_src[1]; dbg.w100=w100 end
        return w100
    end

    -- B) referensi base dari datastore (by UUID)
    local bw_ref = uuid and getBaseKg(uuid) or nil
    if bw_ref then
        local w100 = bw_ref * (1 + SCALE * 100)
        if dbg then dbg.mode="ref.base"; dbg.bw=bw_ref; dbg.bw_src="getBaseKg()"; dbg.cur=cur; dbg.cur_src=cur_src[1]; dbg.age=age; dbg.age_src=age_src[1]; dbg.w100=w100 end
        return w100
    end

    -- C) proyeksi dari current + age
    if cur and age then
        local delta = math.max(0, 100 - age)
        local w100 = cur * (1 + SCALE * delta)
        if dbg then dbg.mode="proj.cur+age"; dbg.bw=nil; dbg.bw_src="nil"; dbg.cur=cur; dbg.cur_src=cur_src[1]; dbg.age=age; dbg.age_src=age_src[1]; dbg.w100=w100 end
        return w100
    end

    if dbg then dbg.mode="none"; dbg.bw=nil; dbg.bw_src="nil"; dbg.cur=cur; dbg.cur_src=cur_src[1]; dbg.age=age; dbg.age_src=age_src[1]; dbg.w100=nil end
    return nil
end

----------------------------------------------------------------
-- Bag fetch
----------------------------------------------------------------
local function __getStoreBag()
    if not ActivePetsService or not ActivePetsService.GetPlayerDatastorePetData then
        d("ActivePetsService:GetPlayerDatastorePetData not available"); return nil
    end
    local ok, store = pcall(function()
        return ActivePetsService:GetPlayerDatastorePetData(LocalPlayer.Name)
    end)
    if not ok then d("GetPlayerDatastorePetData error"); return nil end
    if not store or not store.PetInventory or not store.PetInventory.Data then
        d("Store/PetInventory/Data empty"); return nil
    end
    return store.PetInventory.Data
end


local function __mutation_names_from_record(rec)
    if type(rec) ~= "table" then return {} end

    -- di screenshot: PetData.MutationType = "B"
    local PD = rec.PetData or rec.Data or {}

    local raw =
        PD.MutationType or             -- ini yang kepakai di game-mu
        rec.MutationType  or
        PD.Mutations      or PD.Mutation or PD.MutationCodes or
        rec.Mutations     or rec.Mutation or rec.MutationCodes

    if not raw then
        return {}
    end

    local codes = {}

    if type(raw) == "string" then
        -- contoh: "B" / "BSR"
        for c in raw:gmatch("%a") do
            table.insert(codes, c)
        end

    elseif type(raw) == "table" then
        for _, v in pairs(raw) do
            if type(v) == "string" then
                for c in v:gmatch("%a") do
                    table.insert(codes, c)
                end
            elseif type(v) == "table" and type(v.MutationType) == "string" then
                for c in v.MutationType:gmatch("%a") do
                    table.insert(codes, c)
                end
            end
        end
    end

    local names, seen = {}, {}
    for _, code in ipairs(codes) do
        local name = MUT_CODE_TO_NAME[code]
        if name and not seen[name] then
            seen[name] = true
            table.insert(names, name)
        end
    end

    return names
end



-- Ambil record pet dari UUID (aman pakai pcall, coba beberapa metode umum)
-- asumsi sudah ada:
local MUT_NAME_CACHE = MUT_NAME_CACHE or {}

local function _getPetRecord(uuid)
    if not uuid then return nil end
    uuid = tostring(uuid)

    --------------------------------------------------------
    -- 1) PAKAI DATASTORE BAG dulu (sama seperti listPetsForTab)
    --------------------------------------------------------
    local bag = __getStoreBag and __getStoreBag()
    if bag then
        for rawUUID, rec in pairs(bag) do
            if type(rec) == "table" then
                local core, br
                if __normUUID then
                    core, br = __normUUID(rawUUID)
                else
                    core = tostring(rawUUID)
                end
                local norm = tostring(br or core or rawUUID)
                if norm == uuid then
                    -- ini rec yang sama dengan yang dipakai listPetsForTab
                    return rec
                end
            end
        end
    end

    --------------------------------------------------------
    -- 2) Fallback ke PetUtilities (kalau ada & bentuknya table)
    --------------------------------------------------------
    if PetUtilities and PetUtilities.GetPetByUUID then
        local ok, rec = pcall(function()
            return PetUtilities:GetPetByUUID(LocalPlayer, uuid)
        end)
        if ok and rec and type(rec) == "table" then
            return rec
        end
    end

    --------------------------------------------------------
    -- 3) Fallback terakhir: PetsService
    --------------------------------------------------------
    if PetsService then
        local ok, rec = pcall(function()
            if PetsService.GetPetByUUID then
                return PetsService:GetPetByUUID(LocalPlayer, uuid)
            elseif PetsService.GetPet then
                return PetsService:GetPet(uuid)
            end
        end)
        if ok and rec then
            return rec
        end
    end

    return nil
end



-- HAPUS atau abaikan: local MUT_NAME_CACHE = MUT_NAME_CACHE or {}

local function _getMutationNamesForUUID(uuid)
    if not uuid then return {} end
    uuid = tostring(uuid)

    local rec = _getPetRecord and _getPetRecord(uuid) or nil
    if not rec then
        --print("[MUT] uuid", uuid, "rec=nil (tidak ketemu di bag/PetUtilities)")
        return {}
    end

    local names = __mutation_names_from_record(rec) or {}

    local rawMT
    if type(rec) == "table" then
        local PD = rec.PetData or rec.Data or {}
        rawMT = PD.MutationType or rec.MutationType
    end

    --print("[MUT] uuid", uuid,
   --       "raw MutationType=", tostring(rawMT),
  --        "names=", (#names>0 and table.concat(names, "+") or "-"))

    return names
end

------------------------------------------------------------
-- Fallback safeEquip / safeUnequip / equipMany / unequipMany
-- (dipakai kalau versi global belum ada)
------------------------------------------------------------
local PetsService = PetsService or require(ReplicatedStorage.Modules.PetServices.PetsService)

if not safeEquip then
    function safeEquip(uuid)
        if not uuid or uuid == "" then return end
        pcall(function()
            PetsService:EquipPet(uuid)
        end)
    end
end

if not safeUnequip then
    function safeUnequip(uuid)
        if not uuid or uuid == "" then return end
        pcall(function()
            PetsService:UnequipPet(uuid)
        end)
    end
end

if not equipMany then
    function equipMany(uuids)
        if type(uuids) ~= "table" then return end
        for _, u in ipairs(uuids) do
            safeEquip(u)
        end
    end
end

if not unequipMany then
    function unequipMany(uuids)
        if type(uuids) ~= "table" then return end
        for _, u in ipairs(uuids) do
            safeUnequip(u)
        end
    end
end

-- kumpulkan semua uuid yang dipakai AutoKG (boost / noos / seratusage / xp / gbxp)
local function unequipAllAutoKG()
    local all = {}

    local function addFrom(setTbl)
        if type(setTbl) ~= "table" then return end
        for uuid, on in pairs(setTbl) do
            if on then
                all[uuid] = true
            end
        end
    end

    addFrom(selected.boost)
    addFrom(selected.noos)
    addFrom(selected.seratusage)
    addFrom(selected.xp)
    addFrom(selected.gbxp)

    for uuid, _ in pairs(all) do
        safeUnequip(uuid)
    end
end

------------------------------------------------------------
-- ðŸ” Ambil level pet (AGE) dengan debug lengkap
------------------------------------------------------------
local function _norm(u)
    -- buang/ambil kurung kurawal bila ada
    if not u or u == "" then return nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core, "{"..core.."}"
end

local function _pickLevel(t)
    if type(t) ~= "table" then return nil end
    return tonumber(t.Level)
        or tonumber(t.PetData and t.PetData.Level)
        or tonumber(t.Data    and t.Data.Level)
end

if not getPetAge then
    function getPetAge(uuid)
        if not uuid or uuid == "" then return nil end
        local uNorm, uBraced = _norm(uuid)

        -- 1) Coba via PetUtilities (uNorm â†’ uBraced)
        for _,u in ipairs({uNorm, uBraced}) do
            local ok, data = pcall(function()
                return PetUtilities:GetPetByUUID(LocalPlayer, u)
            end)
            if ok and type(data) == "table" then
                local lvl = _pickLevel(data)
                if lvl then return lvl end
            end
        end

        -- 2) Fallback: baca full datastore lewat ActivePetsService
        local ok, store = pcall(function()
            return ActivePetsService:GetPlayerDatastorePetData(LocalPlayer.Name)
        end)
        if not ok or not store then
            warn("[getPetAge] Datastore belum siap.")
            return nil
        end

        local bag = store.PetInventory and store.PetInventory.Data
        if not bag then return nil end

        -- coba kedua kunci: tanpa kurung & dengan kurung
        local pet = bag[uNorm] or bag[uBraced]
        if not pet then
            -- tidak usah warn spam; cukup nil menandakan belum ada
            return nil
        end

        local lvl = _pickLevel(pet)
        if not lvl then
            warn(("âš ï¸ getPetAge: Level tidak ditemukan untuk UUID %s"):format(uNorm))
        end
        return lvl
    end
end

------------------------------------------------------------
-- Skill tokens / XP stuck config (opsional)
------------------------------------------------------------
local ELE_SKILL_TOKENS = ELE_SKILL_TOKENS or { "rainbow jumbo blessing", "jumbo blessing", "jumbo" }

local XP_SKILL_TOKENS = XP_SKILL_TOKENS or {
    "friendly frier",
    "mining",
    "rainbow frilled reptile",
}

local XP_STUCK      = XP_STUCK or {}     -- [uuid] = { last = number|nil, sameCount = 0, lastLabel = "" }
local XP_STUCK_TOL  = XP_STUCK_TOL or 0.1
local XP_STUCK_N    = XP_STUCK_N or 15   -- jumlah loop berturut-turut

------------------------------------------------------------
-- Util normalisasi label skill & waktu
------------------------------------------------------------
local function _normSkillLabel(s)
    s = string.lower(tostring(s or ""))
    s = s:gsub("%b[]",""):gsub("[^%w%s]"," "):gsub("%s+"," ")
    return (s:gsub("^%s+",""):gsub("%s+$",""))
end

local function _parseCooldownSeconds(v)
    if type(v) == "number" then return v end
    if type(v) ~= "string" then return 0 end
    local s = v:lower():gsub(",", "."):gsub("%s+", " "):gsub("^%s*(.-)%s*$", "%1")
    local m, sec = s:match("^(%d+)%s*:%s*(%d+)$")
    if m and sec then return tonumber(m)*60 + tonumber(sec) end
    local mm = s:match("(%d+)%s*m")
    local ss = s:match("(%d+)%s*s")
    if mm or ss then return (tonumber(mm) or 0)*60 + (tonumber(ss) or 0) end
    return tonumber(s:match("[-+]?%d+%.?%d*")) or 0
end

local function _fmtMMSS(sec)
    sec = math.max(0, math.floor(tonumber(sec) or 0))
    local m = math.floor(sec/60)
    local s = sec % 60
    return string.format("%d:%02d", m, s)
end

local formatMMSS = _fmtMMSS

------------------------------------------------------------
-- RF cooldown caching
------------------------------------------------------------
local _CD_CACHE   = {}      -- [uuid] = { ts=tick(), cds=table }
local _CD_MAX_AGE = 0.5     -- detik cache per loop

local function _getCooldowns(uuid)
    if not uuid or uuid == "" then return nil end
    local now = tick()
    local c = _CD_CACHE[uuid]
    if c and (now - c.ts) <= _CD_MAX_AGE then
        return c.cds
    end
    local ok, cds = pcall(function() return GetPetCooldownRF:InvokeServer(uuid) end)
    if ok and type(cds) == "table" then
        _CD_CACHE[uuid] = { ts = now, cds = cds }
        return cds
    end
    return nil
end

local function _getCooldownForTokens(uuid, TOKENS)
    if not uuid or uuid == "" then return nil, nil end
    local cds = _getCooldowns(uuid)
    if type(cds) ~= "table" then return nil, nil end
    for _, cd in ipairs(cds) do
        local label = _normSkillLabel(cd.Skill or cd.Passive)
        if label ~= "" then
            for _, tok in ipairs(TOKENS) do
                if string.find(label, tok, 1, true) then
                    return _parseCooldownSeconds(cd.Time), label
                end
            end
        end
    end
    return nil, nil
end

------------------------------------------------------------
-- WEIGHT@LEVEL100 (tanpa base)
------------------------------------------------------------
local SCALE = PetRegistry.PetConfig.WEIGHT_CONFIG.SCALE_PERCENTAGE_OF_BASE_WEIGHT_PER_LEVEL
local WEIGHT100_THRESHOLD = WEIGHT100_THRESHOLD or 60.5
local EPS_W100 = EPS_W100 or 1e-6

local function __normUUID(u)
    if not u then return nil, nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core, "{"..core.."}"
end

local function __toNumberKG(v)
    if v == nil then return nil end
    if type(v) == "number" then return v end
    if type(v) == "string" then
        local s = v:lower():gsub("%s+",""):gsub("kg",""):gsub(",", ".")
        local num = tonumber(s:match("[-+]?%d+%.?%d*"))
        return num
    end
    return nil
end

if not getBaseKg then
    function getBaseKg(uuid)
        if not uuid or uuid == "" then return nil end
        local core, braced = __normUUID(uuid)

        -- 1) datastore client
        local ok, store = pcall(function()
            return ActivePetsService:GetPlayerDatastorePetData(LocalPlayer.Name)
        end)
        if ok and store and store.PetInventory and store.PetInventory.Data then
            local rec = store.PetInventory.Data[core] or store.PetInventory.Data[braced]
            if type(rec) == "table" then
                local v = rec.BaseWeight or rec.BaseWeightKG
                        or (rec.PetData and (rec.PetData.BaseWeight or rec.PetData.BaseWeightKG))
                        or (rec.Data    and (rec.Data.BaseWeight    or rec.Data.BaseWeightKG))
                v = __toNumberKG(v)
                if v then return v end
            end
        end

        return nil
    end
end

if not getWeightAtLevel100 then
    function getWeightAtLevel100(uuid)
        local base = getBaseKg and getBaseKg(uuid) or nil
        if not base then return nil end
        return base * (1 + SCALE * 100)
    end
end

------------------------------------------------------------
-- GBXP MAIN LOOP CONFIG
------------------------------------------------------------
local EPS                     = EPS or 1e-6
local ACTION_DELAY_SEC        = ACTION_DELAY_SEC or 0.12
local TRACE_EVERY_N           = TRACE_EVERY_N or 20
DEBUG_LEVEL                   = DEBUG_LEVEL or 2

local AGE_MIN_EQUIP           = AGE_MIN_EQUIP or 40
local DEFAULT_W100_MAX        = DEFAULT_W100_MAX or 60.45
local W100_MAX_EQUIP          = math.abs((TAB_W_EQUIP_MIN and TAB_W_EQUIP_MIN.noos) or DEFAULT_W100_MAX)
local AGE_MAX_UNEQUIP_B       = AGE_MAX_UNEQUIP_B or 100
local REEQUIP_RETRY_SEC       = REEQUIP_RETRY_SEC or 4
local B_AFTER_ACTION_WAIT_SEC = B_AFTER_ACTION_WAIT_SEC or 600

local __loopCounter = 0

local function _ts()
    local s = os and os.date and os.date("%H:%M:%S") or tostring(tick()):sub(1,6)
    return "["..s.."]"
end

local function d(lvl, ...)
    if not GBXP_DEBUG then return end
    if (lvl or 2) > DEBUG_LEVEL then return end
    local parts = { _ts(), "[GBXP]" }
    for i = 1, select("#", ...) do
        parts[#parts+1] = tostring(select(i, ...))
    end
    print(table.concat(parts, " "))
end

local function dx(...)
    d(3, ...)
end

------------------------------------------------------------
-- State untuk GBXP
------------------------------------------------------------
local LAST_TARGET_UUID = LAST_TARGET_UUID or nil
local LAST_MODE        = LAST_MODE or nil
local _LAST_TRY_EQUIP  = _LAST_TRY_EQUIP or {}

local GBXP_LOCAL = GBXP_LOCAL or {
    equippedUUID    = nil,
    equipModeByUUID = {},
}

local STAGE_ORDER   = { "A", "B", "C", "D" }
local CURRENT_STAGE = CURRENT_STAGE or "A"

------------------------------------------------------------
-- World snapshot
------------------------------------------------------------
local function _getEquippedSetFromWorld()
    local set = {}

    -- 1) runtime active pets
    local ok1, active = pcall(function()
        return ActivePetsService and ActivePetsService:GetActivePetsForPlayer(LocalPlayer)
    end)
    if ok1 and type(active) == "table" then
        for _, u in ipairs(active) do
            set[tostring(u)] = true
        end
    end

    -- 2) datastore snapshot (optional)
    local ok2, pdata = pcall(function()
        return ActivePetsService and ActivePetsService:GetPlayerDatastorePetData(LocalPlayer.Name)
    end)
    if ok2 and type(pdata) == "table" then
        local PD = pdata.PetsData or pdata.Data or pdata
        local eq = PD and (PD.EquippedPets or PD.equipped or PD.Equipped) or nil
        if type(eq) == "table" then
            for _, u in ipairs(eq) do
                set[tostring(u)] = true
            end
        end
    end

    return set
end

local function _isEquippedNow(uuid, worldSet)
    if not uuid then return false end
    return worldSet[tostring(uuid)] == true
end

local function _isInStore(uuid)
    if hasPetInStore then
        local ok, res = pcall(hasPetInStore, uuid)
        if ok then return res end
    end
    return true
end

------------------------------------------------------------
-- Safe wrappers untuk equip/unequip
------------------------------------------------------------
local function _safeEquip(u, why, where)
    if not u then return end
    d(2, "equip", u, where and ("@"..where) or "", why and ("| "..why) or "")
    local ok, err = pcall(function() safeEquip(u) end)
    if not ok then d(1, "equip-fail", u, tostring(err)) end
    task.wait(ACTION_DELAY_SEC)
end

local function _safeUnequip(u, why, where)
    if not u then return end
    d(2, "unequip", u, where and ("@"..where) or "", why and ("| "..why) or "")
    local ok, err = pcall(function() safeUnequip(u) end)
    if not ok then d(1, "unequip-fail", u, tostring(err)) end
    task.wait(ACTION_DELAY_SEC)
end

local function _equipMany(arr, why, where)
    if type(arr) ~= "table" or #arr == 0 then return end
    d(2, "equipMany #"..tostring(#arr), where and ("@"..where) or "", why or "")
    local ok, err = pcall(function() equipMany(arr) end)
    if not ok then d(1, "equipMany-fail", tostring(err)) end
    task.wait(ACTION_DELAY_SEC)
end

local function _unequipMany(arr, why, where)
    if type(arr) ~= "table" or #arr == 0 then return end
    d(2, "unequipMany #"..tostring(#arr), where and ("@"..where) or "", why or "")
    local ok, err = pcall(function() unequipMany(arr) end)
    if not ok then d(1, "unequipMany-fail", tostring(err)) end
    task.wait(ACTION_DELAY_SEC)
end

------------------------------------------------------------
-- GBXP stage & rule helpers
------------------------------------------------------------
local function _isMutationSelected(uuid)
    if not _getMutationNamesForUUID then return false end
    local muts = _getMutationNamesForUUID(uuid) or {}
    if type(muts) ~= "table" then return false end

    for _, name in ipairs(muts) do
        name = tostring(name)
        local k1 = name
        local k2 = name:lower()
        if GBXP_MUT_SELECTED[k1] or GBXP_MUT_SELECTED[k2] then
            return true
        end
    end
    return false
end

local function _getCutoffAge()
    local v = TAB_AGE_UNEQUIP_MIN and TAB_AGE_UNEQUIP_MIN.gbxp
    if type(v) == "number" and v > 0 then
        return v
    end
    return AGE_MAX_UNEQUIP_B
end

local function _getStageForGBXP(uuid)
    local age  = getPetAge(uuid)
    local w100 = getWeightAtLevel100(uuid)
    if not age or not w100 then return nil end

    age = math.floor(age + EPS)

    local mutMatch  = _isMutationSelected(uuid)
    local cutoffAge = _getCutoffAge()

    local mode   = tostring(GBXP_STAGE_MODE or "auto"):upper()
    local isAuto = (mode == "AUTO")

    -- FINISH / SELESAI
    local finishMutOK = (not isAuto) or mutMatch

    if age >= (cutoffAge - EPS)
       and w100 >= (W100_MAX_EQUIP - EPS)
       and finishMutOK then
        return nil
    end

    -- STAGE A (cari mutasi)
    if not mutMatch then
        local modeHasA = (mode == "A" or mode:find("A", 1, true) ~= nil)
        if isAuto or modeHasA then
            if mode == "CAD" then
                if w100 >= (W100_MAX_EQUIP - EPS) then
                    return "A"
                end
            else
                return "A"
            end
        end
    end

    -- Stage B / D untuk umur < 40
    if age < (40 - EPS) then
        if (not isAuto)
           and (mode == "CD" or mode == "DC" or mode == "CAD")
           and w100 >= (W100_MAX_EQUIP - EPS) then
            return "D"
        end
        return "B"
    end

    -- Stage C: umur >= 40, KG100 belum tembus limit
    if age >= (40 - EPS) and w100 < (W100_MAX_EQUIP - EPS) then
        return "C"
    end

    -- Stage D: KG100 sudah cukup, umur belum sampai cutoff
    if w100 >= (W100_MAX_EQUIP - EPS) and age < (cutoffAge - EPS) then
        return "D"
    end

    return nil
end

local function _shouldUnequipGBXP(uuid)
    local age  = getPetAge(uuid)
    local w100 = getWeightAtLevel100(uuid)
    if not age or not w100 then return false end

    age = math.floor(age + EPS)

    local mutMatch   = _isMutationSelected(uuid)
    local cutoffAge  = _getCutoffAge()
    local mode   = tostring(GBXP_STAGE_MODE or "auto"):upper()
    local isAuto = (mode == "AUTO")

    local finishMutOK = (not isAuto) or mutMatch

    return age >= (cutoffAge - EPS)
       and w100 >= (W100_MAX_EQUIP - EPS)
       and finishMutOK
end

------------------------------------------------------------
-- Start/Stop edges
------------------------------------------------------------
local __RESUME_REAPPLY = __RESUME_REAPPLY or false

local function __onStart()
    __RESUME_REAPPLY            = true
    LAST_TARGET_UUID            = nil
    LAST_MODE                   = nil
    _LAST_TRY_EQUIP             = {}
    GBXP_LOCAL.equippedUUID     = nil
    GBXP_LOCAL.equipModeByUUID  = {}
end

local function __onStop()
    GBXP_LOCAL.equippedUUID = nil
end

------------------------------------------------------------
-- Aturan umur per tab
------------------------------------------------------------
local function applyTabAgeRule(tabKey, arr, minAge)
    if not minAge or type(arr) ~= "table" or #arr == 0 then return end

    local equipAge   = TAB_AGE_EQUIP_MIN[tabKey]   or 0
    local unequipAge = TAB_AGE_UNEQUIP_MIN[tabKey] or 0

    if minAge < (equipAge - EPS) then
        _unequipMany(
            arr,
            string.format("minAge<%.0f â†’ %s OFF (age<equip)", equipAge, tabKey),
            "age-"..tabKey.."-low"
        )
        return
    end

    if unequipAge > 0 and unequipAge > equipAge and minAge >= (unequipAge - EPS) then
        _unequipMany(
            arr,
            string.format("minAge>=%.0f â†’ %s OFF (age>unequip)", unequipAge, tabKey),
            "age-"..tabKey.."-high"
        )
        return
    end

    _equipMany(
        arr,
        string.format("minAge in [%.0f,%.0f) â†’ %s ON", equipAge, unequipAge, tabKey),
        "age-"..tabKey.."-on"
    )
end

------------------------------------------------------------
-- Boost vs GBXP mutation
------------------------------------------------------------
local function applyBoostRule(tabKey, arr, targetList)
    tabKey      = tabKey or "boost"
    arr         = arr or {}
    targetList  = targetList or {}

    if type(arr) ~= "table" or #arr == 0 then return end

    local equipAge = tonumber(TAB_AGE_EQUIP_MIN[tabKey] or 0) or 0

    local hasMatch      = false
    local hasNonMatch   = false
    local anyCandidate  = false
    local dbg           = {}

    for _, rec in ipairs(targetList) do
        local age  = rec.age or 0
        local uuid = rec.uuid

        if (age + EPS) >= equipAge then
            anyCandidate = true

            local muts = _getMutationNamesForUUID and _getMutationNamesForUUID(uuid) or {}
            local mutLabelParts = {}
            local matched = false

            for _, mutName in ipairs(muts) do
                table.insert(mutLabelParts, mutName)

                local k1 = mutName
                local k2 = mutName:lower()
                if GBXP_MUT_SELECTED[k1] or GBXP_MUT_SELECTED[k2] then
                    matched = true
                end
            end

            if matched then
                hasMatch = true
            else
                hasNonMatch = true
            end

            table.insert(dbg, string.format(
                "%s[Age=%.1f][%s]%s",
                tostring(uuid),
                age,
                (#mutLabelParts > 0) and table.concat(mutLabelParts, "+") or "-",
                matched and " MATCH" or " NON_MATCH"
            ))
        end
    end

    if not anyCandidate then
        _unequipMany(
            arr,
            "BOOST OFF (belum ada GBXP age>= " .. equipAge .. " | " .. table.concat(dbg, "; ") .. ")",
            "boost-no-candidate"
        )
        return
    end

    if hasNonMatch then
        _equipMany(
            arr,
            string.format(
                "BOOST ON (ada GBXP age>=%.0f dengan mutasi kosong / tidak ada di GBXP_MUT_SELECTED | %s)",
                equipAge,
                table.concat(dbg, "; ")
            ),
            "boost-gbxp-nonmatch"
        )
        return
    end

    _unequipMany(
        arr,
        "BOOST OFF (SEMUA GBXP age>= "
            .. equipAge
            .. " punya mutasi di GBXP_MUT_SELECTED | "
            .. table.concat(dbg, "; ")
            .. ")",
        "boost-gbxp-match"
    )
end

------------------------------------------------------------
-- Helper passOneValue untuk age/kg rule
------------------------------------------------------------
local function _passOneValue(v, rawMin, rawMax)
    if v == nil then
        return true
    end

    local min = tonumber(rawMin or 0) or 0
    local max = tonumber(rawMax or 0) or 0
    local ok  = true

    -- MIN
    if min ~= 0 then
        local limit = math.abs(min)
        if min > 0 then
            if v < (limit - EPS) then
                ok = false
            end
        else
            if v > (limit + EPS) then
                ok = false
            end
        end
    end

    -- MAX
    if ok and max ~= 0 then
        local limit = math.abs(max)
        if max > 0 then
            if v >= (limit - EPS) then
                ok = false
            end
        else
            if v <= (limit + EPS) then
                ok = false
            end
        end
    end

    return ok
end

local function _computeRoleFlagsForUUID(uuid, ctx)
    local age  = ctx.targetAge
    local w100 = ctx.targetW100

    local inBoost = ctx.boostSet[uuid] == true
    local inXP    = ctx.xpSet[uuid]    == true
    local inNoos  = ctx.noosSet[uuid]  == true
    local inAge   = ctx.ageSet[uuid]   == true

    local can = {
        boost      = false,
        xp         = false,
        noos       = false,
        seratusage = false,
    }

    local function passAgeKg(tabKey)
        local aMin = TAB_AGE_EQUIP_MIN[tabKey]
        local aMax = TAB_AGE_UNEQUIP_MIN[tabKey]
        local wMin = TAB_W_EQUIP_MIN[tabKey]
        local wMax = TAB_W_UNEQUIP_MAX[tabKey]

        local okAge = true
        local okW   = true

        if age then
            okAge = _passOneValue(age,  aMin, aMax)
        end
        if w100 then
            okW   = _passOneValue(w100, wMin, wMax)
        end

        return okAge and okW
    end

    -- BOOST
    if inBoost and passAgeKg("boost") then
        can.boost = true
    end

    -- XP
    if inXP and passAgeKg("xp") then
        can.xp = true
    end

    -- SERATUSAGE
    if inAge and passAgeKg("seratusage") then
        can.seratusage = true
    end

    -- NOOS
    if inNoos and ctx.wantNoosOn and passAgeKg("noos") then
        can.noos = true
    end

    return can
end

local function _markSupportSet(arr, set, ctx)
    if type(arr) ~= "table" then return end
    for _, u in ipairs(arr) do
        if u ~= nil then
            set[u] = true
            if ctx.ageByUUID[u] == nil then
                ctx.ageByUUID[u] = getPetAge(u)
            end
            if ctx.w100ByUUID[u] == nil then
                ctx.w100ByUUID[u] = getWeightAtLevel100(u)
            end
        end
    end
end

local function _computeSupportOwners(boostArr, xpArr, noosArr, ageArr, targetList, minAge, wantNoosOn)
    boostArr   = (type(boostArr)   == "table") and boostArr   or {}
    xpArr      = (type(xpArr)      == "table") and xpArr      or {}
    noosArr    = (type(noosArr)    == "table") and noosArr    or {}
    ageArr     = (type(ageArr)     == "table") and ageArr     or {}
    targetList = (type(targetList) == "table") and targetList or {}

    local primary        = targetList[1]
    local targetAge      = primary and primary.age  or nil
    local targetW100     = primary and primary.w100 or nil

    local ctx = {
        ageByUUID     = {},
        w100ByUUID    = {},
        boostSet      = {},
        xpSet         = {},
        noosSet       = {},
        ageSet        = {},
        wantNoosOn    = wantNoosOn,

        targetAge     = targetAge,
        targetW100    = targetW100,
    }

    for _, rec in ipairs(targetList) do
        if rec and rec.uuid then
            ctx.ageByUUID[rec.uuid]  = rec.age
            ctx.w100ByUUID[rec.uuid] = rec.w100
        end
    end

    _markSupportSet(boostArr, ctx.boostSet, ctx)
    _markSupportSet(xpArr,    ctx.xpSet,    ctx)
    _markSupportSet(noosArr,  ctx.noosSet,  ctx)
    _markSupportSet(ageArr,   ctx.ageSet,   ctx)

    local allUUID, seen = {}, {}
    local function collect(arr)
        if type(arr) ~= "table" then return end
        for _, u in ipairs(arr) do
            if u ~= nil and not seen[u] then
                seen[u] = true
                table.insert(allUUID, u)
            end
        end
    end

    collect(boostArr)
    collect(xpArr)
    collect(noosArr)
    collect(ageArr)

    local ownerByUUID = {}
    local boostOwned, xpOwned, noosOwned, ageOwned = {}, {}, {}, {}

    for _, u in ipairs(allUUID) do
        local can = _computeRoleFlagsForUUID(u, ctx)
        ownerByUUID[u] = can

        if can.boost      then table.insert(boostOwned,  u) end
        if can.xp         then table.insert(xpOwned,     u) end
        if can.noos       then table.insert(noosOwned,   u) end
        if can.seratusage then table.insert(ageOwned,    u) end
    end

    return ownerByUUID, boostOwned, xpOwned, noosOwned, ageOwned
end

local function _stageAllowedForMode(stage, mode)
    mode  = tostring(mode or "auto"):upper()
    stage = tostring(stage or "")

    if mode == "AUTO" then
        return true
    end

    if mode == "A" or mode == "B" or mode == "C" or mode == "D" then
        return stage == mode

    elseif mode == "BC" or mode == "CB" then
        return stage == "B" or stage == "C"

    elseif mode == "CD" or mode == "DC" then
        return stage == "C" or stage == "D"

    elseif mode == "CAD" then
        return stage == "C" or stage == "A" or stage == "D"
    end

    return true
end

local function enforceTab(tabArr, ownedArr, globalOwnedSet, tabKey, whyOn, whyOff)
    if type(tabArr) ~= "table" or #tabArr == 0 then return end

    local ownedSet = {}
    for _, u in ipairs(ownedArr or {}) do
        ownedSet[u] = true
    end

    local ws = _getEquippedSetFromWorld()
    for _, u in ipairs(tabArr) do
        local isOn             = _isEquippedNow(u, ws)
        local shouldOnThisTab  = ownedSet[u] == true
        local shouldOnGlobally = globalOwnedSet and (globalOwnedSet[u] == true) or false

        if shouldOnThisTab and (not isOn) then
            _safeEquip(u, whyOn, tabKey)
        elseif (not shouldOnGlobally) and (not shouldOnThisTab) and isOn then
            _safeUnequip(u, whyOff, tabKey)
        end
    end
end

local function _makeTargetKey(list)
    if type(list) ~= "table" or #list == 0 then return nil end
    local tmp = {}
    for i, rec in ipairs(list) do
        tmp[i] = tostring(rec.uuid)
    end
    table.sort(tmp)
    return table.concat(tmp, ",")
end

-- token loop (anti spawn dobel)
local LOOP_TOKEN_ATTR = "__AUTOKG_LOOP_TOKEN"
local token = tostring(os.clock()) .. "_" .. tostring(math.random(1, 1e9))
------------------------------------------------------------
-- LOOP UTAMA
------------------------------------------------------------
local function mainLoop(token)
    while true do
        if G[LOOP_TOKEN_ATTR] ~= token then
            return
        end
        ------------------------------------------------------------
        -- Start/Stop hook
        ------------------------------------------------------------
        if running and (not __prevRunning) then
            __onStart()
        elseif (not running) and __prevRunning then
            __onStop()
        end
        __prevRunning = running

        if running then
            __loopCounter += 1

            GBXP_LOCAL.equipModeByUUID = GBXP_LOCAL.equipModeByUUID or {}

            selected = selected or {}
            selected.boost       = selected.boost       or {}
            selected.xp          = selected.xp          or {}
            selected.noos        = selected.noos        or {}
            selected.gbxp        = selected.gbxp        or {}
            selected.seratusage  = selected.seratusage  or {}

            local boostArr   = setToArray(selected.boost)
            local xpArr      = setToArray(selected.xp)
            local noosArr    = setToArray(selected.noos)
            local gbxpArr    = setToArray(selected.gbxp)
            local ageArr     = setToArray(selected.seratusage)

            if __loopCounter % TRACE_EVERY_N == 1 then
                d(1, "tick", __loopCounter,
                    "| gbxp#",  #gbxpArr,
                    "| boost#", #boostArr,
                    "xp#",      #xpArr,
                    "noos#",    #noosArr,
                    "age#",     #ageArr)
            end

            --------------------------------------------------------
            -- 0) RULE SWEEP: unequip yang sudah selesai (age>=max)
            --------------------------------------------------------
            do
                local sweepCount = 0
                for _, uuid in ipairs(gbxpArr) do
                    if _shouldUnequipGBXP(uuid) then
                        _safeUnequip(
                            uuid,
                            "rule-sweep (age>= "..tostring(AGE_MAX_UNEQUIP_B)..")",
                            "rule0"
                        )
                        sweepCount += 1
                        if sweepCount >= 2 then
                            break
                        end
                    end
                end
            end

            --------------------------------------------------------
            -- 1) BUILD GROUPS STAGE A/B/C/D
            --------------------------------------------------------
            local groups = { A = {}, B = {}, C = {}, D = {} }

            for _, uuid in ipairs(gbxpArr) do
                local stage = _getStageForGBXP(uuid)
                if stage then
                    local age  = getPetAge(uuid)
                    local w100 = getWeightAtLevel100(uuid)
                    if age and w100 then
                        table.insert(groups[stage], {
                            uuid  = uuid,
                            age   = age,
                            w100  = w100,
                            stage = stage,
                        })
                    end
                end
            end

            --------------------------------------------------------
            -- 1b) PILIH STAGE AKTIF
            --------------------------------------------------------
            local activeStage = nil

            if GBXP_STAGE_MODE ~= "auto" then
                local forced = tostring(GBXP_STAGE_MODE or "auto"):upper()
                local stageList = {}

                if forced == "A" or forced == "B" or forced == "C" or forced == "D" then
                    stageList = { forced }

                elseif forced == "BC" or forced == "CB" then
                    stageList = { "B", "C" }

                elseif forced == "CD" or forced == "DC" then
                    stageList = { "C", "D" }

                elseif forced == "CAD" then
                    stageList = { "C", "A", "D" }

                else
                    warn("[GBXP] GBXP_STAGE_MODE invalid: ", forced, " â†’ fallback ke auto")
                    GBXP_STAGE_MODE = "auto"
                    stageList = {}
                end

                for _, s in ipairs(stageList) do
                    if groups[s] and #groups[s] > 0 then
                        activeStage = s
                        break
                    end
                end

                CURRENT_STAGE = activeStage

            else
                if CURRENT_STAGE == "D" then
                    local noABC = (#groups.A == 0)
                                and (#groups.B == 0)
                                and (#groups.C == 0)
                    if noABC and #groups.D > 0 then
                        activeStage = "D"
                    else
                        CURRENT_STAGE = nil
                    end

                elseif CURRENT_STAGE
                    and groups[CURRENT_STAGE]
                    and #groups[CURRENT_STAGE] > 0 then
                    activeStage = CURRENT_STAGE
                end

                if not activeStage then
                    for _, s in ipairs({ "A","B","C" }) do
                        if #groups[s] > 0 then
                            activeStage = s
                            break
                        end
                    end

                    if not activeStage and #groups.D > 0 then
                        activeStage = "D"
                    end
                end

                CURRENT_STAGE = activeStage
            end

            --------------------------------------------------------
            -- 2) BUILD targetList dari activeStage
            --------------------------------------------------------
            local targetList = {}
            if activeStage then
                for _, rec in ipairs(groups[activeStage]) do
                    table.insert(targetList, rec)
                    if #targetList >= (GBXP_MAX_EQUIP or 1) then
                        break
                    end
                end
            end

            --------------------------------------------------------
            -- SOLO STAGE-MISMATCH GUARD (multi GBXP)
            --------------------------------------------------------
            if (GBXP_MAX_EQUIP or 1) > 1 then
                local mode = tostring(GBXP_STAGE_MODE or "auto"):upper()

                local worldSet  = _getEquippedSetFromWorld()
                local equipped  = {}

                for _, u in ipairs(gbxpArr) do
                    if _isEquippedNow(u, worldSet) then
                        table.insert(equipped, u)
                    end
                end

                if #equipped == 1 then
                    local u     = equipped[1]
                    local stage = _getStageForGBXP(u)

                    local mismatch = false

                    if mode == "AUTO" then
                        mismatch = (stage == nil)
                    else
                        mismatch = stage and (not _stageAllowedForMode(stage, mode))
                    end

                    if mismatch then
                        d(1,
                          "SOLO GBXP stage mismatch:",
                          "uuid=", u,
                          "stage=", tostring(stage),
                          "mode=",  mode,
                          "â†’ unequip (auto/manual)"
                        )
                        _safeUnequip(
                            u,
                            "solo GBXP stage "..tostring(stage).." tidak cocok mode "..tostring(mode),
                            "solo-stage-mismatch"
                        )
                    end
                end
            end

            --------------------------------------------------------
            -- Info ringkas target: minAge & hasB
            --------------------------------------------------------
            local hasB, minAge = false, nil
            for _, rec in ipairs(targetList) do
                if (not minAge) or (rec.age < minAge) then
                    minAge = rec.age
                end
                if rec.w100 >= W100_MAX_EQUIP - EPS then
                    hasB = true
                end
            end

            local targetKey = _makeTargetKey(targetList)

            d(1,
              "picked STAGE=", tostring(activeStage or "-"),
              targetKey or "nil",
              "count=", #targetList,
              "minAge=", tostring(minAge or "-"),
              "CURRENT_STAGE=", tostring(CURRENT_STAGE),
              "MODE=", tostring(GBXP_STAGE_MODE)
            )

            --------------------------------------------------------
            -- 3) LOGIKA EQUIP GBXP + TAB SUPPORT
            --------------------------------------------------------
            if #targetList > 0 then
                local weightMode     = hasB and "B" or "A"
                local targetChanged  = (targetKey ~= LAST_TARGET_UUID)
                local modeChanged    = (weightMode ~= LAST_MODE)

                local targetSet = {}
                for _, rec in ipairs(targetList) do
                    targetSet[rec.uuid] = true
                end

                if targetChanged or modeChanged or __RESUME_REAPPLY then
                    d(1, "change/resume:",
                       "targetChanged=", targetChanged,
                       "modeChanged=",   modeChanged,
                       "resume=",        __RESUME_REAPPLY)

                    -- BOOST hanya di Stage A
                    if activeStage == "A" then
                        applyBoostRule("boost", boostArr, targetList)
                    else
                        _unequipMany(
                            boostArr,
                            "activeStage="..tostring(activeStage).." (bukan A) â†’ BOOST OFF",
                            "boost-notA"
                        )
                    end

                    -- EQUIP targetList
                    local worldSet = _getEquippedSetFromWorld()
                    for _, rec in ipairs(targetList) do
                        local u = rec.uuid
                        if _isInStore(u) and (not _isEquippedNow(u, worldSet)) then
                            _safeEquip(
                                u,
                                "GBXP STAGE="..tostring(rec.stage)
                                    .." age="..tostring(rec.age)
                                    .." w100="..tostring(rec.w100),
                                "main-equip"
                            )
                            GBXP_LOCAL.equipModeByUUID[u] = weightMode
                        end
                    end

                    -- Pastikan hanya targetList yang equip di GBXP tab
                    worldSet = _getEquippedSetFromWorld()
                    for _, u in ipairs(gbxpArr) do
                        if (not targetSet[u]) and _isEquippedNow(u, worldSet) then
                            _safeUnequip(
                                u,
                                "ensure max "..tostring(GBXP_MAX_EQUIP or 1).." GBXP",
                                "gbxp-guard"
                            )
                        end
                    end

                    -- FLAG NOOS
                    local wantNoosOn = false
                    for _, rec in ipairs(targetList) do
                        if (rec.age > AGE_MIN_EQUIP - EPS)
                           and (rec.w100 < W100_MAX_EQUIP - EPS) then
                            wantNoosOn = true
                            break
                        end
                    end

                    if weightMode == "A" then
                        d(1, "weightMode <"..tostring(W100_MAX_EQUIP).."kg")
                    else
                        d(1, "weightMode >="..tostring(W100_MAX_EQUIP).."kg")
                        if (B_AFTER_ACTION_WAIT_SEC or 0) > 0 then
                            d(1, "post-actions wait (B, async) ", tostring(B_AFTER_ACTION_WAIT_SEC).."s")
                            local myEpoch = M.__stopEpoch or 0
task.spawn(function()
    task.wait(B_AFTER_ACTION_WAIT_SEC)
    -- kalau sudah stop/start lagi atau stop dipanggil â†’ jangan ubah apa-apa
    if (M.__stopEpoch or 0) ~= myEpoch or running == false then
        return
    end
    LAST_MODE = nil
end)

                        end
                    end

                    -- Hitung owner untuk XP/NOOS/AGE (tanpa BOOST)
                    local ownerByUUID, _boostOwned_unused, xpOwned, noosOwned, ageOwned =
                        _computeSupportOwners(
                            {},
                            xpArr,
                            noosArr,
                            ageArr,
                            targetList, minAge, wantNoosOn
                        )

                    local globalOwnedSet = {}
                    local function markGlobal(arr)
                        for _, u in ipairs(arr or {}) do
                            if u ~= nil then
                                globalOwnedSet[u] = true
                            end
                        end
                    end

                    markGlobal(xpOwned)
                    markGlobal(noosOwned)
                    markGlobal(ageOwned)

                    enforceTab(
                        xpArr, xpOwned, globalOwnedSet, "xp",
                        "XP owner ON",
                        "XP owner OFF"
                    )

                    enforceTab(
                        noosArr, noosOwned, globalOwnedSet, "noos",
                        "NOOS owner ON",
                        "NOOS owner OFF"
                    )

                    enforceTab(
                        ageArr, ageOwned, globalOwnedSet, "seratusage",
                        "AGE owner ON",
                        "AGE owner OFF"
                    )

                    LAST_TARGET_UUID = targetKey
                    LAST_MODE        = weightMode
                    __RESUME_REAPPLY = false

                else
                    -- STEADY-STATE
                    local worldSet = _getEquippedSetFromWorld()

                    for _, u in ipairs(gbxpArr) do
                        if (not targetSet[u]) and _isEquippedNow(u, worldSet) then
                            _safeUnequip(
                                u,
                                "ensure multi GBXP equipped (steady)",
                                "steady-guard"
                            )
                        end
                    end

                    local now = tick()
                    for _, rec in ipairs(targetList) do
                        local u    = rec.uuid
                        local last = _LAST_TRY_EQUIP[u] or 0
                        if (not _isEquippedNow(u, worldSet))
                           and ((now - last) >= REEQUIP_RETRY_SEC)
                           and _isInStore(u) then
                            d(1, "ensure: target not equipped â†’ re-equip", u)
                            _safeEquip(u, "ensure re-equip (multi)", "ensure")
                            _LAST_TRY_EQUIP[u] = now
                            GBXP_LOCAL.equipModeByUUID[u] = weightMode
                        end
                    end

                    if activeStage == "A" then
                        applyBoostRule("boost", boostArr, targetList)
                    else
                        _unequipMany(
                            boostArr,
                            "activeStage="..tostring(activeStage).." (steady, bukan A) â†’ BOOST OFF",
                            "boost-notA-steady"
                        )
                    end

                    local wantNoosOn = false
                    for _, rec in ipairs(targetList) do
                        if (rec.age > AGE_MIN_EQUIP - EPS)
                           and (rec.w100 < W100_MAX_EQUIP - EPS) then
                            wantNoosOn = true
                            break
                        end
                    end

                    local ownerByUUID, _boostOwned_unused2, xpOwned, noosOwned, ageOwned =
                        _computeSupportOwners(
                            {},
                            xpArr,
                            noosArr,
                            ageArr,
                            targetList, minAge, wantNoosOn
                        )

                    local globalOwnedSet = {}
                    local function markGlobal2(arr)
                        for _, u in ipairs(arr or {}) do
                            if u ~= nil then
                                globalOwnedSet[u] = true
                            end
                        end
                    end

                    markGlobal2(xpOwned)
                    markGlobal2(noosOwned)
                    markGlobal2(ageOwned)

                    enforceTab(
                        xpArr, xpOwned, globalOwnedSet, "xp",
                        "XP owner ON (steady)",
                        "XP owner OFF (steady)"
                    )

                    enforceTab(
                        noosArr, noosOwned, globalOwnedSet, "noos",
                        "NOOS owner ON (steady)",
                        "NOOS owner OFF (steady)"
                    )

                    enforceTab(
                        ageArr, ageOwned, globalOwnedSet, "seratusage",
                        "AGE owner ON (steady)",
                        "AGE owner OFF (steady)"
                    )

                    dx("no change â†’ skip big actions (same target set / weightMode)")
                end

            else
                -- Tidak ada target GBXP
                d(1, "no suitable GBXP target this tick (stage A/B/C/D empty / solo-mode / stage-mismatch)")

                if (GBXP_MAX_EQUIP or 1) > 1 then
                    local mode = tostring(GBXP_STAGE_MODE or "auto"):upper()
                    if mode ~= "AUTO" then
                        local worldSet  = _getEquippedSetFromWorld()
                        local equipped  = {}

                        for _, u in ipairs(gbxpArr) do
                            if _isEquippedNow(u, worldSet) then
                                table.insert(equipped, u)
                            end
                        end

                        if #equipped == 1 then
                            local u     = equipped[1]
                            local stage = _getStageForGBXP(u)

                            if stage and (not _stageAllowedForMode(stage, mode)) then
                                d(1,
                                  "SOLO GBXP stage mismatch: uuid=", u,
                                  "stage=", stage, "mode=", mode,
                                  "â†’ unequip")
                                _safeUnequip(
                                    u,
                                    "solo GBXP stage "..tostring(stage).." tidak cocok mode "..tostring(mode),
                                    "solo-stage-mismatch"
                                )
                            end
                        end
                    end
                end

                LAST_TARGET_UUID        = nil
                LAST_MODE               = nil
                GBXP_LOCAL.equippedUUID = nil

                if __RESUME_REAPPLY then
                    _equipMany(boostArr,  "resume-baseline", "resume")
                    _equipMany(xpArr,     "resume-baseline", "resume")
                    _equipMany(ageArr,    "resume-baseline", "resume")
                    _unequipMany(noosArr, "resume-baseline", "resume")
                    __RESUME_REAPPLY = false
                end
            end

            --------------------------------------------------------
            -- 4) XP-STUCK monitor (optional)
            --------------------------------------------------------
            if XP_STUCK and _getCooldownForTokens and XP_SKILL_TOKENS then
                local needReapplyXP = false

                for _, u in ipairs(xpArr) do
                    local cd, label = _getCooldownForTokens(u, XP_SKILL_TOKENS)
                    local rec = XP_STUCK[u] or { last = nil, sameCount = 0, lastLabel = "" }

                    if cd == nil then
                        rec.last, rec.sameCount, rec.lastLabel = nil, 0, ""
                    else
                        if rec.last ~= nil then
                            local diff = cd - rec.last
                            local tol = XP_STUCK_TOL or 0.1
                            if diff >= -tol then
                                rec.sameCount = (rec.sameCount or 0) + 1
                            else
                                rec.sameCount = 0
                            end
                        else
                            rec.sameCount = 0
                        end

                        rec.last      = cd
                        rec.lastLabel = label or rec.lastLabel

                        if rec.sameCount >= (XP_STUCK_N or 15) then
                            d(1, "XP stuck â†’ unequip", u, "label=", rec.lastLabel, "cd=", cd)
                            _safeUnequip(u, "xp stuck", "xp-stuck")
                            rec.sameCount = 0
                            needReapplyXP = true
                        end
                    end

                    XP_STUCK[u] = rec
                end

                if needReapplyXP then
                    _equipMany(xpArr, "XP re-apply sesudah stuck", "xp-reapply")
                end
            end
        end

        task.wait(0.10)
    end
end

------------------------------------------------------------
-- PUBLIC API
------------------------------------------------------------
function M.Start(modeId)
    running = true

    if modeId then
        if type(setGBXPStageMode) == "function" then
            setGBXPStageMode(modeId)
        else
            GBXP_STAGE_MODE = modeId
        end
    end

    d(1, "AutoKGLoop.Start mode=", tostring(modeId or GBXP_STAGE_MODE))
end

function M.Stop(reason)
    if not running then
        return
    end

    running = false
    d(1, "AutoKGLoop.Stop()", tostring(reason or ""))

    -- reset state biar bersih total
    __RESUME_REAPPLY = false
    LAST_TARGET_UUID = nil
    LAST_MODE        = nil
    CURRENT_STAGE    = nil
    GBXP_LOCAL.equippedUUID = nil
    GBXP_LOCAL.equipModeByUUID = {}

    -- matikan loop async â€œpost-actions waitâ€ (pakai stop epoch)
    M.__stopEpoch = (M.__stopEpoch or 0) + 1

    unequipAllAutoKG()
end


function M.IsRunning()
    return running
end

function M.SetDebug(on, level)
    GBXP_DEBUG  = (on == true)
    DEBUG_LEVEL = level or DEBUG_LEVEL
end

-- simpan ke global dulu
_G.AutoKGLoop = M


M.__token = token
G[LOOP_TOKEN_ATTR] = token

task.spawn(function()
    mainLoop(token)
end)




-- autobuy.lua
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players          = game:GetService("Players")

local DataService      = require(ReplicatedStorage.Modules.DataService)
local SeedShopData     = require(ReplicatedStorage.Data.SeedShopData)
local PetEggData       = require(ReplicatedStorage.Data.PetEggData)
local GearShopDataRaw  = require(ReplicatedStorage.Data.GearShopData)

local BuySeedStock     = ReplicatedStorage.GameEvents.BuySeedStock
local BuyPetEgg        = ReplicatedStorage.GameEvents.BuyPetEgg
local BuyGearStock     = ReplicatedStorage.GameEvents.BuyGearStock

local GearShopData     = GearShopDataRaw.Gear or GearShopDataRaw

local M = {}

-- =========================================================
-- DEBUG (AMAN, TIDAK SPAM TABLE)
-- =========================================================
local DEBUG = false
local function dprint(...)
    if DEBUG then print("[AutoBuy]", ...) end
end
local function dwarn(...)
    if DEBUG then warn("[AutoBuy]", ...) end
end

local function sampleKey(t)
    if type(t) ~= "table" then return nil end
    for k, v in pairs(t) do
        return k, v
    end
    return nil
end

do
    dprint("Module load, DEBUG=", DEBUG)
    local sk = sampleKey(SeedShopData)
    local ek = sampleKey(PetEggData)
    local gk = sampleKey(GearShopData)
    dprint("SeedShopData sample key:", sk)
    dprint("PetEggData sample key:", ek)
    dprint("GearShopData sample key:", gk)
end

-- =========================================================
-- GLOBAL-FACING (yang dipakai UI + state.lua)
-- =========================================================
AUTO_BUY_SEED_ENABLED = (AUTO_BUY_SEED_ENABLED == true)
AUTO_BUY_EGG_ENABLED  = (AUTO_BUY_EGG_ENABLED  == true)
AUTO_BUY_GEAR_ENABLED = (AUTO_BUY_GEAR_ENABLED == true)

SEED_SELECTED = SEED_SELECTED or {} -- map [name]=true
EGG_SELECTED  = EGG_SELECTED  or {}
GEAR_SELECTED = GEAR_SELECTED or {}

-- =========================================================
-- INFO TABLE (dipakai tick)
-- =========================================================
local SEED_INFO = {}   -- [name] = { price, currency, rebirth }
local EGG_INFO  = {}   -- [name] = { price, currency, rebirth, index }
local GEAR_INFO = {}   -- [name] = { price, currency, rebirth }

local SeedItems, EggItems, GearItems = nil, nil, nil
local EGG_INDEX_BY_NAME = nil

local function sortByLayoutOrder(dataTbl, names)
    table.sort(names, function(a, b)
        local ra = dataTbl[a]
        local rb = dataTbl[b]
        local ia = (type(ra) == "table" and (ra.LayoutOrder or 0)) or 0
        local ib = (type(rb) == "table" and (rb.LayoutOrder or 0)) or 0
        if ia == ib then return tostring(a) < tostring(b) end
        return ia < ib
    end)
end

-- =========================================================
-- BUILD LISTS (âœ… RETURN STRING LIST!)
-- =========================================================
local function buildSeedList()
    table.clear(SEED_INFO)
    local names = {}

    for name, info in pairs(SeedShopData) do
        if type(info) == "table" and info.DisplayInShop ~= false then
            local currencyType = info.SpecialCurrencyType or "Sheckles"
            local price        = info.Price or info.FallbackPrice or 0
            local rebirthReq   = info.RebirthRequirement or 0

            SEED_INFO[name] = {
                price    = price,
                currency = currencyType,
                rebirth  = rebirthReq,
            }
            names[#names+1] = name
        end
    end

    sortByLayoutOrder(SeedShopData, names)
    dprint("buildSeedList:", #names, "sample:", names[1])
    return names
end

local function buildEggList()
    table.clear(EGG_INFO)
    EGG_INDEX_BY_NAME = {}

    local tmp = {}
    for name, info in pairs(PetEggData) do
        if type(info) == "table" then
            tmp[#tmp+1] = { name = name, order = info.LayoutOrder or 0 }
        end
    end

    table.sort(tmp, function(a, b)
        if a.order == b.order then return a.name < b.name end
        return a.order < b.order
    end)

    local names = {}
    for idx, rec in ipairs(tmp) do
        local info = PetEggData[rec.name]
        local price      = info.Price or info.FallbackPrice or 0
        local currency   = info.SpecialCurrencyType or "Sheckles"
        local rebirthReq = info.RebirthRequirement or 0

        names[idx] = rec.name
        EGG_INDEX_BY_NAME[rec.name] = idx

        EGG_INFO[rec.name] = {
            price    = price,
            currency = currency,
            rebirth  = rebirthReq,
            index    = idx,
        }
    end

    dprint("buildEggList:", #names, "sample:", names[1])
    return names
end

local function buildGearList()
    table.clear(GEAR_INFO)
    local names = {}

    for name, info in pairs(GearShopData) do
        if type(info) == "table" and info.DisplayInShop ~= false then
            local currencyType = info.SpecialCurrencyType or "Sheckles"
            local price        = info.Price or info.FallbackPrice or 0
            local rebirthReq   = info.RebirthRequirement or 0

            GEAR_INFO[name] = {
                price    = price,
                currency = currencyType,
                rebirth  = rebirthReq,
            }
            names[#names+1] = name
        end
    end

    sortByLayoutOrder(GearShopData, names)
    dprint("buildGearList:", #names, "sample:", names[1])
    return names
end

local function ensureListsBuilt()
    if not SeedItems then
        local ok, res = pcall(buildSeedList)
        SeedItems = (ok and type(res) == "table") and res or {}
        if not ok then dwarn("buildSeedList error:", res) end
    end
    if not EggItems then
        local ok, res = pcall(buildEggList)
        EggItems = (ok and type(res) == "table") and res or {}
        if not ok then dwarn("buildEggList error:", res) end
    end
    if not GearItems then
        local ok, res = pcall(buildGearList)
        GearItems = (ok and type(res) == "table") and res or {}
        if not ok then dwarn("buildGearList error:", res) end
    end

    dprint("ensureListsBuilt -> seed", #SeedItems, "egg", #EggItems, "gear", #GearItems)
end

function M.GetLists()
    ensureListsBuilt()
    return SeedItems, EggItems, GearItems
end

-- =========================================================
-- SHOP_INFO / STATE SYNC
-- =========================================================
STATE = STATE or {}
dprint("STATE at load:", STATE)

local SHOP_INFO = {
    seed = {
        infoTable = SEED_INFO,
        stockPath = "SeedStocks",
        buyFn     = function(name, qty)
            dprint("BUY seed", name, "qty", qty)
            for i = 1, qty do
                if not STATE.autoBuySeeds then break end
                BuySeedStock:FireServer("Shop", name)
                task.wait(0.15)
            end
        end,
    },
    egg = {
        infoTable = EGG_INFO,
        stockPath = "PetEggStock",
        buyFn     = function(name, qty)
            if not EGG_INDEX_BY_NAME then buildEggList() end
            local idx = EGG_INDEX_BY_NAME and EGG_INDEX_BY_NAME[name]
            if not idx then
                dwarn("Egg index not found for:", name)
                return
            end

            dprint("BUY egg", name, "idx", idx, "qty", qty)
            for i = 1, qty do
                if not STATE.autoBuyEgg then break end
                BuyPetEgg:FireServer(idx)
                task.wait(0.15)
            end
        end,
    },
    gear = {
        infoTable = GEAR_INFO,
        stockPath = "GearStock",
        buyFn     = function(name, qty)
            dprint("BUY gear", name, "qty", qty)
            for i = 1, qty do
                if not STATE.autoBuyGear then break end
                BuyGearStock:FireServer(name)
                task.wait(0.15)
            end
        end,
    },
}

function M.GetShopInfo()
    ensureListsBuilt()
    return SHOP_INFO
end

function M.SyncFromGlobals()
    ensureListsBuilt()

    STATE.autoBuySeeds = (AUTO_BUY_SEED_ENABLED == true)
    STATE.autoBuyEgg   = (AUTO_BUY_EGG_ENABLED  == true)
    STATE.autoBuyGear  = (AUTO_BUY_GEAR_ENABLED == true)

    SHOP_INFO.seed.selected = SEED_SELECTED or {}
    SHOP_INFO.egg.selected  = EGG_SELECTED  or {}
    SHOP_INFO.gear.selected = GEAR_SELECTED or {}

    dprint("SyncFromGlobals:", STATE.autoBuySeeds, STATE.autoBuyEgg, STATE.autoBuyGear)
end

-- =========================================================
-- Tick logic (tetap seperti punyamu)
-- =========================================================
local function getStockAmount(entry)
    if entry == nil then return 0 end
    if type(entry) == "number" then return entry end
    if type(entry) == "table" then return entry.Stock or 0 end
    return 0
end

local function getSheckles(profile)
    if not profile then return 0 end
    if type(profile.Sheckles) == "number" then return profile.Sheckles end
    if type(profile.CurrencyData) == "table" and type(profile.CurrencyData.Sheckles) == "number" then
        return profile.CurrencyData.Sheckles
    end
    if type(profile.Stats) == "table" and type(profile.Stats.Sheckles) == "number" then
        return profile.Stats.Sheckles
    end
    return 0
end

local function getGardenCoins(profile)
    if not profile then return 0 end
    if type(profile.GardenCoins) == "number" then return profile.GardenCoins end
    if type(profile.CurrencyData) == "table" and type(profile.CurrencyData.GardenCoins) == "number" then
        return profile.CurrencyData.GardenCoins
    end
    if type(profile.Stats) == "table" and type(profile.Stats.GardenCoins) == "number" then
        return profile.Stats.GardenCoins
    end
    return 0
end

function M.Tick()
    M.SyncFromGlobals()

    local profile = DataService:GetData()
    
    if not profile then
        dwarn("Tick: DataService:GetData() returned nil")
        return
    end

    local sheckles    = getSheckles(profile)
    local gardenCoins = getGardenCoins(profile)
    dprint("Tick balances:", "Sheckles", sheckles, "GardenCoins", gardenCoins)

    for catKey, cfg in pairs(SHOP_INFO) do
        local categoryOn = false
        if catKey == "seed" then categoryOn = STATE.autoBuySeeds
        elseif catKey == "egg" then categoryOn = STATE.autoBuyEgg
        elseif catKey == "gear" then categoryOn = STATE.autoBuyGear end
        if not categoryOn then
            continue
        end

        ensureListsBuilt()

        if catKey == "egg" then
            local stockRoot = profile[cfg.stockPath]
            local stocks = stockRoot and stockRoot.Stocks
            if typeof(stocks) ~= "table" then
                dwarn("Egg stocks not table:", typeof(stocks))
                continue
            end

            local selected = cfg.selected or {}
            local hasSelected = false
            for _, on in pairs(selected) do if on then hasSelected = true break end end

            for idx, eggRec in ipairs(stocks) do
                if type(eggRec) == "table" then
                    local name = eggRec.EggName
                    local stockCount = tonumber(eggRec.Stock) or 0
                    local priceType = eggRec.PriceType

                    local allowed = true
                    if stockCount <= 0 then allowed = false end
                    if allowed and priceType == "Robux" then allowed = false end
                    if allowed and hasSelected and not selected[name] then allowed = false end

                    if allowed then
                        dprint("Egg allowed:", idx, name, "stock", stockCount, "priceType", tostring(priceType))
                        for i = 1, stockCount do
                            if not STATE.autoBuyEgg then break end
                            BuyPetEgg:FireServer(idx)
                            task.wait(0.15)
                        end
                    end
                end
            end
        else
            local infoTable = cfg.infoTable
            local stockRoot = profile[cfg.stockPath]
            local rawStocks

            if catKey == "seed" then
                rawStocks = stockRoot and stockRoot.Shop and stockRoot.Shop.Stocks
            else
                rawStocks = stockRoot and stockRoot.Stocks
            end

            if typeof(rawStocks) ~= "table" then
                dwarn(catKey, "rawStocks not table:", typeof(rawStocks))
                continue
            end

            local stockTable = {}
            for key, entry in pairs(rawStocks) do
                stockTable[key] = getStockAmount(entry)
            end

            local selected = cfg.selected or {}
            local hasSelected = false
            for _, on in pairs(selected) do if on then hasSelected = true break end end

            local function processItem(name)
                local info = infoTable[name]
                if not info then return end

                local currency = info.currency or "Sheckles"
                local price    = info.price or 0
                if price <= 0 then return end

                local balance    = (currency == "GardenCoins") and gardenCoins or sheckles
                local stockCount = stockTable[name] or 0
                if stockCount <= 0 then return end
                if balance < price then return end

                dprint("Process", catKey, name, "stock", stockCount, "price", price, "cur", currency)
                cfg.buyFn(name, stockCount)
            end

            if hasSelected then
                for name, on in pairs(selected) do
                    if on then processItem(name) end
                end
            else
                for name, _ in pairs(infoTable) do
                    processItem(name)
                end
            end
        end
    end
end

-- =========================================
-- LOOP RUNNER
-- =========================================
local RUNNING = false

function M.Start()
    if RUNNING then return end
    RUNNING = true
    dprint("Start() loop running")

    task.spawn(function()
        while RUNNING do
            local ok, err = pcall(M.Tick)
            if not ok then
                dwarn("Tick error:", err)
            end
            task.wait(5) -- interval beli
        end
    end)
end

function M.Stop()
    RUNNING = false
    dprint("Stop() loop stopped")
end

function M.IsRunning()
    return RUNNING
end

-- Anti-DC Simple+ (tanpa global)
-- Tempatkan sebagai LocalScript di StarterPlayerScripts

local Players   = game:GetService("Players")
local VirtualUser = game:GetService("VirtualUser")
local VIM       = game:GetService("VirtualInputManager")
local Run       = game:GetService("RunService")
local LP        = Players.LocalPlayer

local function nudge()
    -- 1) Klik kanan kecil (cara klasik & paling aman)
    pcall(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new(0, 0))
    end)

    -- 2) Tap tombol kanan sebentar (tidak gerak jauh)
    pcall(function()
        VIM:SendKeyEvent(true, Enum.KeyCode.Right, false, game)
        task.wait(0.03)
        VIM:SendKeyEvent(false, Enum.KeyCode.Right, false, game)
    end)

    -- 3) Goyang kamera sedikit lalu balik (nyaris tak terlihat)
    local cam = workspace.CurrentCamera
    if cam then
        local cf = cam.CFrame
        cam.CFrame = cf * CFrame.Angles(0, math.rad(0.1), 0)
        task.wait(0.02)
        cam.CFrame = cf
    end
end

-- Jalur 1: bangunkan saat Roblox menandai idle
LP.Idled:Connect(nudge)

-- Jalur 2: heartbeat berkala (jangan tunggu 20 menit)
task.spawn(function()
    while true do
        task.wait(600 + math.random(0, 20)) -- 60â€“80 detik acak
        nudge()
    end
end)



LP.Idled:Connect(function()
    pcall(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new(0, 0))
    end)
end)



local function antiIdle()
    -- klik kanan klasik
    pcall(function()
        VirtualUser:CaptureController()
        VirtualUser:ClickButton2(Vector2.new(0, 0))
    end)

    -- goyang mouse dikit (nyaris nggak kelihatan)
    pcall(function()
        VIM:SendMouseMoveEvent(10, 10, 0, game)
    end)
end

LP.Idled:Connect(antiIdle)

task.spawn(function()
    while true do
        task.wait(600 + math.random(0, 20)) -- ~10 menit
        antiIdle()
    end
end)
-- PSReconnect.lua
-- RECONNECT ONLY
-- âŒ TIDAK AUTO START KG
-- âŒ TIDAK SENTUH AutoKGLoop
-- âœ… BOLEH AUTO EXEC SCRIPT (OPSIONAL)

local Players         = game:GetService("Players")
local TeleportService = game:GetService("TeleportService")
local CoreGui         = game:GetService("CoreGui")
local HttpService     = game:GetService("HttpService")

local LP = Players.LocalPlayer
local M  = {}

----------------------------------------------------------------
-- PREVENT MULTI LOAD
----------------------------------------------------------------
local G = (getgenv and getgenv()) or _G
if G.__PSRECONNECT_LOADED then
    return
end
G.__PSRECONNECT_LOADED = true

----------------------------------------------------------------
-- FLAGS
----------------------------------------------------------------
local TELEPORT_BLOCKED        = false
local AUTO_RECONNECT_ENABLED = true
local AUTO_EXEC_ENABLED      = false

local REJOIN_DELAY_SEC = 10
local SCRIPT_URL       = "https://gtwaapi.space/sc/auto_kg/MainUI.lua"

----------------------------------------------------------------
-- FILE READER (autosk/<username>.json)
----------------------------------------------------------------
local SAVE_DIR = "autosk"
local CAN_FS   = (typeof(readfile)=="function" and typeof(isfile)=="function")

local function _safeName(s)
    s = tostring(s or "player")
    s = s:gsub("[^%w%-_.]", "_")
    s = s:gsub("_+", "_")
    return s:sub(1, 48)
end

local function _getSaveFile()
    return ("%s/%s.json"):format(SAVE_DIR, _safeName(LP.Name))
end

local function readFlagsFromFile()
    if not CAN_FS then
        return true, false
    end

    local f = _getSaveFile()
    if not isfile(f) then
        return true, false
    end

    local ok, txt = pcall(readfile, f)
    if not ok or txt == "" then
        return true, false
    end

    local ok2, data = pcall(HttpService.JSONDecode, HttpService, txt)
    if not ok2 or type(data) ~= "table" then
        return true, false
    end

    local r = data.rejoin or {}
    return (r.auto_reconnect == true), (r.auto_exec == true)
end

----------------------------------------------------------------
-- QUEUE ON TELEPORT (AUTO EXEC ONLY)
----------------------------------------------------------------
local qtp = queue_on_teleport
    or (syn and syn.queue_on_teleport)
    or (fluxus and fluxus.queue_on_teleport)
    or (KRNL_LOADED and queue_on_teleport)

if qtp then
    local chunk = string.format([[
        local url = %q
        local Players = game:GetService("Players")
        local HttpService = game:GetService("HttpService")

        local function safeName(s)
            s = tostring(s or "player")
            s = s:gsub("[^%%w%%-_.]", "_")
            s = s:gsub("_+", "_")
            return s:sub(1, 48)
        end

        local CAN_FS = (typeof(readfile)=="function" and typeof(isfile)=="function")
        if not CAN_FS then return end

        local lp = Players.LocalPlayer
        if not lp then return end

        local f = ("autosk/%%s.json"):format(safeName(lp.Name))
        if not isfile(f) then return end

        local ok, txt = pcall(readfile, f)
        if not ok or txt=="" then return end

        local ok2, data = pcall(HttpService.JSONDecode, HttpService, txt)
        if not ok2 or type(data)~="table" then return end

        local r = data.rejoin or {}
        if r.auto_exec == true then
            pcall(function()
                loadstring(game:HttpGet(url))()
            end)
        end
    ]], SCRIPT_URL)

    pcall(function()
        qtp(chunk)
    end)
end

----------------------------------------------------------------
-- INITIAL LOAD FLAGS
----------------------------------------------------------------
task.spawn(function()
    local ar, ax = readFlagsFromFile()
    AUTO_RECONNECT_ENABLED = ar
    AUTO_EXEC_ENABLED      = ax

    if AUTO_EXEC_ENABLED then
        local GG = (getgenv and getgenv()) or _G
        if GG.__NODEHUB_AUTOEXECED then return end
        GG.__NODEHUB_AUTOEXECED = true

        pcall(function()
            loadstring(game:HttpGet(SCRIPT_URL))()
        end)
    end
end)

----------------------------------------------------------------
-- BLOCK PRIVATE / UNAUTHORIZED TELEPORT
----------------------------------------------------------------
TeleportService.TeleportInitFailed:Connect(function(player, result, errMsg)
    if player ~= LP then return end
    local m = string.lower(errMsg or "")
    if result == Enum.TeleportResult.Unauthorized
        or m:find("restricted")
        or m:find("private")
        or m:find("not authorized") then
        TELEPORT_BLOCKED = true
    end
end)

----------------------------------------------------------------
-- REJOIN CORE
----------------------------------------------------------------
local function doTeleport()
    if TELEPORT_BLOCKED then return end
    pcall(function()
        TeleportService:Teleport(game.PlaceId, LP)
    end)
end

local function tryRejoin()
    if not AUTO_RECONNECT_ENABLED then return end
    if TELEPORT_BLOCKED then return end
    task.delay(REJOIN_DELAY_SEC, doTeleport)
end

----------------------------------------------------------------
-- DISCONNECT DETECTION
----------------------------------------------------------------
local function isDisconnectText(t)
    t = string.lower(t or "")
    return t:find("error")
        or t:find("disconnected")
        or t:find("lost connection")
        or t:find("kicked")
        or t:find("reconnect")
end

local function hookPrompt()
    task.spawn(function()
        local gui = CoreGui:WaitForChild("RobloxPromptGui", 30)
        if not gui then return end
        local overlay = gui:WaitForChild("promptOverlay", 30)
        if not overlay then return end

        local function scan()
            for _, v in ipairs(overlay:GetDescendants()) do
                if v:IsA("TextLabel") and isDisconnectText(v.Text) then
                    tryRejoin()
                    return
                end
            end
        end

        scan()
        overlay.DescendantAdded:Connect(scan)

        while true do
            task.wait(1)
            scan()
        end
    end)
end

hookPrompt()

----------------------------------------------------------------
-- API FOR UI
----------------------------------------------------------------
function M.SetEnabled(flag)
    AUTO_RECONNECT_ENABLED = not not flag
end

function M.SetDelay(sec)
    REJOIN_DELAY_SEC = tonumber(sec) or REJOIN_DELAY_SEC
end

function M.SetAutoExec(flag)
    AUTO_EXEC_ENABLED = not not flag
end

function M.RejoinNow()
    doTeleport()
end

function M.IsTeleportBlocked()
    return TELEPORT_BLOCKED
end
-- feed.lua (NodeHub FAST)
-- Auto Feed pet aktif bila Hunger < AUTO_FEED_HUNGER_UNDER
-- Data:
--   profile = DataService:GetData()
--   pets    = profile.PetsData.PetInventory.Data
--   inv     = profile.InventoryData
-- Fruit:
--   ItemType == "Holdable" + ItemData.ItemName match selected fruits
-- Action:
--   Equip holdable tool (uuid inventory via attr c/C) -> ActivePetService:FireServer("Feed", petUUID)

local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LP = Players.LocalPlayer

local ActivePetsService = require(ReplicatedStorage.Modules.PetServices.ActivePetsService)
local DataService       = require(ReplicatedStorage.Modules.DataService)

local ge = ReplicatedStorage:FindFirstChild("GameEvents")
        or ReplicatedStorage:FindFirstChild("gameEvents")

----------------------------------------------------------------
-- CONFIG / DEBUG
----------------------------------------------------------------
local DEBUG = false

-- Speed knobs
local LOOP_TICK_SEC        = 0.25     -- lebih responsif
local EQUIP_WAIT           = 0.11     -- lebih cepat dari 0.35
local FIRE_WAIT            = 0.06
local GLOBAL_GAP_SEC       = 0.08     -- jeda antar feed action
local PER_PET_COOLDOWN_SEC = 0.25     -- jangan spam 1 pet
local CACHE_REFRESH_SEC    = 0.75     -- refresh cache holdable dari InventoryData

-- throttle warn supaya tidak spam
local LAST_WARN_AT = 0
local function warnThrottle(msg)
    if DEBUG then
    local now = os.clock()
    if (now - LAST_WARN_AT) >= 2.0 then
        LAST_WARN_AT = now
        warn(msg)
    end
    end
end

local function dprint(...)
    if DEBUG then print("[AutoFeed]", ...) end
end

local function dwarn(...)
    if DEBUG then warn("[AutoFeed]", ...) end
end

----------------------------------------------------------------
-- RUNTIME
----------------------------------------------------------------
local RUNNING    = false
local THREAD     = nil
local STOP_TOKEN = 0

local LAST_FEED_AT = {} -- [uuidCore] = os.clock()

----------------------------------------------------------------
-- UUID helpers (gaya boost)
----------------------------------------------------------------
local function normalizeUUID(u)
    if not u then return nil, nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core, "{" .. core .. "}"
end

----------------------------------------------------------------
-- Backpack tool cache (FAST O(1))
----------------------------------------------------------------
local BACKPACK = LP:WaitForChild("Backpack")
local TOOL_BY_ITEMCORE = {} -- [itemCore] = Tool

local function rebuildToolCache()
    TOOL_BY_ITEMCORE = {}
    for _, tool in ipairs(BACKPACK:GetChildren()) do
        if tool:IsA("Tool") then
            local attr = tool:GetAttribute("c") or tool:GetAttribute("C")
            if attr then
                local core = select(1, normalizeUUID(attr))
                if core then
                    TOOL_BY_ITEMCORE[core] = tool
                end
            end
        end
    end
end

rebuildToolCache()
BACKPACK.ChildAdded:Connect(function() task.defer(rebuildToolCache) end)
BACKPACK.ChildRemoved:Connect(function() task.defer(rebuildToolCache) end)

----------------------------------------------------------------
-- Unequip all tools
----------------------------------------------------------------
local function unequipAllTools()
    local char = LP.Character
    if not char then return end
    for _, inst in ipairs(char:GetChildren()) do
        if inst:IsA("Tool") then
            inst.Parent = BACKPACK
        end
    end
end

----------------------------------------------------------------
-- Find Tool by Inventory UUID (attr c/C) using cache
----------------------------------------------------------------
local function findToolByItemUUID(itemUUID)
    local itemCore = select(1, normalizeUUID(itemUUID))
    if not itemCore then return nil end
    return TOOL_BY_ITEMCORE[itemCore]
end

local function equipTool(tool)
    local char = LP.Character
    if not char or not tool then return false end

    -- unequip hanya jika ada tool lain yang berbeda
    for _, inst in ipairs(char:GetChildren()) do
        if inst:IsA("Tool") and inst ~= tool then
            unequipAllTools()
            break
        end
    end

    tool.Parent = char
    task.wait(EQUIP_WAIT)
    return true
end

----------------------------------------------------------------
-- Get PROFILE (sesuai kode dump kamu)
----------------------------------------------------------------
local function getProfile()
    local ok, profile = pcall(function()
        if type(DataService.GetData) == "function" then
            return DataService:GetData()
        end
        return nil
    end)
    if ok and type(profile) == "table" and next(profile) ~= nil then
        return profile
    end
    return nil
end

----------------------------------------------------------------
-- Resolve ActivePetService RemoteEvent (GameEvents)
----------------------------------------------------------------
local function resolveActivePetRE()
    if not ge then return nil end
    return ge:FindFirstChild("ActivePetService") or ge:FindFirstChild("ActivePetsService")
end

----------------------------------------------------------------
-- PetType filter (AUTO_FEED_PETS_SELECTED adalah pettype list)
-- Jika kosong -> ALL active pets
----------------------------------------------------------------
local function buildSelectedPetTypeMap()
    local map = _G.AUTO_FEED_PETS_SELECTED or AUTO_FEED_PETS_SELECTED or {}
    if type(map) ~= "table" then return nil end

    local out = {}
    local hasAny = false
    for petType, enabled in pairs(map) do
        if enabled then
            out[tostring(petType):lower()] = true
            hasAny = true
        end
    end

    if not hasAny then
        return nil -- ALL
    end

    return out
end

----------------------------------------------------------------
-- Active pets from ClientPetState (mirip boost) + pettype filter
----------------------------------------------------------------
local function getActivePetsFiltered()
    local out = {}

    local cps = ActivePetsService.ClientPetState
    if type(cps) ~= "table" then return out end

    local perPlayer = cps[LP] or cps[LP.UserId] or cps[LP.Name]
    if type(perPlayer) ~= "table" then return out end

    local selectedMap = buildSelectedPetTypeMap()

    for uuidKey, handlers in pairs(perPlayer) do
        if type(handlers) == "table" then
            local rec = handlers.PetModelHandler
                or handlers.PetVFXHandler
                or handlers.PetSoundHandler

            if type(rec) == "table" then
                local pd = rec.PetData or rec.Data or {}
                local pt = pd.PetType or rec.PetType or rec.Name or ""
                local petTypeName  = tostring(pt)
                local petTypeLower = petTypeName:lower()

                local allowed = (selectedMap == nil) or (selectedMap[petTypeLower] == true)
                if allowed then
                    local core, braced = normalizeUUID(rec.UUID or uuidKey)
                    if core and braced then
                        out[#out+1] = {
                            uuidCore   = core,
                            uuidBraced = braced,
                            petType    = petTypeName,
                        }
                    end
                end
            end
        end
    end

    return out
end

----------------------------------------------------------------
-- Hunger from PetsData (PROFILE)
----------------------------------------------------------------
local function getPetHunger(profile, petUUIDBraced)
    local petsData = profile and profile.PetsData
    if type(petsData) ~= "table" then return nil end

    local inv = petsData.PetInventory
    if type(inv) ~= "table" then return nil end

    local data = inv.Data
    if type(data) ~= "table" then return nil end

    local core, braced = normalizeUUID(petUUIDBraced)
    if not core then return nil end

    local rec = data[braced] or data[core]
    if type(rec) ~= "table" then return nil end

    local pd = rec.PetData
    if type(pd) ~= "table" then return nil end

    local h = pd.Hunger
    if type(h) == "number" then return h end
    return nil
end

----------------------------------------------------------------
-- Hunger under threshold (angka besar)
----------------------------------------------------------------
local function getHungerUnder()
    local v = tonumber(_G.AUTO_FEED_HUNGER_UNDER or AUTO_FEED_HUNGER_UNDER)
    if not v or v <= 0 then
        v = 10000 -- fallback aman
    end
    return v
end

----------------------------------------------------------------
-- Selected Holdable cache (FAST)
----------------------------------------------------------------
local CACHED_ITEM_UUIDS = {}
local CACHED_WANT_KEY   = ""
local CACHED_AT         = 0

local function computeWantKey()
    local selected = _G.AUTO_FEED_FRUITS_SELECTED or AUTO_FEED_FRUITS_SELECTED
    if type(selected) ~= "table" then return "" end
    local keys = {}
    for k, on in pairs(selected) do
        if on then
            keys[#keys+1] = tostring(k):lower()
        end
    end
    table.sort(keys)
    return table.concat(keys, "|")
end

local function rebuildHoldableCache(profile)
    local out = {}

    local selected = _G.AUTO_FEED_FRUITS_SELECTED or AUTO_FEED_FRUITS_SELECTED
    if type(selected) ~= "table" then
        selected = {}
    end

    -- build want map + detect apakah user memilih minimal 1 buah
    local want = {}
    local hasAnySelected = false
    for name, on in pairs(selected) do
        if on then
            want[tostring(name):lower()] = true
            hasAnySelected = true
        end
    end

    local inv = profile and profile.InventoryData
    if type(inv) ~= "table" then
        CACHED_ITEM_UUIDS = out
        return
    end

    for itemUUID, itemRec in pairs(inv) do
        if type(itemRec) == "table" and itemRec.ItemType == "Holdable" then
            local id = itemRec.ItemData
            if type(id) == "table" then
                local nm = tostring(id.ItemName or ""):lower()

                -- âœ… Filter Favorite: skip kalau IsFavorite true
                if id.IsFavorite ~= true then
                    -- âœ… Kalau user tidak select apa pun -> ALL holdable masuk
                    -- âœ… Kalau user select -> hanya yang cocok di want[]
                    if (not hasAnySelected) or (nm ~= "" and want[nm]) then
                        out[#out+1] = tostring(itemUUID)
                    end
                end
            else
                -- kalau ItemData bukan table, tetap bisa masuk kalau mode ALL (no selection)
                if (not hasAnySelected) then
                    out[#out+1] = tostring(itemUUID)
                end
            end
        end
    end

    CACHED_ITEM_UUIDS = out
end


local function getSelectedHoldableItemUUIDsFast(profile)
    local now = os.clock()
    local key = computeWantKey()

    if key ~= CACHED_WANT_KEY or (now - CACHED_AT) >= CACHE_REFRESH_SEC then
        CACHED_WANT_KEY = key
        CACHED_AT = now
        rebuildHoldableCache(profile)
    end

    return CACHED_ITEM_UUIDS
end

----------------------------------------------------------------
-- FEED ONE
----------------------------------------------------------------
local function feedOne(activePetRE, petUUIDBraced, itemUUID)
    local tool = findToolByItemUUID(itemUUID)
    if not tool then
        return false
    end

    if not equipTool(tool) then
        return false
    end

    task.wait(FIRE_WAIT)

    local ok = pcall(function()
        activePetRE:FireServer("Feed", petUUIDBraced)
    end)

    task.wait(FIRE_WAIT)
    -- unequip cepat biar tool balik (optional tapi aman)
    unequipAllTools()

    return ok == true
end

----------------------------------------------------------------
-- WORKER
----------------------------------------------------------------
local function worker(myToken)
    local activePetRE = resolveActivePetRE()
    if not activePetRE then
        dwarn("Remote ActivePetService tidak ditemukan di GameEvents")
        return
    end

    dprint("Worker start. Remote =", activePetRE.Name)

    while RUNNING and (myToken == STOP_TOKEN) do
        local profile = getProfile()
        if not profile then
            warnThrottle("[AutoFeed] PROFILE kosong / belum loaded (DataService:GetData())")
            task.wait(1)
        else
            local pets  = getActivePetsFiltered()
            local items = getSelectedHoldableItemUUIDsFast(profile)
            local under = getHungerUnder()

            if type(profile.InventoryData) ~= "table" then
                warnThrottle("[AutoFeed] profile.InventoryData tidak ada / bukan table")
            end

            if #items == 0 then
                warnThrottle("[AutoFeed] Holdable selected tidak ada / tidak ditemukan di InventoryData.")
            end

            if #pets > 0 and #items > 0 then
                for _, p in ipairs(pets) do
                    if not RUNNING or (myToken ~= STOP_TOKEN) then break end

                    local last = LAST_FEED_AT[p.uuidCore]
                    if last and (os.clock() - last) < PER_PET_COOLDOWN_SEC then
                        -- cooldown pet
                    else
                        local h = getPetHunger(profile, p.uuidBraced)
                        if type(h) == "number" then
                            if DEBUG then
                                dprint(("Pet %s Hunger=%s Under=%s"):format(p.petType, tostring(h), tostring(under)))
                            end

                            if h < under then
                                local fed = false
                                -- coba beberapa item (tool harus ada)
                                for i = 1, #items do
                                    if not RUNNING or (myToken ~= STOP_TOKEN) then break end
                                    local itemUUID = items[i]
                                    local ok = feedOne(activePetRE, p.uuidBraced, itemUUID)
                                    if ok then
                                        LAST_FEED_AT[p.uuidCore] = os.clock()
                                        fed = true
                                        if DEBUG then
                                            dprint("Feed OK:", p.petType, p.uuidBraced, "itemUUID:", itemUUID)
                                        end
                                        task.wait(GLOBAL_GAP_SEC)
                                        break
                                    end
                                end

                                if (not fed) and DEBUG then
                                    dprint("Skip feed (tool holdable tidak ada di backpack?)")
                                end
                            end
                        elseif DEBUG then
                            dprint("Hunger tidak ketemu:", p.petType, p.uuidBraced)
                        end
                    end
                end
            end

            task.wait(LOOP_TICK_SEC)
        end
    end

    dprint("Worker stop.")
end

----------------------------------------------------------------
-- PUBLIC API
----------------------------------------------------------------
local M = {}

function M.isRunning()
    return RUNNING
end

function M.setDebug(on)
    DEBUG = (on == true)
end

function M.setHungerUnder(v)
    local n = tonumber(v)
    if not n then return end
    AUTO_FEED_HUNGER_UNDER = n
    _G.AUTO_FEED_HUNGER_UNDER = n
end

function M.setPets(map)
    AUTO_FEED_PETS_SELECTED = map or {}
    _G.AUTO_FEED_PETS_SELECTED = AUTO_FEED_PETS_SELECTED
end

function M.setFruits(map)
    AUTO_FEED_FRUITS_SELECTED = map or {}
    _G.AUTO_FEED_FRUITS_SELECTED = AUTO_FEED_FRUITS_SELECTED
    -- invalidate cache segera
    CACHED_WANT_KEY = ""
end

function M.stop()
    RUNNING = false
    STOP_TOKEN += 1
    THREAD = nil
    pcall(unequipAllTools)
    dprint("Stop() token=", STOP_TOKEN)
end

function M.start()
    if RUNNING then
        dprint("Start() ignored: already running")
        return
    end

    RUNNING = true
    local myToken = STOP_TOKEN
    dprint("Start() token=", myToken)

    THREAD = task.spawn(function()
        pcall(worker, myToken)
    end)
end

function M.syncFromState()
    _G.AUTO_FEED_ENABLED      = (AUTO_FEED_ENABLED == true)
    _G.AUTO_FEED_HUNGER_UNDER = tonumber(_G.AUTO_FEED_HUNGER_UNDER or AUTO_FEED_HUNGER_UNDER)
    _G.AUTO_FEED_PETS_SELECTED   = _G.AUTO_FEED_PETS_SELECTED or AUTO_FEED_PETS_SELECTED or {}
    _G.AUTO_FEED_FRUITS_SELECTED = _G.AUTO_FEED_FRUITS_SELECTED or AUTO_FEED_FRUITS_SELECTED or {}

    -- invalidate cache kalau perlu
    CACHED_WANT_KEY = ""

    if _G.AUTO_FEED_ENABLED then
        M.start()
    else
        M.stop()
    end
end

_G.AutoFeed   = M
_G.AutoKGFeed = M
-- collectfruit.lua (NodeHub)
-- âœ… Auto Collect Fruit (NO UI, NO KG CHECK, NO AUTO SELL)
-- âœ… Collect only if holdables < 200
-- âœ… Toggle via: AUTO_COLLECT_FRUIT_ENABLED / _G.AUTO_COLLECT_FRUIT_ENABLED
-- âœ… API: SetEnabled / setEnabled / start / stop / syncFromState

local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local LP       = Players.LocalPlayer
local username = LP.Name

local M = {}

----------------------------------------------------------------
-- ENV / GLOBALS
----------------------------------------------------------------
local G = (getgenv and getgenv()) or _G

----------------------------------------------------------------
-- CONFIG
----------------------------------------------------------------
local LOOP_TICK_SEC      = 3        -- seberapa sering scan farm
local COLLECT_BURST_GAP  = 0.45        -- jeda setelah Collect()
local PROMPT_MARK_SEC    = 1.0         -- reset attr "Collected" setelah ini

local MAX_HOLDABLE       = 200         -- batas holdable backpack

-- Toggle global (state.lua akan set ini)
G.AUTO_COLLECT_FRUIT_ENABLED = (G.AUTO_COLLECT_FRUIT_ENABLED == true)
AUTO_COLLECT_FRUIT_ENABLED   = (AUTO_COLLECT_FRUIT_ENABLED == true)

----------------------------------------------------------------
-- DEPENDENCIES
----------------------------------------------------------------
local CollectController = require(
    ReplicatedStorage:WaitForChild("Modules"):WaitForChild("CollectController")
)

-- optional DataService (buat cek inventory lebih akurat)
local DataService = nil
pcall(function()
    DataService = require(ReplicatedStorage.Modules:WaitForChild("DataService"))
end)

----------------------------------------------------------------
-- INTERNAL STATE
----------------------------------------------------------------
local running = false

----------------------------------------------------------------
-- SAFE GETUPVALUE / GETFENV (executor compatibility)
----------------------------------------------------------------
local function _getUpvalue(fn, idx)
    if type(getupvalue) == "function" then
        local ok, v = pcall(getupvalue, fn, idx)
        if ok then return v end
    end
    return nil
end

local function _getFenv(fn)
    if type(getfenv) == "function" then
        local ok, env = pcall(getfenv, fn)
        if ok then return env end
    end
    return nil
end

-- table prompt queue yang dipakai CollectController
local tblPromptQueue = nil
do
    local env = _getFenv(CollectController.Collect)
    if type(env) == "table" and type(env.tbl_2_upvr) == "table" then
        tblPromptQueue = env.tbl_2_upvr
    else
        local uv = _getUpvalue(CollectController.Collect, 2)
        if type(uv) == "table" then
            tblPromptQueue = uv
        end
    end
end

----------------------------------------------------------------
-- FIND OWN FARM
----------------------------------------------------------------
local function getOwnFarm()
    local farmsFolder = workspace:FindFirstChild("Farm")
    if not farmsFolder then return nil end

    for _, farm in ipairs(farmsFolder:GetChildren()) do
        local ok, ownerValue = pcall(function()
            return farm:FindFirstChild("Important")
                and farm.Important:FindFirstChild("Data")
                and farm.Important.Data:FindFirstChild("Owner")
                and farm.Important.Data.Owner.Value
        end)

        if ok and ownerValue == username then
            return farm
        end
    end

    return nil
end

----------------------------------------------------------------
-- HOLDABLE COUNT CHECK
-- Tujuan: kalau holdable >= 200, jangan collect.
-- Implementasi: coba dari DataService inventory dulu, fallback scan Tool di Backpack/Character.
----------------------------------------------------------------
local function _countHoldablesFromProfile(profile)
    if type(profile) ~= "table" then return nil end
    local inv = profile.InventoryData
    if type(inv) ~= "table" then return nil end

    -- Heuristik: beberapa game simpan holdable di inv.Data / inv.Items / inv.Inventory / inv.Holdables
    local candidates = { inv.Holdables, inv.Data, inv.Items, inv.Inventory }
    for _, t in ipairs(candidates) do
        if type(t) == "table" then
            local n = 0
            for _, item in pairs(t) do
                if type(item) == "table" then
                    -- coba deteksi tipe holdable
                    local it = tostring(item.Type or item.ItemType or item.Category or ""):lower()
                    if it:find("hold") or it:find("fruit") then
                        n += 1
                    else
                        -- kalau tidak ada tipe, tetap hitung sebagai unit item (lebih aman untuk limit)
                        n += 1
                    end
                else
                    -- kadang isinya cuma id/uuid string
                    n += 1
                end
            end
            return n
        end
    end

    return nil
end

local function _countHoldablesByTools()
    local n = 0

    local function scan(container)
        if not container then return end
        for _, inst in ipairs(container:GetChildren()) do
            if inst:IsA("Tool") then
                -- heuristik: buah/holdable biasanya Tool biasa.
                -- kalau kamu punya pattern lebih spesifik, nanti bisa dipersempit.
                n += 1
            end
        end
    end

    scan(LP:FindFirstChild("Backpack"))
    local char = LP.Character
    if char then scan(char) end

    return n
end

local function getHoldableCount()
    if DataService and type(DataService.GetData) == "function" then
        local ok, profile = pcall(function()
            return DataService:GetData()
        end)
        if ok and type(profile) == "table" then
            local c = _countHoldablesFromProfile(profile)
            if type(c) == "number" then
                return c
            end
        end
    end

    -- fallback (kurang presisi tapi aman)
    return _countHoldablesByTools()
end

----------------------------------------------------------------
-- QUEUE FRUIT PROMPTS (NO KG CHECK)
----------------------------------------------------------------
local function queueFruitPrompts()
    if type(tblPromptQueue) ~= "table" then
        return 0
    end

    local farm = getOwnFarm()
    if not farm then return 0 end

    local important = farm:FindFirstChild("Important")
    if not important then return 0 end

    local plants = important:FindFirstChild("Plants_Physical")
    if not plants then return 0 end

    local count = 0

    for _, plant in ipairs(plants:GetChildren()) do
        local fruits = plant:FindFirstChild("Fruits")
        if fruits then
            for _, fruit in ipairs(fruits:GetChildren()) do
                local prompt = fruit:FindFirstChildWhichIsA("ProximityPrompt", true)
                if prompt and prompt.Enabled and not prompt:GetAttribute("Collected") then
                    tblPromptQueue[prompt] = true
                    prompt:SetAttribute("Collected", true)
                    count += 1

                    task.delay(PROMPT_MARK_SEC, function()
                        if prompt and prompt:IsDescendantOf(workspace) then
                            prompt:SetAttribute("Collected", nil)
                        end
                    end)
                end
            end
        end
    end

    return count
end

----------------------------------------------------------------
-- LOOP
----------------------------------------------------------------
local function collectLoop()
    while running do
        if G.AUTO_COLLECT_FRUIT_ENABLED == true then
            -- âœ… cek kapasitas holdable dulu
            local holdCount = getHoldableCount()
            if holdCount < MAX_HOLDABLE then
                local queued = queueFruitPrompts()
                if queued > 0 then
                    pcall(function()
                        CollectController:Collect()
                    end)
                    task.wait(COLLECT_BURST_GAP)
                end
            else
                -- penuh / mendekati penuh: skip collect
                -- (kalau mau, bisa kasih log debug di sini)
            end
        end

        task.wait(LOOP_TICK_SEC)
    end
end

----------------------------------------------------------------
-- PUBLIC API
----------------------------------------------------------------
function M.SetEnabled(on)
    on = (on == true)
    G.AUTO_COLLECT_FRUIT_ENABLED = on
    AUTO_COLLECT_FRUIT_ENABLED   = on

    if on then
        if not running then
            running = true
            task.spawn(collectLoop)
        end
    else
        running = false
    end
end

function M.setEnabled(on) return M.SetEnabled(on) end
function M.start() M.SetEnabled(true) end
function M.stop(reason) M.SetEnabled(false) end

function M.IsRunning()
    return running == true and (G.AUTO_COLLECT_FRUIT_ENABLED == true)
end

function M.syncFromState()
    local on = (AUTO_COLLECT_FRUIT_ENABLED == true) or (G.AUTO_COLLECT_FRUIT_ENABLED == true)
    M.SetEnabled(on)
end

-- optional: allow override max holdable
function M.SetMaxHoldable(n)
    n = tonumber(n)
    if n and n > 0 then
        MAX_HOLDABLE = math.floor(n + 0.5)
    end
end

_G.AutoCollectFruit = M
G.AutoCollectFruit  = M

-- auto apply kalau state sudah ON
task.defer(function()
    if (G.AUTO_COLLECT_FRUIT_ENABLED == true) then
        M.SetEnabled(true)
    end
end)

-- Fallback flag polling (opsional)

-- state.lua

task.wait(5)
local Players     = game:GetService("Players")
local HttpService = game:GetService("HttpService")

-- ðŸ”¹ GLOBAL ENV
local G = (getgenv and getgenv()) or _G

--------------------------------------------------
-- 1) DEFAULT GLOBALS / STATE
--------------------------------------------------

AUTO_GIFT_ENABLED = AUTO_GIFT_ENABLED or false

if G.AUTO_ACCEPT_ENABLED == nil then
    G.AUTO_ACCEPT_ENABLED = false
end
AUTO_ACCEPT_ENABLED = G.AUTO_ACCEPT_ENABLED

selected = selected or {
  boost = {}, xp = {}, noos = {}, seratusage = {}, gbxp = {}
}
local selected = selected  -- optional: local alias yang menunjuk global


-- MUTASI GBXP
GBXP_MUT_SELECTED = GBXP_MUT_SELECTED or {
    ["Nightmare"]   = true,
    ["JUMBO"]       = true,
    ["Mega"]        = true,
    ["Tethered"]    = true,
    ["Rainbow"]     = true,
    ["HyperHunger"] = true,
}

AUTOKG_MUTATION_ENABLED = (AUTOKG_MUTATION_ENABLED == nil) and false or AUTOKG_MUTATION_ENABLED
AUTO_BOOST_ENABLED     = (AUTO_BOOST_ENABLED == nil) and false or AUTO_BOOST_ENABLED
AUTO_BOOST_DELAY = AUTO_BOOST_DELAY or 20


AUTO_FEED_ENABLED         = (AUTO_FEED_ENABLED == true)
AUTO_FEED_HUNGER_UNDER       = tonumber(AUTO_FEED_HUNGER_UNDER) or 1000
AUTO_FEED_PETS_SELECTED   = AUTO_FEED_PETS_SELECTED or {}      -- map uuid/nama -> true (sesuai item key)
AUTO_FEED_FRUITS_SELECTED = AUTO_FEED_FRUITS_SELECTED or {}    -- map fruit -> true
AUTO_COLLECT_FRUIT_ENABLED = (AUTO_COLLECT_FRUIT_ENABLED == true)
-- AUTO BUY (NEW)
AUTO_BUY_SEED_ENABLED = (AUTO_BUY_SEED_ENABLED == nil) and false or AUTO_BUY_SEED_ENABLED
AUTO_BUY_EGG_ENABLED  = (AUTO_BUY_EGG_ENABLED  == nil) and false or AUTO_BUY_EGG_ENABLED
AUTO_BUY_GEAR_ENABLED = (AUTO_BUY_GEAR_ENABLED == nil) and false or AUTO_BUY_GEAR_ENABLED
-- state.lua
AUTO_RECONNECT_ENABLED   = (AUTO_RECONNECT_ENABLED   == nil) and false or AUTO_RECONNECT_ENABLED
AUTO_START_ON_REJOIN     = (AUTO_START_ON_REJOIN     == nil) and false or AUTO_START_ON_REJOIN  -- Auto Exec
AUTO_START_KG_ON_REJOIN  = (AUTO_START_KG_ON_REJOIN  == nil) and false or AUTO_START_KG_ON_REJOIN -- Auto Start KG



SEED_SELECTED = SEED_SELECTED or {}  -- map: [seedName/id]=true
EGG_SELECTED  = EGG_SELECTED  or {}  -- map: [eggName]=true
GEAR_SELECTED = GEAR_SELECTED or {}  -- map: [gearName/id]=true

--------------------------------------------------
-- DEFAULT CONFIG GIFT (GLOBAL, tapi aman pakai or)
--------------------------------------------------
GIFT_CFG = GIFT_CFG or {
    -- ROW 1
    enabled   = false,
    targets   = {},   -- map: { [targetId] = true }
    minKG     = 0,
    minAge    = 0,
    petType   = {},   -- map: { [petType] = true }

    -- ROW 2
    enabledB  = false,
    targetsB  = {},
    minKGB    = 0,
    minAgeB   = 0,
    petTypeB  = {},

    -- ROW 3
    enabledC  = false,
    targetsC  = {},
    minKGC    = 0,
    minAgeC   = 0,
    petTypeC  = {},

    -- AUTO ACCEPT
    autoAcceptTrade = false,
    autoAcceptGift  = false,
}

GIFT_MUT_SELECTED = GIFT_MUT_SELECTED or {}  -- [mutName] = true

SELECTED_PET_TYPES = SELECTED_PET_TYPES or {}
PETBOOST_SELECTED  = PETBOOST_SELECTED  or {}

activeTab = activeTab or "noos"

GBXP_STAGE_MODE = GBXP_STAGE_MODE 


TAB_AGE_EQUIP_MIN = TAB_AGE_EQUIP_MIN or {
    noos       = 40,
    boost      = 20,
    seratusage = 40,
    xp         = -40,
    gbxp       = 0,
}

TAB_AGE_UNEQUIP_MIN = TAB_AGE_UNEQUIP_MIN or {
    noos       = 0,
    boost      = 40,
    seratusage = 100,
    xp         = 40,
    gbxp       = 100,
}

TAB_W_EQUIP_MIN = TAB_W_EQUIP_MIN or {
    boost      = 0,
    xp         = 0,
    noos       = -60.45,
    seratusage =  60.45,
    gbxp       = 0,
}

TAB_W_UNEQUIP_MAX = TAB_W_UNEQUIP_MAX or {
    boost      = 0,
    xp         = 0,
    noos       = 60.45,
    seratusage = 0,
    gbxp       = 0,
}

GBXP_MAX_EQUIP = GBXP_MAX_EQUIP or 2

GBXP_TYPE_WHITELIST = GBXP_TYPE_WHITELIST or {
    -- ... isi kamu nantinya ...
}

function setGBXPStageMode(mode)
    mode = tostring(mode or "auto")

    mode = mode:gsub("%s+", ""):gsub(",", "")
    local upper = mode:upper()

    if upper == "AUTO" then
        GBXP_STAGE_MODE = "auto"
    elseif upper == "A" or upper == "B" or upper == "C" or upper == "D" then
        GBXP_STAGE_MODE = upper
    elseif upper == "BC" or upper == "CB" or upper == "CD" or upper == "DC" then
        GBXP_STAGE_MODE = upper
    elseif upper == "CAD" then
        GBXP_STAGE_MODE = upper
    else
        --warn("[GBXP] mode stage invalid:", mode, "pakai: auto / A / B / C / D / BC / CD / CAD")
        return
    end

    CURRENT_STAGE     = nil
    LAST_TARGET_UUID  = nil
    LAST_MODE         = nil
    __RESUME_REAPPLY  = true
end


--------------------------------------------------
-- 2) PERSISTENCE (SAVE_DIR, _safeName, save/load)
--------------------------------------------------
local SAVE_TABS = { boost=true, noos=true, xp=true , seratusage=true }
local CAN_FS = (typeof(writefile)=="function" and typeof(readfile)=="function"
             and typeof(isfile)=="function" and typeof(makefolder)=="function")

local SAVE_DIR = "autosk"

-- Sanitisasi username biar aman untuk nama file
local function _safeName(s)
    s = tostring(s or "player")
    -- izinkan huruf/angka/underscore/dash/dot; lainnya diganti "_"
    s = s:gsub("[^%w%-_.]", "_")
    -- rapikan underscore berulang
    s = s:gsub("_+", "_")
    -- batasi panjang kalau perlu
    return s:sub(1, 48)
end

local function _ensureFolder()
    if not CAN_FS then return false end
    if not isfolder(SAVE_DIR) then pcall(makefolder, SAVE_DIR) end
    return isfolder(SAVE_DIR)
end

-- Pakai username (disarankan tetap gabung PlaceId supaya per-game)
local USERNAME_KEY = _safeName(Players.LocalPlayer.Name)
local SAVE_FILE = ("%s/%s.json"):format(SAVE_DIR, USERNAME_KEY)


-- (Opsional) migrasi dari format lama (berbasis userId) ke username-berkas jika ada
local OLD_SAVE_FILE = ("%s/%d_%d.json"):format(SAVE_DIR, game.PlaceId, Players.LocalPlayer.UserId)
pcall(function()
    if CAN_FS and _ensureFolder() and (not isfile(SAVE_FILE)) and isfile(OLD_SAVE_FILE) then
        local ok, txt = pcall(readfile, OLD_SAVE_FILE)
        if ok and type(txt)=="string" and #txt > 0 then
            pcall(writefile, SAVE_FILE, txt)
            -- kalau ingin menghapus berkas lama dan executor mendukung delfile, kamu bisa:
            -- if typeof(delfile)=="function" then pcall(delfile, OLD_SAVE_FILE) end
        end
    end
end)

-- Utility kecil agar hanya simpan entry yang true
-- Utility kecil agar hanya simpan entry yang true
local function _cleanSet(setTbl)
    if type(setTbl) ~= "table" then return {} end
    local out = {}
    for k,v in pairs(setTbl) do if v == true then out[k] = true end end
    return out
end

local function saveSelectionsToFile()
    if not CAN_FS or not _ensureFolder() then return end

    local payload = {
        boost       = _cleanSet(selected.boost       or {}),
        noos        = _cleanSet(selected.noos        or {}),
        seratusage  = _cleanSet(selected.seratusage  or {}),
        xp          = _cleanSet(selected.xp          or {}),

        ages = {
            equip   = TAB_AGE_EQUIP_MIN   or {},
            unequip = TAB_AGE_UNEQUIP_MIN or {},
        },
    
       kg = {
            equip   = TAB_W_EQUIP_MIN   or {},
            unequip = TAB_W_UNEQUIP_MAX or {},
        },

        gbxp_mut = GBXP_MUT_SELECTED or {},
        
        selected_pet_types = SELECTED_PET_TYPES or {},
        petboost           = _cleanSet(PETBOOST_SELECTED or {}),
        auto_boost_delay        = tonumber(AUTO_BOOST_DELAY) or 20,
        
                ----------------------------------------------------------------
        -- AUTO BUY (NEW)
        ----------------------------------------------------------------
        auto_buy = {
            seed_enabled = (AUTO_BUY_SEED_ENABLED == true),
            egg_enabled  = (AUTO_BUY_EGG_ENABLED  == true),
            gear_enabled = (AUTO_BUY_GEAR_ENABLED == true),

            seed_selected = _cleanSet(SEED_SELECTED or {}),
            egg_selected  = _cleanSet(EGG_SELECTED  or {}),
            gear_selected = _cleanSet(GEAR_SELECTED or {}),
        },
    
auto_feed = {
    enabled      = (AUTO_FEED_ENABLED == true),

    -- NEW
    hunger_under = tonumber(AUTO_FEED_HUNGER_UNDER) or 60,

    pets         = _cleanSet(AUTO_FEED_PETS_SELECTED or {}),
    fruits       = _cleanSet(AUTO_FEED_FRUITS_SELECTED or {}),
},

    
            ----------------------------------------------------------------
        -- REJOIN SETTINGS (NEW)
        ----------------------------------------------------------------
rejoin = {
    auto_reconnect = (AUTO_RECONNECT_ENABLED == true),
    auto_exec      = (AUTO_START_ON_REJOIN == true),
    auto_start_kg  = (AUTO_START_KG_ON_REJOIN == true),
},




        gift_cfg = {
            ----------------------------------------------------------------
            -- FORMAT BARU (UTAMA)
            ----------------------------------------------------------------
            -- TARGET (map atau struct, tergantung UI-mu)
            targets   = GIFT_CFG.targets   or {},  -- group A
            targetsB  = GIFT_CFG.targetsB  or {},  -- group B
            targetsC  = GIFT_CFG.targetsC  or {},  -- group C

            -- LIMIT KG / AGE
            minKG     = tonumber(GIFT_CFG.minKG)   or 0,  -- A
            minAge    = tonumber(GIFT_CFG.minAge)  or 0,
            minKGB    = tonumber(GIFT_CFG.minKGB)  or 0,  -- B
            minAgeB   = tonumber(GIFT_CFG.minAgeB) or 0,
            minKGC    = tonumber(GIFT_CFG.minKGC)  or 0,  -- C
            minAgeC   = tonumber(GIFT_CFG.minAgeC) or 0,

            -- ENABLE PER ROW
            enabled   = (GIFT_CFG.enabled  == true),
            enabledB  = (GIFT_CFG.enabledB == true),
            enabledC  = (GIFT_CFG.enabledC == true),

            -- PET TYPE FILTER (map: [petName] = true)
            petType   = _cleanSet(GIFT_CFG.petType   or {}),
            petTypeB  = _cleanSet(GIFT_CFG.petTypeB  or {}),
            petTypeC  = _cleanSet(GIFT_CFG.petTypeC  or {}),

            -- AUTO ACCEPT (NEW)
            autoAcceptTrade = (GIFT_CFG.autoAcceptTrade == true),
            autoAcceptGift  = (GIFT_CFG.autoAcceptGift  == true),

            ----------------------------------------------------------------
            -- LEGACY (BIAR FILE LAMA + UI LAMA MASIH KOMPATIBEL)
            ----------------------------------------------------------------
            targetUserId = GIFT_CFG.targetUserId,
            targetName   = GIFT_CFG.targetName,
        },
    
    



        gift_mut = _cleanSet(GIFT_MUT_SELECTED or {}),
        

        
        gbxpMaxEquip = tonumber(GBXP_MAX_EQUIP) or 0,  -- <<< DI SINI

autokg_mutation_enabled = AUTOKG_MUTATION_ENABLED == true,
 auto_boost_enabled   = AUTO_BOOST_ENABLED == true,
        ----------------------------------------------------------------
        -- â¬‡â¬‡â¬‡ TOGGLE AUTO GIFT / ACCEPT â¬‡â¬‡â¬‡
        ----------------------------------------------------------------
toggle = {
    auto_gift   = AUTO_GIFT_ENABLED,
    auto_accept = G.AUTO_ACCEPT_ENABLED,
    auto_collect_fruit  = (AUTO_COLLECT_FRUIT_ENABLED == true),
},


        ----------------------------------------------------------------
        -- â¬‡â¬‡â¬‡ MODE GBXP STAGE DISIMPAN DI SINI â¬‡â¬‡â¬‡
        ----------------------------------------------------------------
        stage_mode = GBXP_STAGE_MODE or "auto",

        _meta   = {
            place     = game.PlaceId,
            user      = Players.LocalPlayer.UserId,
            user_name = Players.LocalPlayer.Name,
            ts        = os.time(),
        },
    }

    local ok, json = pcall(HttpService.JSONEncode, HttpService, payload)
    if ok and type(json)=="string" then
        pcall(writefile, SAVE_FILE, json)
    end
end





local function loadSelectionsFromFile()
    if not CAN_FS or not isfile(SAVE_FILE) then return end

    local ok, text = pcall(readfile, SAVE_FILE)
    if not ok or not text or text == "" then return end

    local ok2, data = pcall(HttpService.JSONDecode, HttpService, text)
    if not ok2 or type(data) ~= "table" then return end

    ----------------------------------------------------------------
    -- 1) RESTORE SELECTED UUID PER TAB
    ----------------------------------------------------------------
    for k,_ in pairs(SAVE_TABS) do
        if type(data[k]) == "table" then
            selected[k] = {}
            for uuid, v in pairs(data[k]) do
                if v == true then
                    selected[k][uuid] = true
                end
            end
        end
    end

    ----------------------------------------------------------------
    -- 2) RESTORE KONFIG UMUR
    ----------------------------------------------------------------
    if type(data.ages) == "table" then
        if type(data.ages.equip) == "table" then
            for tab, val in pairs(data.ages.equip) do
                if TAB_AGE_EQUIP_MIN[tab] ~= nil and type(val) == "number" then
                    TAB_AGE_EQUIP_MIN[tab] = val
                end
            end
        end
        if type(data.ages.unequip) == "table" then
            for tab, val in pairs(data.ages.unequip) do
                if TAB_AGE_UNEQUIP_MIN[tab] ~= nil and type(val) == "number" then
                    TAB_AGE_UNEQUIP_MIN[tab] = val
                end
            end
        end
    end
    
    
        if type(data.kg) == "table" then
        if type(data.kg.equip) == "table" then
            for tab, val in pairs(data.kg.equip) do
                if TAB_W_EQUIP_MIN[tab] ~= nil and type(val) == "number" then
                    TAB_W_EQUIP_MIN[tab] = val
                end
            end
        end
        if type(data.kg.unequip) == "table" then
            for tab, val in pairs(data.kg.unequip) do
                if TAB_W_UNEQUIP_MAX[tab] ~= nil and type(val) == "number" then
                    TAB_W_UNEQUIP_MAX[tab] = val
                end
            end
        end
    end

    ----------------------------------------------------------------
    -- 3) RESTORE MUTASI GBXP (TAB GBXP)
    ----------------------------------------------------------------
    if type(data.gbxp_mut) == "table" then
        GBXP_MUT_SELECTED = {}
        for mutName, on in pairs(data.gbxp_mut) do
            if on then
                GBXP_MUT_SELECTED[tostring(mutName)] = true
            end
        end
    end
    
----------------------------------------------------------------
-- 3b) RESTORE SELECTED_PET_TYPES (dropdown "Select Pet To Boost")
----------------------------------------------------------------
if type(data.selected_pet_types) == "table" then
    SELECTED_PET_TYPES = {}
    for petName, on in pairs(data.selected_pet_types) do
        if on then
            SELECTED_PET_TYPES[tostring(petName)] = true
        end
    end
end


if type(data.petboost) == "table" then
    PETBOOST_SELECTED = {}
    for uuid, on in pairs(data.petboost) do
        if on then
            PETBOOST_SELECTED[tostring(uuid)] = true
        end
    end
end

if data.auto_boost_delay ~= nil then
    AUTO_BOOST_DELAY = tonumber(data.auto_boost_delay) or 20
    local G = (getgenv and getgenv()) or _G
    G.AUTO_BOOST_DELAY = AUTO_BOOST_DELAY
end   

    if type(data.toggle.auto_collect_fruit) == "boolean" then
        AUTO_COLLECT_FRUIT_ENABLED = data.toggle.auto_collect_fruit
        G.AUTO_COLLECT_FRUIT_ENABLED = AUTO_COLLECT_FRUIT_ENABLED
    end


    ----------------------------------------------------------------
    -- RESTORE AUTO BUY (NEW)
    ----------------------------------------------------------------
    if type(data.auto_buy) == "table" then
        local ab = data.auto_buy

        if type(ab.seed_enabled) == "boolean" then
            AUTO_BUY_SEED_ENABLED = ab.seed_enabled
        end
        if type(ab.egg_enabled) == "boolean" then
            AUTO_BUY_EGG_ENABLED = ab.egg_enabled
        end
        if type(ab.gear_enabled) == "boolean" then
            AUTO_BUY_GEAR_ENABLED = ab.gear_enabled
        end

        if type(ab.seed_selected) == "table" then
            SEED_SELECTED = {}
            for k, on in pairs(ab.seed_selected) do
                if on == true then
                    SEED_SELECTED[tostring(k)] = true
                end
            end
        end

        if type(ab.egg_selected) == "table" then
            EGG_SELECTED = {}
            for k, on in pairs(ab.egg_selected) do
                if on == true then
                    EGG_SELECTED[tostring(k)] = true
                end
            end
        end

        if type(ab.gear_selected) == "table" then
            GEAR_SELECTED = {}
            for k, on in pairs(ab.gear_selected) do
                if on == true then
                    GEAR_SELECTED[tostring(k)] = true
                end
            end
        end
    end

if type(data.auto_feed) == "table" then
    local af = data.auto_feed

    if type(af.enabled) == "boolean" then
        AUTO_FEED_ENABLED = af.enabled
    end

    -- NEW: hunger_under (utama)
    if af.hunger_under ~= nil then
        AUTO_FEED_HUNGER_UNDER = tonumber(af.hunger_under) or AUTO_FEED_HUNGER_UNDER
    -- BACKWARD COMPAT: kalau file lama masih pakai delay, mapping ke hunger_under default
    elseif af.delay ~= nil and AUTO_FEED_HUNGER_UNDER == nil then
        -- pilih salah satu:
        -- (A) abaikan delay lama (recommended)
        AUTO_FEED_HUNGER_UNDER = AUTO_FEED_HUNGER_UNDER or 60

        -- (B) atau kalau kamu mau "delay" lama dipakai jadi hunger_under (tidak recommended)
        -- AUTO_FEED_HUNGER_UNDER = tonumber(af.delay) or (AUTO_FEED_HUNGER_UNDER or 60)
    end

    if type(af.pets) == "table" then
        AUTO_FEED_PETS_SELECTED = {}
        for k, on in pairs(af.pets) do
            if on then
                AUTO_FEED_PETS_SELECTED[tostring(k)] = true
            end
        end
    end

    if type(af.fruits) == "table" then
        AUTO_FEED_FRUITS_SELECTED = {}
        for k, on in pairs(af.fruits) do
            if on then
                AUTO_FEED_FRUITS_SELECTED[tostring(k)] = true
            end
        end
    end
end


    ----------------------------------------------------------------
    -- 4) RESTORE KONFIG AUTO GIFT (âš™)
    ----------------------------------------------------------------
    if type(data.gift_cfg) == "table" then
        local cfg = data.gift_cfg

        ----------------------------------------------------------------
        -- 4a) RESTORE TARGETS A / B / C
        --     Bisa format baru (map bool) atau lama (struct {userId,name})
        ----------------------------------------------------------------
        local function restoreTargetsField(src, destKey)
            if type(src) ~= "table" then return end

            -- deteksi: apakah table-nya struct lama atau map bool baru
            local isStruct = false
            for _, v in pairs(src) do
                if type(v) == "table" and (v.userId or v.name) then
                    isStruct = true
                    break
                end
            end

            GIFT_CFG[destKey] = {}

            if isStruct then
                -- format lama: [k] = {userId=, name=}
                for k, info in pairs(src) do
                    if type(info) == "table" then
                        local uid  = info.userId or tonumber(k)
                        local name = info.name or ""
                        if uid then
                            GIFT_CFG[destKey][uid] = { userId = uid, name = name }
                        end
                    end
                end
            else
                -- format baru: [key] = true/false
                for k, on in pairs(src) do
                    if on then
                        GIFT_CFG[destKey][k] = true
                    end
                end
            end
        end

        restoreTargetsField(cfg.targets,  "targets")
        restoreTargetsField(cfg.targetsB, "targetsB")
        restoreTargetsField(cfg.targetsC, "targetsC")

        ----------------------------------------------------------------
        -- 4b) RESTORE LIMIT KG / AGE
        ----------------------------------------------------------------
        if tonumber(cfg.minKG) then
            GIFT_CFG.minKG = tonumber(cfg.minKG)
        end
        if tonumber(cfg.minAge) then
            GIFT_CFG.minAge = tonumber(cfg.minAge)
        end
        if tonumber(cfg.minKGB) then
            GIFT_CFG.minKGB = tonumber(cfg.minKGB)
        end
        if tonumber(cfg.minAgeB) then
            GIFT_CFG.minAgeB = tonumber(cfg.minAgeB)
        end
        if tonumber(cfg.minKGC) then
            GIFT_CFG.minKGC = tonumber(cfg.minKGC)
        end
        if tonumber(cfg.minAgeC) then
            GIFT_CFG.minAgeC = tonumber(cfg.minAgeC)
        end

        ----------------------------------------------------------------
        -- 4c) RESTORE ENABLE FLAG PER ROW
        ----------------------------------------------------------------
        if type(cfg.enabled) == "boolean" then
            GIFT_CFG.enabled = cfg.enabled
        end
        if type(cfg.enabledB) == "boolean" then
            GIFT_CFG.enabledB = cfg.enabledB
        end
        if type(cfg.enabledC) == "boolean" then
            GIFT_CFG.enabledC = cfg.enabledC
        end

        ----------------------------------------------------------------
        -- 4d) RESTORE PET TYPE FILTER
        ----------------------------------------------------------------
        local function restorePetTypeField(src, destKey)
            if type(src) ~= "table" then return end
            GIFT_CFG[destKey] = {}
            for petName, on in pairs(src) do
                if on then
                    GIFT_CFG[destKey][tostring(petName)] = true
                end
            end
        end

        restorePetTypeField(cfg.petType,  "petType")
        restorePetTypeField(cfg.petTypeB, "petTypeB")
        restorePetTypeField(cfg.petTypeC, "petTypeC")

        ----------------------------------------------------------------
        -- 4e) RESTORE AUTO ACCEPT (NEW)
        ----------------------------------------------------------------
        if type(cfg.autoAcceptTrade) == "boolean" then
            GIFT_CFG.autoAcceptTrade = cfg.autoAcceptTrade
        end
        if type(cfg.autoAcceptGift) == "boolean" then
            GIFT_CFG.autoAcceptGift = cfg.autoAcceptGift
        end

        ----------------------------------------------------------------
        -- 4f) LEGACY â†’ kalau file lama cuma punya targetUserId/targetName
        --      MIGRASI ke GIFT_CFG.targets (group A)
        ----------------------------------------------------------------
        if (not GIFT_CFG.targets or next(GIFT_CFG.targets) == nil) then
            local uid  = cfg.targetUserId
            local name = cfg.targetName

            if (type(uid) == "number" or type(uid) == "string") and type(name) == "string" then
                local numId = tonumber(uid)
                if numId then
                    GIFT_CFG.targets = GIFT_CFG.targets or {}
                    GIFT_CFG.targets[numId] = { userId = numId, name = name }
                end
            end
        end

        -- Simpan tetap legacy value kalau kamu masih butuh di tempat lain
        if type(cfg.targetUserId) == "number" or type(cfg.targetUserId) == "string" then
            GIFT_CFG.targetUserId = cfg.targetUserId
        end
        if type(cfg.targetName) == "string" then
            GIFT_CFG.targetName = cfg.targetName
        end
    end



    if type(data.gift_mut) == "table" then
        GIFT_MUT_SELECTED = {}
        for mutName, on in pairs(data.gift_mut) do
            if on then
                GIFT_MUT_SELECTED[tostring(mutName)] = true
            end
        end
    end

    if type(data.autokg_mutation_enabled) == "boolean" then
        AUTOKG_MUTATION_ENABLED = data.autokg_mutation_enabled
    end
    if type(data.auto_boost_enabled) == "boolean" then
    AUTO_BOOST_ENABLED = data.auto_boost_enabled
   
    end
    
    
    
    ----------------------------------------------------------------
    -- 5) RESTORE TOGGLE STATE (AUTO GIFT + AUTO ACCEPT)
    ----------------------------------------------------------------
if type(data.toggle) == "table" then
    if type(data.toggle.auto_gift) == "boolean" then
        AUTO_GIFT_ENABLED = data.toggle.auto_gift
        
    end
    if type(data.toggle.auto_accept) == "boolean" then
        G.AUTO_ACCEPT_ENABLED = data.toggle.auto_accept
        AUTO_ACCEPT_ENABLED   = G.AUTO_ACCEPT_ENABLED
    end


end
    ----------------------------------------------------------------
    -- 5b) RESTORE REJOIN SETTINGS (NEW)
    ----------------------------------------------------------------
if type(data.rejoin) == "table" then
    if type(data.rejoin.auto_reconnect) == "boolean" then
        AUTO_RECONNECT_ENABLED = data.rejoin.auto_reconnect
    end
    if type(data.rejoin.auto_exec) == "boolean" then
        AUTO_START_ON_REJOIN = data.rejoin.auto_exec
    end
    if type(data.rejoin.auto_start_kg) == "boolean" then
        AUTO_START_KG_ON_REJOIN = data.rejoin.auto_start_kg
    end
end

pcall(function()
    if _G.PSReconnect and type(_G.PSReconnect.SetEnabled) == "function" then
        _G.PSReconnect:SetEnabled(AUTO_RECONNECT_ENABLED == true)
    end
end)


    ----------------------------------------------------------------
    -- 6) RESTORE GBXP_STAGE_MODE
    ----------------------------------------------------------------
    if type(data.stage_mode) == "string" then
        if setGBXPStageMode then
            -- pakai helper supaya CURRENT_STAGE, dll ikut di-reset
            setGBXPStageMode(data.stage_mode)
        else
            -- fallback kalau fungsi belum ada
            GBXP_STAGE_MODE = data.stage_mode
        end
    end
    
     if data.gbxpMaxEquip ~= nil then
        GBXP_MAX_EQUIP = tonumber(data.gbxpMaxEquip) or 0
    end

    ----------------------------------------------------------------
    -- 7) REFRESH UI (kalau sudah ada elemen UI-nya)
    ----------------------------------------------------------------
    -- label jumlah pilih per tab
    if refreshSelectedHeaderLabels then
        refreshSelectedHeaderLabels()
    end

    -- panel umur kanan
    if ui and ui.refreshAgeConfigUI then
        ui.refreshAgeConfigUI()
    end

    -- list mutasi GBXP
    if ui and ui.rebuildGBXPMutationList then
        ui.rebuildGBXPMutationList()
    end
    
        -- dropdown pet type untuk boost
    if ui and ui.rebuildPetTypeList then
        ui.rebuildPetTypeList()
    end


    -- list mutasi Auto Gift (âš™)
    if ui and ui.rebuildGiftMutList then
        ui.rebuildGiftMutList()
        updateGiftModeDescription()
    end

    -- isi textbox / tombol Auto Gift
        if ui then
        ----------------------------------------------------------------
        -- Target A & B button text
        ----------------------------------------------------------------
        if refreshTargetLabel then
            refreshTargetLabel()
        elseif ui.giftTargetBtn then
            -- fallback kalau refreshTargetLabel belum ada
            if GIFT_CFG.targetName and GIFT_CFG.targetName ~= "" then
                ui.giftTargetBtn.Text = "  " .. GIFT_CFG.targetName
            else
                ui.giftTargetBtn.Text = "  Target A: pilih player..."
            end
        end

        ----------------------------------------------------------------
        -- TextBox KG/AGE A & B
        ----------------------------------------------------------------
        if ui.giftKgBox then
            if GIFT_CFG.minKG and GIFT_CFG.minKG ~= 0 then
                ui.giftKgBox.Text = tostring(GIFT_CFG.minKG)
            else
                ui.giftKgBox.Text = ""
            end
        end

        if ui.giftAgeBox then
            if GIFT_CFG.minAge and GIFT_CFG.minAge ~= 0 then
                ui.giftAgeBox.Text = tostring(GIFT_CFG.minAge)
            else
                ui.giftAgeBox.Text = ""
            end
        end

        if ui.giftKgBoxB then
            if GIFT_CFG.minKGB and GIFT_CFG.minKGB ~= 0 then
                ui.giftKgBoxB.Text = tostring(GIFT_CFG.minKGB)
            else
                ui.giftKgBoxB.Text = ""
            end
        end

        if ui.giftAgeBoxB then
            if GIFT_CFG.minAgeB and GIFT_CFG.minAgeB ~= 0 then
                ui.giftAgeBoxB.Text = tostring(GIFT_CFG.minAgeB)
            else
                ui.giftAgeBoxB.Text = ""
            end
        end
    end


    if ui then
        if ui.updateGiftToggleUI then
            ui.updateGiftToggleUI()
        end
        if ui.updateAcceptToggleUI then
            ui.updateAcceptToggleUI()
        end
    end

    -- sinkronkan teks & warna tombol MODE ke stage_mode yang baru di-load
    if _updateModeText then
        _updateModeText()
    end
    if refreshModeBtn then
        refreshModeBtn()
    end
    
 pcall(function()
    if _G.AutoKGBoost and _G.AutoKGBoost.syncFromState then
        _G.AutoKGBoost:syncFromState()
    end
end)   

    ----------------------------------------------------------------
    -- 8) PUSH MUTASI GBXP ke WorldShardCleaner (kalau ada)
    ----------------------------------------------------------------
pcall(function()
    if _G.WorldShardCleaner then
        if _G.WorldShardCleaner.setGoodMutationsFromGBXP then
            _G.WorldShardCleaner:setGoodMutationsFromGBXP(GBXP_MUT_SELECTED)
        end

        if _G.WorldShardCleaner.setEnabled then
            _G.WorldShardCleaner:setEnabled(AUTOKG_MUTATION_ENABLED)
        end
    end
end)

    -- sync agar module auto buy langsung kebaca
    pcall(function()
        if STATE then
            STATE.autoBuySeeds = (AUTO_BUY_SEED_ENABLED == true)
            STATE.autoBuyEgg   = (AUTO_BUY_EGG_ENABLED  == true)
            STATE.autoBuyGear  = (AUTO_BUY_GEAR_ENABLED == true)
        end
        if SHOP_INFO then
            if SHOP_INFO.seed then SHOP_INFO.seed.selected = SEED_SELECTED or {} end
            if SHOP_INFO.egg  then SHOP_INFO.egg.selected  = EGG_SELECTED  or {} end
            if SHOP_INFO.gear then SHOP_INFO.gear.selected = GEAR_SELECTED or {} end
        end
    end)
    
pcall(function()
    local Feed = rawget(_G, "AutoFeed") or rawget(_G, "AutoKGFeed")
    if Feed and type(Feed.syncFromState) == "function" then
        Feed:syncFromState()
    end
end)

pcall(function()
    local M = rawget(_G, "AutoCollectFruit") or rawget(G, "AutoCollectFruit")
    if M then
        if type(M.SetEnabled) == "function" then
            M.SetEnabled(AUTO_COLLECT_FRUIT_ENABLED == true)
        elseif type(M.setEnabled) == "function" then
            M.setEnabled(AUTO_COLLECT_FRUIT_ENABLED == true)
        elseif (AUTO_COLLECT_FRUIT_ENABLED == true) and type(M.start) == "function" then
            M.start()
        elseif (AUTO_COLLECT_FRUIT_ENABLED ~= true) and type(M.stop) == "function" then
            M.stop("state_load")
        end
    end
end)


end

-- ===== deps untuk pruneSelectedFromStore (SAMAKAN dengan PetListView) =====
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer

local ActivePetsService = nil
pcall(function()
    ActivePetsService = require(ReplicatedStorage.Modules.PetServices.ActivePetsService)
end)

local function __normUUID(u)
    if not u or u == "" then return nil, nil end
    local core = tostring(u):match("{?([0-9a-fA-F%-]+)}?") or tostring(u)
    return core, "{" .. core .. "}"
end

local function __getStoreBag()
    if not ActivePetsService or type(ActivePetsService.GetPlayerDatastorePetData) ~= "function" then
        return nil
    end
    local ok, store = pcall(function()
        return ActivePetsService:GetPlayerDatastorePetData(LocalPlayer.Name)
    end)
    if not ok or type(store) ~= "table" then
        return nil
    end
    local inv = store.PetInventory
    local data = inv and inv.Data
    if type(data) ~= "table" then
        return nil
    end
    return data
end



local function pruneSelectedFromStore()
    local bag = __getStoreBag()
    if not bag then return false end

    local exists = {}
    for rawUUID,_ in pairs(bag) do
        local core, br = __normUUID(rawUUID)
        if core then exists[core] = true end
        if br then exists[br] = true end
    end

    local function pruneSet(setTbl)
        if type(setTbl) ~= "table" then return 0 end
        local removed = 0
        for u,_ in pairs(setTbl) do
            local core, br = __normUUID(u)
            if not ((core and exists[core]) or (br and exists[br])) then
                setTbl[u] = nil
                removed += 1
            end
        end
        return removed
    end

    local totalRemoved = 0
    totalRemoved += pruneSet(selected.boost)
    totalRemoved += pruneSet(selected.noos)
    totalRemoved += pruneSet(selected.seratusage)
    totalRemoved += pruneSet(selected.xp)
    totalRemoved += pruneSet(selected.gbxp)

    if totalRemoved > 0 then
        -- kasih sinyal ke tabs_autokg.lua supaya refresh list+summary walau tab gak dibuka
        _G.__AUTOKG_DIRTY = true

        -- simpan biar file bersih
        pcall(saveSelectionsToFile)
        return true
    end

    return false
end



--------------------------------------------------
-- 3) EXPORT MODULE
--------------------------------------------------
local State = {}

function State.save()
    saveSelectionsToFile()
end

function State.load()
    loadSelectionsFromFile()
end

task.spawn(function()
    while true do
        pcall(pruneSelectedFromStore)
        task.wait(5)
    end
end)




function autoSave()
    State.save()
end






--------------------------------------------------
-- UNIVERSAL HTTP REQUEST
--------------------------------------------------
local function httpRequest(url)
    local req =
        (syn and syn.request) or
        (http and http.request) or
        http_request or
        (fluxus and fluxus.request) or
        request

    if req then
        local res = req({
            Url = url,
            Method = "GET",
        })
        if not res then
            error("no response")
        end
        return res.Body or res.body or ""
    else
        -- fallback Roblox default
        return game:HttpGet(url)
    end
end

--------------------------------------------------
-- LOAD MODULES (PARALEL)
--------------------------------------------------



--------------------------------------------------
-- LOAD STATE MODULE (boleh tetap sync)
--------------------------------------------------

-- fallback STATE kalau state.lua tidak mengembalikan table
if not STATE then
    STATE = {
        autoKgOn        = false,
        onlyGBXP        = false,
        skipFavorited   = true,
        skipMutated     = false,
        onlyAboveTarget = false,
        autoHatchOn     = false,
        autoBuySeeds    = false,
    }
end

--------------------------------------------------
-- AMBIL MODULE YANG DIBUTUHKAN
--------------------------------------------------
local MainUI      = Loaded.MainUI
local AutoTabsMod = Loaded.AutoKgTabs
local MiscTabsMod = Loaded.MiscTabs
local PetListView = Loaded.PetListView
local BoostMod    = Loaded.Boost
local AutoBuyMod  = Loaded.autobuy




if not MainUI then
    warn("[NodeHub] MainUI tidak tersedia, abort.")
    return
end

--------------------------------------------------
-- BUAT UI UTAMA
--------------------------------------------------
--------------------------------------------------
-- BUAT UI UTAMA
--------------------------------------------------
local ui = MainUI.new({
    title = "| NODE HUB",
})

-- ✅ anti UI dobel (kalau main.lua kepanggil 2x)
do
    local G = (getgenv and getgenv()) or _G
    pcall(function()
        if G.__NODEHUB_UI then
            -- kalau ui kamu punya Destroy()
            if type(G.__NODEHUB_UI.Destroy) == "function" then
                G.__NODEHUB_UI:Destroy()
            end
            -- kalau yang disimpan adalah Instance GUI
            if typeof(G.__NODEHUB_UI) == "Instance" then
                G.__NODEHUB_UI:Destroy()
            end
        end
    end)
    G.__NODEHUB_UI = ui
end

-- optional helper untuk save state
if StateModule and type(StateModule.save) == "function" then
    function ui:SaveState()
        StateModule.save()
    end
end


--------------------------------------------------
-- REGISTER TAB
--------------------------------------------------
if AutoTabsMod and AutoTabsMod.Register then
    AutoTabsMod.Register(ui, STATE, PetListView)
else
    warn("[NodeHub] AutoKgTabs.Register tidak ditemukan")
end

if MiscTabsMod and MiscTabsMod.Register then
    MiscTabsMod.Register(ui, STATE, PetListView)
else
    warn("[NodeHub] MiscTabsMod.Register tidak ditemukan")
end


-- sync kondisi awal autoBoost dari STATE
if BoostMod and BoostMod.syncFromState then
    BoostMod.syncFromState(STATE)
end

do
    local G = (getgenv and getgenv()) or _G
    if PetListView and type(PetListView) == "table" then
        G.PetListView = PetListView
    end
end

do
    local env = (getgenv and getgenv()) or _G

    if AutoBuyMod and type(AutoBuyMod) == "table" then
        -- SET KE DUA ENV SEKALIGUS
        env.AutoBuyModule = AutoBuyMod
        _G.AutoBuyModule  = AutoBuyMod

      --  print("[NodeHub] AutoBuyModule set (getgenv):", env.AutoBuyModule)
     --   print("[NodeHub] AutoBuyModule set (_G):", _G.AutoBuyModule)
    else
     --   warn("[NodeHub] AutoBuy module tidak ke-load. Loaded.autobuy =", AutoBuyMod)
    end
end

-- =========================
-- AUTO START AUTO BUY (SIMPLE)
-- =========================
pcall(function()
    local AB = (getgenv and getgenv() or _G).AutoBuyModule
    if AB and type(AB.SyncFromGlobals) == "function" then
        AB.SyncFromGlobals()
    end

    if AB and type(AB.Start) == "function" then
        if (AUTO_BUY_SEED_ENABLED == true) or (AUTO_BUY_EGG_ENABLED == true) or (AUTO_BUY_GEAR_ENABLED == true) then
            AB.Start()
        end
    end
end)

-- AUTO START KG (SIMPLE)
task.defer(function()
    if _G.__AUTOKG_AUTOSTART_DONE then return end
    _G.__AUTOKG_AUTOSTART_DONE = true

    if AUTO_START_KG_ON_REJOIN ~= true then return end
    local loop = rawget(_G, "AutoKGLoop")
    if not loop or type(loop.Start) ~= "function" then return end
    if type(loop.IsRunning) == "function" then
        local ok, v = pcall(loop.IsRunning)
        if ok and v == true then return end
    elseif loop.running == true then
        return
    end

    pcall(function() loop.Start(tostring(_G.GBXP_STAGE_MODE)) end)
end)


--------------------------------------------------
-- TAB AWAL
--------------------------------------------------
ui:SetActiveMainTab("autokg")

if LOADER then
    LOADER.SetProgress(1, "Ready.")
    task.wait(0.15)
    LOADER.Destroy()
end
