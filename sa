--ds
local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/JordiTBA/dasdwada/refs/heads/main/dwa"))()
local Window =
    Library:CreateWindow(
    {
        Title = "Jordi Hub",
        SubTitle = "Grow A Garden",
        TabWidth = 160
    }
)

task.spawn(
    function()
        Library:Notify(
            {
                Title = "Jordi Hub",
                Content = "Loaded Successfully!",
                Duration = 5
            }
        )
        if getgenv().AntiAfkRunning then
            return
        end
        getgenv().AntiAfkRunning = true

        while getgenv().AntiAfkRunning do
            local VirtualUser = game:GetService("VirtualUser")
            local Players = game:GetService("Players")

            Players.LocalPlayer.Idled:Connect(
                function()
                    VirtualUser:CaptureController()
                    VirtualUser:ClickButton2(Vector2.new())
                end
            )
            task.wait(600)
        end
    end
)
local Tab = Window:CreateTab("Main", 4483362458)
local MainSection = Tab:CreateSection("Main")

-- // Services & Variables // --
local Workspace = game:GetService("Workspace")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local CurrentCamera = Workspace.CurrentCamera

-- // SAFE MODULE LOADING // --
local PetUtilities, PetList_Data, PetsService
local ModulesLoaded, LoadError =
    pcall(
    function()
        local Modules = ReplicatedStorage:WaitForChild("Modules", 5)
        if not Modules then
            error("Modules folder not found")
        end

        local PetServices = Modules:WaitForChild("PetServices", 2)
        if PetServices then
            local UtilMod = PetServices:WaitForChild("PetUtilities", 2)
            if UtilMod then
                PetUtilities = require(UtilMod)
            end

            local SvcMod = PetServices:WaitForChild("PetsService", 2)
            if SvcMod then
                PetsService = require(SvcMod)
            end
        end

        local DataFolder = ReplicatedStorage:WaitForChild("Data", 2)
        if DataFolder then
            local Registry = DataFolder:WaitForChild("PetRegistry", 2)
            if Registry then
                PetList_Data = require(Registry).PetList
            end
        end
    end
)

if not ModulesLoaded or not PetUtilities then
    Library:Notify(
        {
            Title = "Warning",
            Content = "Some Game Modules failed to load. Features might be broken.",
            Duration = 6.5
        }
    )
    warn("Module Load Error:", LoadError)
end

getgenv().selectedPets = getgenv().selectedPets or {}
getgenv().weight_to_remove = getgenv().weight_to_remove or 0
getgenv().Level_target = getgenv().Level_target or 0
getgenv().selectedToySize = getgenv().selectedToySize or {}
getgenv().selectedToyPets = getgenv().selectedToyPets or {}
getgenv().blacklistPets = getgenv().blacklistPets or {}
getgenv().setupPets = getgenv().setupPets or {}
getgenv().BackupPets = getgenv().BackupPets or {}
getgenv().largeToyStart = getgenv().largeToyStart or 0
getgenv().largeToyStop = getgenv().largeToyStop or 100
local PetDropdown
local SetupPetDropdown
local BackupDropdown
local ToyPetsDropdown
-- // Helper Functions // --
getgenv().webhookUrl = "" -- The URL you provided
local http_request = http_request or request or HttpPost or syn.request
local HttpService = game:GetService("HttpService")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local function sendToWebhook(levelInput, weightInput)
    local data = {
        ["embeds"] = {
            {
                ["title"] = "jordi Hub",
                ["description"] = "Player Statistics Update",
                ["color"] = 41727, -- Blue color
                ["fields"] = {
                    {
                        ["name"] = "Player",
                        ["value"] = LocalPlayer.Name,
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Level",
                        ["value"] = tostring(levelInput),
                        ["inline"] = true
                    },
                    {
                        ["name"] = "Base Weight",
                        ["value"] = tostring(weightInput),
                        ["inline"] = true
                    }
                },
                ["footer"] = {
                    ["text"] = "jordi Hub"
                }
            }
        }
    }

    local headers = {
        ["Content-Type"] = "application/json"
    }

    local webhookUrl = getgenv().webhookUrl
    if not webhookUrl then
        print("webhookUrl is not set.")
        return
    end

    local success, response =
        pcall(
        function()
            return http_request(
                {
                    Url = webhookUrl,
                    Method = "POST",
                    Headers = headers,
                    Body = HttpService:JSONEncode(data)
                }
            )
        end
    )

    if success then
        print("Embed sent to Discord webhook!")
    end
end
local function ScreenRaycast()
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Exclude
    params.FilterDescendantsInstances = {LocalPlayer.Character}

    local mouseLoc = UserInputService:GetMouseLocation()
    local ray = CurrentCamera:ViewportPointToRay(mouseLoc.X, mouseLoc.Y)

    return Workspace:Raycast(ray.Origin, ray.Direction * 1000, params)
end

local function place_pet(UUID)
    if not PetsService then
        return
    end

    local rayResult = ScreenRaycast()
    if not rayResult then
        return
    end

    local pos = rayResult.Position
    local cframe = CFrame.new(pos.X, pos.Y, pos.Z)

    pcall(
        function()
            PetsService:EquipPet(UUID, cframe)
        end
    )
end
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local function EquipTool(name)
    local character = LocalPlayer.Character
    if not character then
        return nil
    end
    local humanoid = character:FindFirstChild("Humanoid")
    if not humanoid then
        return nil
    end
    local currentTool = character:FindFirstChildWhichIsA("Tool")
    if currentTool and string.find(currentTool.Name, name) then
        return currentTool
    end
    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        for _, tool in pairs(backpack:GetChildren()) do
            if tool:IsA("Tool") and string.find(tool.Name, name) then
                humanoid:EquipTool(tool)
                task.wait(0.1)
                return tool
            end
        end
    end
    return nil
end
local Toy = {
    ["small"] = "Small Pet Toy",
    ["medium"] = "Medium Pet Toy",
    ["large"] = "Large Pet Toy"
}
-- EquipTool(Toy["medium"])

local function use_toy(UUID)
    local PetBoostService_upvr = ReplicatedStorage:WaitForChild("GameEvents").PetBoostService
    PetBoostService_upvr:FireServer("ApplyBoost", UUID)
end
local function calculate_weight(petData, level_check)
    local pType = petData.PetType
    local pData = petData.PetData

    if not pType or not pData then
        return "0.00"
    end

    local baseWeight = pData.BaseWeight or 1
    local level = level_check or pData.Level

    if PetUtilities then
        return string.format("%.2f", PetUtilities:CalculateWeight(baseWeight, math.min(level, 100)))
    else
        return "0.00"
    end
end

-- Removed function check_blacklist(UUID)

-- // Core Logic: Refresh Data // --
local function refreshPetData()
    local displayList = {}
    getgenv().InventoryMap = getgenv().InventoryMap or {}

    local function addPetToList(petData, isEquipped)
        local uuid = "NoUUID"
        local full = "Unnamed"
        local level = 1
        local status = ""
        local like = "Unknown"
        local weight = 0.00
        if typeof(petData) == "Instance" then
            uuid = petData:GetAttribute("PET_UUID") or petData:GetAttribute("UUID") or "NoUUID"
            full = petData.Name
            weight = full:match("%[([%d%.]+)%s*KG%]") or 0.00
            local lvlAttr = petData:GetAttribute("Level")
            local lvlMatch = full:match("Level%s*(%d+)") or full:match("Lvl%s*(%d+)") or full:match("Age%s*(%d+)")
            level = lvlAttr or (lvlMatch and tonumber(lvlMatch)) or "Unknown"
            like = petData:GetAttribute("d") and "Fav" or "Unfav"
            status = "[Backpack]"
        elseif type(petData) == "table" then
            uuid = petData.UUID or "NoUUID"
            full = petData.Name or (petData.PetData and petData.PetType) or "Unnamed"
            level = petData.PetData and petData.PetData.Level or 1
            weight = calculate_weight(petData) or 0
            status = "[Equipped]"
        end

        local name = full:match("^(.-)%s*%[") or full
        local short_uuid = uuid:sub(1, 5)
        local displayString = ""
        displayString = string.format("%s[%s] Level %s %s %.2f KG [%s]", status, like, level, name, weight, short_uuid)
        getgenv().InventoryMap[displayString] = uuid
        table.insert(displayList, displayString)
    end

    if PetUtilities then
        local success, myActivePets =
            pcall(
            function()
                return PetUtilities:GetPetsSortedByAge(LocalPlayer, 0, false, true)
            end
        )
        if success and myActivePets then
            for _, pet in pairs(myActivePets) do
                addPetToList(pet, true)
            end
        end
    end

    local backpack = LocalPlayer:FindFirstChild("Backpack")
    if backpack then
        for _, pet in pairs(backpack:GetChildren()) do
            if pet:GetAttribute("PetType") then
                addPetToList(pet, false)
            end
        end
    end

    return displayList
end

local function GetUpdatedSelection(currentSelection)
    local newSelection = {}
    -- 1. Capture UUIDs of currently selected pets
    local selectedUUIDs = {}
    if type(currentSelection) == "table" then
        for _, displayStr in ipairs(currentSelection) do
            local uuid = getgenv().InventoryMap[displayStr]
            if uuid then
                selectedUUIDs[uuid] = true
            end
        end
    end

    -- 2. Refresh Data (this updates InventoryMap with new strings)
    local allNewItems = refreshPetData()

    -- 3. Find new strings that match the UUIDs
    for _, displayStr in ipairs(allNewItems) do
        local uuid = getgenv().InventoryMap[displayStr]
        if uuid and selectedUUIDs[uuid] then
            table.insert(newSelection, displayStr)
        end
    end

    return allNewItems, newSelection
end

local function check_pet_active(uuid)
    if PetUtilities then
        local success, myActivePets =
            pcall(
            function()
                return PetUtilities:GetPetsSortedByAge(LocalPlayer, 0, false, true)
            end
        )
        if success and myActivePets then
            for _, pet in pairs(myActivePets) do
                if pet.UUID == uuid then
                    return true
                end
            end
        end
    end
    return false
end

local function change_loadout(Slot)
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local PetsService = ReplicatedStorage:WaitForChild("GameEvents"):WaitForChild("PetsService")

    PetsService:FireServer("SwapPetLoadout", Slot)
    print("Request sent to swap to Loadout " .. Slot)
end

-- // Core Logic: Auto Leveling (Batch) // --
local function check_loadout()
    local ReplicatedStorage = game:GetService("ReplicatedStorage")
    local DataService = require(ReplicatedStorage.Modules.DataService)

    local PlayerData = DataService:GetData()

    if PlayerData and PlayerData.PetsData then
        local currentLoadout = PlayerData.PetsData.SelectedPetLoadout or 1
        print("You are currently on Loadout: " .. currentLoadout)
        return tonumber(currentLoadout)
    end
    return 1
end

local function get_max_slots()
    local success, result =
        pcall(
        function()
            local DataService = require(game:GetService("ReplicatedStorage").Modules.DataService)
            local data = DataService:GetData()
            return data.PetsData.MutableStats.MaxEquippedPets or 0
        end
    )

    if success and result then
        return result
    end
    return 0
end

local function get_total_equipped_pets()
    local success, result =
        pcall(
        function()
            local DataService = require(game:GetService("ReplicatedStorage").Modules.DataService)
            local data = DataService:GetData()
            return #data.PetsData.EquippedPets or 0
        end
    )

    if success and result then
        return result
    end
    return 0
end
local function Unequip_all_pet()
    local success, myActivePets =
        pcall(
        function()
            return PetUtilities:GetPetsSortedByAge(LocalPlayer, 0, false, true)
        end
    )
    local make_sure = true
    while make_sure do
        make_sure = false
        for index, value in ipairs(myActivePets) do
            for _, pet in pairs(getgenv().selectedPets) do
                local uuid = getgenv().InventoryMap[pet]
                if PetsService and value.UUID == uuid and check_pet_active(uuid) then
                    PetsService:UnequipPet(uuid)
                    task.wait(0.5)
                    make_sure = true
                end
            end
        end
        task.wait(1)
    end
end
local function equip_selected_pets()
    for _, pet in pairs(getgenv().selectedPets) do
        local uuid = getgenv().InventoryMap[pet]
        if PetsService and uuid and not check_pet_active(uuid) then
            PetsService:EquipPet(uuid)
            task.wait(0.5)
        end
    end
end
local function equip_setup_pets()
    for _, pet in pairs(getgenv().setupPets) do
        local uuid = getgenv().InventoryMap[pet]
        if PetsService and uuid and not check_pet_active(uuid) then
            PetsService:EquipPet(uuid)
            task.wait(0.5)
        end
    end
end
local function trigger()
    local Loadout = 1
    while check_loadout() == Loadout do
        change_loadout(Loadout + 1)
        task.wait(2)
    end
    while check_loadout() ~= Loadout do
        change_loadout(Loadout)
        task.wait(2)
    end
end
local function acc_remove(table_remove)

    for index, pet in pairs(table_remove) do
        local uuid = getgenv().InventoryMap[pet.name]
        sendToWebhook(1, pet.weightStr)
        Library:Notify(
            {
                Title = "Auto Level",
                Content = "Unequip pet " .. pet.name .. " with weight " .. pet.weightStr .. " KG",
                Duration = 3
            }
        )
        
        while check_pet_active(uuid) do
            PetsService:UnequipPet(uuid)
            wait(1.2)
        end
        table.remove(getgenv().selectedPets, index)
        local new_pet = getgenv().BackupPets and getgenv().BackupPets[1]
                                local success, myActivePets =
                        pcall(
                        function()
                            return PetUtilities:GetPetsSortedByAge(LocalPlayer, 0, false, true)
                        end
                    )
        if new_pet then
            local new_uuid = getgenv().InventoryMap[new_pet]
            if new_uuid then
                Library:Notify(
                    {
                        Title = "Auto Level",
                        Content = "Equip backup pet " .. new_pet,
                        Duration = 3
                    }
                )
                while not check_pet_active(new_uuid) and check_loadout() == 1 and #myActivePets < get_max_slots() do
                    place_pet(new_uuid)
                    wait(1)
                end
                table.remove(getgenv().BackupPets, 1)
                table.insert(getgenv().selectedPets, new_pet)
                local newList, newSelection = GetUpdatedSelection(getgenv().selectedPets)
                getgenv().selectedPets = newSelection
                PetDropdown:Refresh(newList, newSelection)
                local newList, newSelection = GetUpdatedSelection(getgenv().BackupPets)
                getgenv().BackupPets = newSelection

                local unselected = {}
                local selected_lookup = {}
                for _, v in pairs(getgenv().selectedPets) do
                    selected_lookup[v] = true
                end

                for _, pet_string in pairs(newList) do
                    if not selected_lookup[pet_string] then
                        table.insert(unselected, pet_string)
                    end
                end

                local validBackupSelection = {}
                for _, v in pairs(newSelection) do
                    if not selected_lookup[v] then
                        table.insert(validBackupSelection, v)
                    end
                end
                getgenv().BackupPets = validBackupSelection

                if #unselected == 0 then
                    unselected = {"No available backup pets"}
                end
                BackupDropdown:Refresh(unselected, validBackupSelection)
            end
        end
    end
    trigger()
end
getgenv().table_remove = {}
local function start_leveling()
    task.spawn(
        function()
            while check_loadout() ~= 1 do
                change_loadout(1)
                task.wait(2)
            end
            if #getgenv().table_remove > 0 then
                acc_remove(getgenv().table_remove)
                getgenv().table_remove = {}
                return
            end

            local pcallSuccess, pcallError =
                pcall(
                function()
                    equip_selected_pets()
                    -- equip_setup_pets()
                    local success, myActivePets =
                        pcall(
                        function()
                            return PetUtilities:GetPetsSortedByAge(LocalPlayer, 0, false, true)
                        end
                    )
                    if not success or not myActivePets then
                        return
                    end
                    for key, pet_active in pairs(myActivePets) do
                        for index, name in pairs(getgenv().selectedPets) do
                            local uuid = getgenv().InventoryMap[name]
                            if pet_active.UUID == uuid then
                                local weightStr = calculate_weight(pet_active, 1)
                                local weight = tonumber(weightStr) or 0
                                if weight >= getgenv().weight_to_remove then
                                    table.insert(getgenv().table_remove, {name = name, weightStr = weightStr})
                                end
                            end
                        end
                    end
                end
            )

            if not pcallSuccess then
                warn("Auto Level Error: " .. tostring(pcallError))
            end
        end
    )
end

-- // GUI Elements // --

-- Removed Local BlacklistDropdown

local function CreateDropdowns()
    local list = {}
    local s, e =
        pcall(
        function()
            list = refreshPetData()
        end
    )
    if not s then
        warn("Data Refresh Error: " .. tostring(e))
        list = {"Error loading pets (Check Console)"}
    end

    PetDropdown =
        MainSection:CreateDropdown(
        {
            Name = "Inventory (Select pets to Equip)",
            Items = list,
            CurrentValue = {},
            Multi = true,
            Search = true,
            Flag = "PetDropdown",
            Callback = function(Option)
                getgenv().selectedPets = Option
            end
        }
    )

    SetupPetDropdown =
        MainSection:CreateDropdown(
        {
            Name = "Setup Pet",
            Items = list,
            CurrentValue = {},
            Multi = true,
            Search = true,
            Flag = "SetupPetDropdown",
            Callback = function(Option)
                getgenv().setupPets = Option
            end
        }
    )

    -- Removed Blacklist Section and Dropdown Logic
end

CreateDropdowns()

MainSection:CreateButton(
    {
        Name = "Refresh Lists",
        Callback = function()
            local newList, newSelection = GetUpdatedSelection(getgenv().selectedPets)
            getgenv().selectedPets = newSelection
            PetDropdown:Refresh(newList, newSelection)

            local _, newSetupSelection = GetUpdatedSelection(getgenv().setupPets)
            getgenv().setupPets = newSetupSelection
            SetupPetDropdown:Refresh(newList, newSetupSelection)
        end
    }
)

local ConfigSection = Tab:CreateSection("Configuration")

ConfigSection:CreateInput(
    {
        Name = "Config Name",
        Placeholder = "default",
        Flag = "ConfigName",
        Callback = function(Text)
            getgenv().ConfigName = Text
        end
    }
)

ConfigSection:CreateButton(
    {
        Name = "Save Config",
        Callback = function()
            local name = getgenv().ConfigName or "default"
            Library:SaveConfig(name)
        end
    }
)

ConfigSection:CreateButton(
    {
        Name = "Load Config",
        Callback = function()
            -- Refresh data before loading to ensure map is current
            local newList = refreshPetData()
            if PetDropdown then
                PetDropdown:Refresh(newList, true)
            end

            local name = getgenv().ConfigName or "default"
            Library:LoadConfig(name)
        end
    }
)

local AutomationSection = Tab:CreateSection("Automation Settings")

AutomationSection:CreateInput(
    {
        Name = "Webhook URL",
        Placeholder = "Enter Discord Webhook URL",
        Flag = "WebhookUrl",
        Callback = function(Text)
            getgenv().webhookUrl = Text
        end
    }
)

AutomationSection:CreateInput(
    {
        Name = "Target Weight (KG)",
        Placeholder = "Example: 10",
        Flag = "TargetWeight",
        Callback = function(Text)
            local num = tonumber(Text)
            if num then
                getgenv().weight_to_remove = num
            end
        end
    }
)

AutomationSection:CreateInput(
    {
        Name = "Target Level",
        Placeholder = "Example: 40",
        Flag = "TargetLevel",
        Callback = function(Text)
            local num = tonumber(Text)
            if num then
                getgenv().Level_target = num
            end
        end
    }
)

AutomationSection:CreateToggle(
    {
        Name = "Start Auto Leveling",
        CurrentValue = false,
        Flag = "AutoLevelToggle",
        Callback = function(Value)
            getgenv().Leveling = Value
            if Value then
                Library:Notify(
                    {
                        Title = "Auto Level",
                        Content = "Auto Leveling Started.",
                        Duration = 3
                    }
                )
                task.spawn(
                    function()
                        while getgenv().Leveling do
                            start_leveling()
                            task.wait(1.5)
                        end
                    end
                )
            else
                Library:Notify(
                    {
                        Title = "Auto Level",
                        Content = "Auto Leveling Stopped.",
                        Duration = 3
                    }
                )
                print("Auto Leveling Stopped.")
                getgenv().Mode = "leveling"
            end
        end
    }
)
-- // Backup Pet Tab // --
local BackupTab = Window:CreateTab("Backup Pet", 4483362458)
local BackupSection = BackupTab:CreateSection("Backup")

BackupDropdown =
    BackupSection:CreateDropdown(
    {
        Name = "Backup Inventory (Unselected Pets)",
        Items = {"Click Refresh to Load"},
        CurrentValue = {},
        Multi = true,
        Search = true,
        Flag = "BackupPetDropdown",
        Callback = function(Option)
            getgenv().BackupPets = Option
            print("Backup Pets Selected")
        end
    }
)

BackupSection:CreateButton(
    {
        Name = "Refresh Backup List",
        Callback = function()
            local newList, newSelection = GetUpdatedSelection(getgenv().BackupPets)
            getgenv().BackupPets = newSelection

            local unselected = {}
            local selected_lookup = {}
            for _, v in pairs(getgenv().selectedPets) do
                selected_lookup[v] = true
            end

            for _, pet_string in pairs(newList) do
                if not selected_lookup[pet_string] then
                    table.insert(unselected, pet_string)
                end
            end

            local validBackupSelection = {}
            for _, v in pairs(newSelection) do
                if not selected_lookup[v] then
                    table.insert(validBackupSelection, v)
                end
            end
            getgenv().BackupPets = validBackupSelection

            if #unselected == 0 then
                unselected = {"No available backup pets"}
            end
            BackupDropdown:Refresh(unselected, validBackupSelection)
        end
    }
)

-- // Pet Toy Tab // --
local ToyTab = Window:CreateTab("Pet Toy", 4483362458)
local ToySection = ToyTab:CreateSection("Toy Settings")

ToySection:CreateDropdown(
    {
        Name = "Select Toy Size",
        Items = {"Small Pet Toy", "Medium Pet Toy", "Large Pet Toy"},
        CurrentValue = {},
        Multi = true,
        Flag = "ToySizeDropdown",
        Callback = function(Option)
            getgenv().selectedToySize = Option
            print("Selected Toy Sizes:", #getgenv().selectedToySize)
        end
    }
)

ToyPetsDropdown =
    ToySection:CreateDropdown(
    {
        Name = "Select Active Pets for Toy",
        Items = {"Click Refresh to Load"},
        CurrentValue = {},
        Multi = true,
        Search = true,
        Flag = "ToyPetsDropdown",
        Callback = function(Option)
            getgenv().selectedToyPets = Option
            print("Selected Toy Pets:", #getgenv().selectedToyPets)
        end
    }
)

ToySection:CreateButton(
    {
        Name = "Refresh Active Pets",
        Callback = function()
            local newList, newSelection = GetUpdatedSelection(getgenv().selectedToyPets)
            getgenv().selectedToyPets = newSelection
            ToyPetsDropdown:Refresh(newList, newSelection)
        end
    }
)

ToySection:CreateInput(
    {
        Name = "Large Toy Start Weight",
        Placeholder = "0",
        Flag = "LargeToyStart",
        Callback = function(Text)
            getgenv().largeToyStart = tonumber(Text) or 0
        end
    }
)

ToySection:CreateInput(
    {
        Name = "Large Toy Stop Weight",
        Placeholder = "100",
        Flag = "LargeToyStop",
        Callback = function(Text)
            getgenv().largeToyStop = tonumber(Text) or 100
        end
    }
)

ToySection:CreateToggle(
    {
        Name = "Use Toy",
        CurrentValue = false,
        Flag = "UseToyToggle",
        Callback = function(Value)
            getgenv().use_toy = Value

            -- 1. Check if pets are selected
            if Value and #getgenv().selectedToyPets == 0 then
                Library:Notify(
                    {
                        Title = "Pet Toy",
                        Content = "No pets selected!",
                        Duration = 3
                    }
                )
                getgenv().use_toy = false
                return
            end

            if not Value then
                Library:Notify(
                    {
                        Title = "Pet Toy",
                        Content = "Toy usage stopped.",
                        Duration = 3
                    }
                )
                return
            end

            local toyNamesString = ""
            if type(getgenv().selectedToySize) == "table" then
                toyNamesString = table.concat(getgenv().selectedToySize, ", ")
            else
                toyNamesString = tostring(getgenv().selectedToySize)
            end

            Library:Notify(
                {
                    Title = "Pet Toy",
                    Content = string.format("Using [%s] on %d pets", toyNamesString, #getgenv().selectedToyPets),
                    Duration = 3
                }
            )

            if getgenv().use_toy then
                task.spawn(
                    function()
                        while getgenv().use_toy do
                            local success, myActivePets =
                                pcall(
                                function()
                                    return PetUtilities:GetPetsSortedByAge(LocalPlayer, 0, false, true)
                                end
                            )

                            local boost_amounts = {
                                ["Small Pet Toy"] = 0.1,
                                ["Medium Pet Toy"] = 0.2,
                                ["Large Pet Toy"] = 0.3
                            }
                            if success and myActivePets then
                                -- Check Large Toy Condition from selectedPets
                                local largeToyConditionMet = false
                                local startW = getgenv().largeToyStart or 0
                                local stopW = getgenv().largeToyStop or 100

                                if getgenv().selectedPets then
                                    for _, petName in pairs(getgenv().selectedPets) do
                                        local uuid = getgenv().InventoryMap and getgenv().InventoryMap[petName]
                                        if uuid then
                                            for _, activePet in pairs(myActivePets) do
                                                if activePet.UUID == uuid then
                                                    local w = tonumber(calculate_weight(activePet, 1)) or 0
                                                    if w >= startW and w < stopW then
                                                        largeToyConditionMet = true
                                                        break
                                                    end
                                                end
                                            end
                                        end
                                        if largeToyConditionMet then
                                            break
                                        end
                                    end
                                end

                                for _, pet_id in ipairs(getgenv().selectedToyPets) do
                                    local uuid = getgenv().InventoryMap and getgenv().InventoryMap[pet_id]
                                    if uuid and check_pet_active(uuid) then
                                        local currentPetData = nil
                                        for _, pet in pairs(myActivePets) do
                                            if pet.UUID == uuid then
                                                currentPetData = pet
                                                break
                                            end
                                        end
                                        if currentPetData then
                                            local active_boosts = {}
                                            if currentPetData.PetData and currentPetData.PetData.Boosts then
                                                for _, boost in pairs(currentPetData.PetData.Boosts) do
                                                    active_boosts[boost.BoostAmount] = true
                                                end
                                            end
                                            for _, toyName in pairs(getgenv().selectedToySize) do
                                                local requiredAmount = boost_amounts[toyName]

                                                local canUse = true
                                                if toyName == "Large Pet Toy" then
                                                    if not largeToyConditionMet then
                                                        canUse = false
                                                    end
                                                end

                                                if canUse and requiredAmount and not active_boosts[requiredAmount] then
                                                    print("Menggunakan " .. toyName .. " untuk Pet ID: " .. pet_id)
                                                    local equip = EquipTool(toyName)
                                                    if equip then
                                                        Library:Notify(
                                                            {
                                                                Title = "Pet Toy",
                                                                Content = "Using " .. toyName .. " on pet " .. pet_id,
                                                                Duration = 2
                                                            }
                                                        )
                                                        use_toy(uuid)
                                                        task.wait(0.5)
                                                    else
                                                        print("Failed to equip toy:", toyName)
                                                    end
                                                end
                                            end
                                        end
                                    end
                                end
                                task.wait(1)
                            end
                        end
                    end
                )
            end
        end
    }
)
